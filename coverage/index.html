<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Source</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.8.0/application.js' type='text/javascript'></script>    
    <link href='./assets/0.8.0/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.8.0/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.8.0/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.8.0/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2016-07-30T12:31:13+02:00">2016-07-30T12:31:13+02:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="red">45.95%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         6.11
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>83</b> files in total.
    <b>3175</b> relevant lines. 
    <span class="green"><b>1459</b> lines covered</span> and
    <span class="red"><b>1716</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#e1eda1465ed77ef6c5477fe6b36e6c84e9d479e2" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="red strong">67.74 %</td>
        <td>104</td>
        <td>62</td>
        <td>42</td>
        <td>20</td>
        <td>24.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c4c0e5fb3f29d1c7b4b5a2eee43b2251f45ba029" class="src_link" title="app/controllers/budgets_controller.rb">app/controllers/budgets_controller.rb</a></td>
        <td class="green strong">93.75 %</td>
        <td>79</td>
        <td>48</td>
        <td>45</td>
        <td>3</td>
        <td>2.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#423a99c0bdac0677defcd7beb8dfa0fa8e24f54a" class="src_link" title="app/controllers/categories_controller.rb">app/controllers/categories_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#086c6c05ca2163ee881e2f098ef952795a0e7217" class="src_link" title="app/controllers/corporate_connections_controller.rb">app/controllers/corporate_connections_controller.rb</a></td>
        <td class="red strong">47.73 %</td>
        <td>68</td>
        <td>44</td>
        <td>21</td>
        <td>23</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ea5a25437f902c7c0da804c3633170cc03e69adc" class="src_link" title="app/controllers/departments_controller.rb">app/controllers/departments_controller.rb</a></td>
        <td class="green strong">94.12 %</td>
        <td>58</td>
        <td>34</td>
        <td>32</td>
        <td>2</td>
        <td>1.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6ecc718eaf84b55ac4e2f9dce75cde908b24c284" class="src_link" title="app/controllers/fax_controller.rb">app/controllers/fax_controller.rb</a></td>
        <td class="red strong">46.88 %</td>
        <td>49</td>
        <td>32</td>
        <td>15</td>
        <td>17</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8e4cf7a330c6d20b540cb7cb00ac00243d0c8e66" class="src_link" title="app/controllers/items_controller.rb">app/controllers/items_controller.rb</a></td>
        <td class="red strong">64.94 %</td>
        <td>131</td>
        <td>77</td>
        <td>50</td>
        <td>27</td>
        <td>2.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#327d2ee069e6dac9d06c282811c82fd1f2fac3cf" class="src_link" title="app/controllers/join_invitations_controller.rb">app/controllers/join_invitations_controller.rb</a></td>
        <td class="red strong">22.22 %</td>
        <td>37</td>
        <td>18</td>
        <td>4</td>
        <td>14</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8a8b7bf3169b20888b636b7881459a698f1ea897" class="src_link" title="app/controllers/lists_controller.rb">app/controllers/lists_controller.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>8</td>
        <td>5</td>
        <td>4</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3d1e981dc40e16c01c4845f2510a562c127a4339" class="src_link" title="app/controllers/locations_controller.rb">app/controllers/locations_controller.rb</a></td>
        <td class="yellow strong">83.33 %</td>
        <td>11</td>
        <td>6</td>
        <td>5</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d41e80bc6a0d609411a9a02cf03944258b40cfc0" class="src_link" title="app/controllers/messages_controller.rb">app/controllers/messages_controller.rb</a></td>
        <td class="red strong">31.25 %</td>
        <td>29</td>
        <td>16</td>
        <td>5</td>
        <td>11</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d6454a6505e4807ea950b1eb8fa6e5b716236cfd" class="src_link" title="app/controllers/pages_controller.rb">app/controllers/pages_controller.rb</a></td>
        <td class="red strong">26.19 %</td>
        <td>66</td>
        <td>42</td>
        <td>11</td>
        <td>31</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c55421a31395a6ae720d968ead20cea1630f40e2" class="src_link" title="app/controllers/properties_controller.rb">app/controllers/properties_controller.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>35</td>
        <td>21</td>
        <td>7</td>
        <td>14</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6f4b65f47733e2bb182266e2ce882e0504d10fb0" class="src_link" title="app/controllers/property_settings_controller.rb">app/controllers/property_settings_controller.rb</a></td>
        <td class="red strong">37.5 %</td>
        <td>11</td>
        <td>8</td>
        <td>3</td>
        <td>5</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#db88345277a1aeda5b9b9d0535bb1a8f58a4f05a" class="src_link" title="app/controllers/purchase_orders_controller.rb">app/controllers/purchase_orders_controller.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>69</td>
        <td>42</td>
        <td>14</td>
        <td>28</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f068744f3605d454550a109d5476dfa53c3e4469" class="src_link" title="app/controllers/purchase_receipts_controller.rb">app/controllers/purchase_receipts_controller.rb</a></td>
        <td class="red strong">31.43 %</td>
        <td>57</td>
        <td>35</td>
        <td>11</td>
        <td>24</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e27042dc3f77a1cd93c42b7b7b7fd218ead80da8" class="src_link" title="app/controllers/purchase_requests_controller.rb">app/controllers/purchase_requests_controller.rb</a></td>
        <td class="red strong">17.98 %</td>
        <td>147</td>
        <td>89</td>
        <td>16</td>
        <td>73</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#29f68bc17fbfb3bcbbaeac00e5d460e240894611" class="src_link" title="app/controllers/reports_controller.rb">app/controllers/reports_controller.rb</a></td>
        <td class="red strong">7.69 %</td>
        <td>911</td>
        <td>455</td>
        <td>35</td>
        <td>420</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#beec737391bf54fe66309fbd911b8364a96f662c" class="src_link" title="app/controllers/tags_controller.rb">app/controllers/tags_controller.rb</a></td>
        <td class="red strong">58.7 %</td>
        <td>76</td>
        <td>46</td>
        <td>27</td>
        <td>19</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9db5e11457fec04ccaad53e85b2d0849e4590de3" class="src_link" title="app/controllers/users_controller.rb">app/controllers/users_controller.rb</a></td>
        <td class="red strong">15.38 %</td>
        <td>192</td>
        <td>117</td>
        <td>18</td>
        <td>99</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#757cc5d2df06db430841358537c938cf2239c194" class="src_link" title="app/controllers/vendors_controller.rb">app/controllers/vendors_controller.rb</a></td>
        <td class="red strong">45.71 %</td>
        <td>62</td>
        <td>35</td>
        <td>16</td>
        <td>19</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#312ce01c3e846734ee018d9ae042950c1594854f" class="src_link" title="app/decorators/item_order_decorator.rb">app/decorators/item_order_decorator.rb</a></td>
        <td class="red strong">40.0 %</td>
        <td>58</td>
        <td>30</td>
        <td>12</td>
        <td>18</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#13d111d145be886def86434b53c3a797358e69f6" class="src_link" title="app/helpers/activity_helper.rb">app/helpers/activity_helper.rb</a></td>
        <td class="red strong">25.0 %</td>
        <td>25</td>
        <td>12</td>
        <td>3</td>
        <td>9</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7b116802412a9cdecd059034225fe9e14fa9b76f" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
        <td class="red strong">38.55 %</td>
        <td>165</td>
        <td>83</td>
        <td>32</td>
        <td>51</td>
        <td>2.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b0c1a57d3a19c1274245f9d1417d882b08e4b1c7" class="src_link" title="app/helpers/budgets_helper.rb">app/helpers/budgets_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>11</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>7.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a741f2f9ad97005aebeb197bdfc29e9235cd5767" class="src_link" title="app/helpers/maintenance_helper.rb">app/helpers/maintenance_helper.rb</a></td>
        <td class="red strong">29.79 %</td>
        <td>99</td>
        <td>47</td>
        <td>14</td>
        <td>33</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#62c22822fd0fc8a83ac502fca8fdbd12ccc06d4a" class="src_link" title="app/helpers/permissions_helper.rb">app/helpers/permissions_helper.rb</a></td>
        <td class="red strong">41.18 %</td>
        <td>32</td>
        <td>17</td>
        <td>7</td>
        <td>10</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#561132ed1ea9793eab681bc9fff1dc6c3bdd39a4" class="src_link" title="app/helpers/pusher_helper.rb">app/helpers/pusher_helper.rb</a></td>
        <td class="red strong">70.0 %</td>
        <td>37</td>
        <td>20</td>
        <td>14</td>
        <td>6</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#162e13573b11f3a868c04d7d3af910b4dbb52291" class="src_link" title="app/helpers/report_helper.rb">app/helpers/report_helper.rb</a></td>
        <td class="red strong">13.89 %</td>
        <td>59</td>
        <td>36</td>
        <td>5</td>
        <td>31</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dbcb2c8b1c2ae0629066966d4cd362b921290232" class="src_link" title="app/models/ability.rb">app/models/ability.rb</a></td>
        <td class="red strong">74.59 %</td>
        <td>184</td>
        <td>122</td>
        <td>91</td>
        <td>31</td>
        <td>13.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b20be24f8b518a80a6e5418eaf79370dbff43b56" class="src_link" title="app/models/admin.rb">app/models/admin.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6d3b22ebae3faae08bda355a86afadeaff1f6845" class="src_link" title="app/models/brand.rb">app/models/brand.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>12</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e86539f79755b507e59ad2e8356e61f40ee13ac" class="src_link" title="app/models/budget.rb">app/models/budget.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>11</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>59.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3f8699d7da975e3068ff37c6aeb23f61e3ec465b" class="src_link" title="app/models/category.rb">app/models/category.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>23</td>
        <td>5</td>
        <td>4</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7fbc9476ecb4f51280e7b9b817719c61995a0649" class="src_link" title="app/models/concerns/stamp_user.rb">app/models/concerns/stamp_user.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>25</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>34.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8371af4b9e9b6cb7455c4c49a0d0c2dd2e45a892" class="src_link" title="app/models/corporate.rb">app/models/corporate.rb</a></td>
        <td class="red strong">40.0 %</td>
        <td>23</td>
        <td>15</td>
        <td>6</td>
        <td>9</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3e77c25b15f687a556203d894b55a2b85e690775" class="src_link" title="app/models/corporate/connection.rb">app/models/corporate/connection.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>35</td>
        <td>20</td>
        <td>15</td>
        <td>5</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a6664d5ab569e1f82e4d37a6ef548c4c12b000d1" class="src_link" title="app/models/department.rb">app/models/department.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>17</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>50.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3ec62e4dc23b27c9a77c32b638c534d4500bc63e" class="src_link" title="app/models/departments_tag.rb">app/models/departments_tag.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4e3ac73489fcdcabc92a15261a4c4150d6c1cb0b" class="src_link" title="app/models/departments_user.rb">app/models/departments_user.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b05cb236d823b6f124ac73c1eddbbf73337c2a19" class="src_link" title="app/models/item.rb">app/models/item.rb</a></td>
        <td class="red strong">63.92 %</td>
        <td>206</td>
        <td>97</td>
        <td>62</td>
        <td>35</td>
        <td>7.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b36274bc005d7e15180141896300f2f27b42028a" class="src_link" title="app/models/item_order.rb">app/models/item_order.rb</a></td>
        <td class="red strong">65.52 %</td>
        <td>64</td>
        <td>29</td>
        <td>19</td>
        <td>10</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e092cb510fdb11b11377cb2d620ca3a6052c2574" class="src_link" title="app/models/item_request.rb">app/models/item_request.rb</a></td>
        <td class="red strong">72.73 %</td>
        <td>51</td>
        <td>22</td>
        <td>16</td>
        <td>6</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#42c454128ef23ed48f48b33200eb505bf202dad6" class="src_link" title="app/models/item_tag.rb">app/models/item_tag.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#495962d13806c997aee47ad8282ec2aeeb5142a1" class="src_link" title="app/models/list.rb">app/models/list.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>31</td>
        <td>8</td>
        <td>4</td>
        <td>4</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#40165c28440da1190fd5ec056d0d7767b36b74d5" class="src_link" title="app/models/location.rb">app/models/location.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>17</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#48ead0e497ebd6c937c550960668617b9a132b43" class="src_link" title="app/models/maintenance.rb">app/models/maintenance.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b9bfd69a64d4c55a1ac4ff313cd500067278bbeb" class="src_link" title="app/models/maintenance/checklist_item.rb">app/models/maintenance/checklist_item.rb</a></td>
        <td class="yellow strong">84.0 %</td>
        <td>43</td>
        <td>25</td>
        <td>21</td>
        <td>4</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b6c67531fdc31efa1205577d809b637ef6bca2b4" class="src_link" title="app/models/maintenance/checklist_item_maintenance.rb">app/models/maintenance/checklist_item_maintenance.rb</a></td>
        <td class="red strong">72.73 %</td>
        <td>35</td>
        <td>22</td>
        <td>16</td>
        <td>6</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d5b33985ad1dfb976ad35856f1e35b18080e29ad" class="src_link" title="app/models/maintenance/cycle.rb">app/models/maintenance/cycle.rb</a></td>
        <td class="red strong">30.16 %</td>
        <td>204</td>
        <td>126</td>
        <td>38</td>
        <td>88</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#75f03a30026de5749e02c8283fd52e325b447bfe" class="src_link" title="app/models/maintenance/maintenance_record.rb">app/models/maintenance/maintenance_record.rb</a></td>
        <td class="red strong">66.07 %</td>
        <td>86</td>
        <td>56</td>
        <td>37</td>
        <td>19</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#12fbbebf597fa2027f8bcf52d4d645353ee22268" class="src_link" title="app/models/maintenance/public_area.rb">app/models/maintenance/public_area.rb</a></td>
        <td class="red strong">26.03 %</td>
        <td>107</td>
        <td>73</td>
        <td>19</td>
        <td>54</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4b555f1335d8225ec1fc745dd993ffdc16c8123b" class="src_link" title="app/models/maintenance/room.rb">app/models/maintenance/room.rb</a></td>
        <td class="red strong">29.21 %</td>
        <td>152</td>
        <td>89</td>
        <td>26</td>
        <td>63</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1a48da2986266dca740ba141919fe50a066703a7" class="src_link" title="app/models/maintenance/work_order.rb">app/models/maintenance/work_order.rb</a></td>
        <td class="red strong">53.1 %</td>
        <td>257</td>
        <td>113</td>
        <td>60</td>
        <td>53</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f55548d14f0220786d02ff7e5d37a6b7e11e795e" class="src_link" title="app/models/notification.rb">app/models/notification.rb</a></td>
        <td class="red strong">25.64 %</td>
        <td>57</td>
        <td>39</td>
        <td>10</td>
        <td>29</td>
        <td>2.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7602495140c597d5e4304ba00e2fef4356ab6fd7" class="src_link" title="app/models/permission.rb">app/models/permission.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>28</td>
        <td>10</td>
        <td>10</td>
        <td>0</td>
        <td>31.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7ef866112d399367a107bca193621885b42a1e5b" class="src_link" title="app/models/permission_attribute.rb">app/models/permission_attribute.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>12</td>
        <td>9</td>
        <td>9</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5c075d37b3fb65d2a7cc9af16470bf5c4abf4346" class="src_link" title="app/models/property.rb">app/models/property.rb</a></td>
        <td class="red strong">40.32 %</td>
        <td>238</td>
        <td>124</td>
        <td>50</td>
        <td>74</td>
        <td>35.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6624e36f5cec268a381a58b42914a10f069ce62b" class="src_link" title="app/models/purchase_order.rb">app/models/purchase_order.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>150</td>
        <td>70</td>
        <td>42</td>
        <td>28</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0967b902aa3edc624c23c27eccebafbad1f25c3e" class="src_link" title="app/models/purchase_receipt.rb">app/models/purchase_receipt.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>61</td>
        <td>25</td>
        <td>15</td>
        <td>10</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ed11a82eb42cef3e8d9ea565f2e6755d15c4401e" class="src_link" title="app/models/purchase_request.rb">app/models/purchase_request.rb</a></td>
        <td class="red strong">64.47 %</td>
        <td>166</td>
        <td>76</td>
        <td>49</td>
        <td>27</td>
        <td>1.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b56f1ff9066cc530742facd239b35139e959c920" class="src_link" title="app/models/report.rb">app/models/report.rb</a></td>
        <td class="red strong">59.09 %</td>
        <td>58</td>
        <td>22</td>
        <td>13</td>
        <td>9</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#656741560a80bbe9705c7743c0f5a6c7c027dc94" class="src_link" title="app/models/role.rb">app/models/role.rb</a></td>
        <td class="green strong">94.44 %</td>
        <td>33</td>
        <td>18</td>
        <td>17</td>
        <td>1</td>
        <td>33.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f2ae0ce065d82f7b544ca86451666ebba1a75f5e" class="src_link" title="app/models/tag.rb">app/models/tag.rb</a></td>
        <td class="red strong">52.0 %</td>
        <td>171</td>
        <td>75</td>
        <td>39</td>
        <td>36</td>
        <td>36.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2e9149c8406a1f474043984060b22b296b807092" class="src_link" title="app/models/unit.rb">app/models/unit.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>19</td>
        <td>5</td>
        <td>4</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d52c6aed0a2bc2631ad443122fa45c7e7eda5bdc" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">70.09 %</td>
        <td>205</td>
        <td>117</td>
        <td>82</td>
        <td>35</td>
        <td>16.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4a6e929255b325384a9026dd2c10fb2a82e4dfd4" class="src_link" title="app/models/user_role.rb">app/models/user_role.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>10</td>
        <td>10</td>
        <td>0</td>
        <td>69.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e6e6011e5f1f9bb16526f21f69d974d697298a32" class="src_link" title="app/models/vendor.rb">app/models/vendor.rb</a></td>
        <td class="red strong">70.59 %</td>
        <td>76</td>
        <td>34</td>
        <td>24</td>
        <td>10</td>
        <td>14.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ac39e26e8ff48fcde02c6091fbaf69d402373728" class="src_link" title="app/models/vendor_item.rb">app/models/vendor_item.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>26</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4ef202091d9ca1b3ae74a77693ff964b5612fe24" class="src_link" title="app/policies/access_policy.rb">app/policies/access_policy.rb</a></td>
        <td class="yellow strong">81.25 %</td>
        <td>32</td>
        <td>16</td>
        <td>13</td>
        <td>3</td>
        <td>16.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ca4542862f1fc01723aa84f02954ab7812fa6002" class="src_link" title="app/policies/application_policy.rb">app/policies/application_policy.rb</a></td>
        <td class="yellow strong">85.71 %</td>
        <td>22</td>
        <td>14</td>
        <td>12</td>
        <td>2</td>
        <td>56.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d1700c86e7e9d77f893cc9635651d8b88d37c6be" class="src_link" title="app/policies/maintenance/base_policy.rb">app/policies/maintenance/base_policy.rb</a></td>
        <td class="red strong">45.0 %</td>
        <td>37</td>
        <td>20</td>
        <td>9</td>
        <td>11</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6eda0956926f03129924734b2c9f2681abaee058" class="src_link" title="app/policies/maintenance/work_order_policy.rb">app/policies/maintenance/work_order_policy.rb</a></td>
        <td class="red strong">44.0 %</td>
        <td>56</td>
        <td>25</td>
        <td>11</td>
        <td>14</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0eaacdf6db49592412ce6266de1d4b12cde7a00b" class="src_link" title="app/policies/report_policy.rb">app/policies/report_policy.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>8</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>18.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a8d317ac776e74208dfc0c3b5b74cd4e6615996b" class="src_link" title="app/policies/user_policy.rb">app/policies/user_policy.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>17</td>
        <td>8</td>
        <td>8</td>
        <td>0</td>
        <td>13.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2fee65bba191239c4eb4bc0333e49fcc72b0dcbe" class="src_link" title="app/uploaders/avatar_uploader.rb">app/uploaders/avatar_uploader.rb</a></td>
        <td class="yellow strong">84.62 %</td>
        <td>55</td>
        <td>13</td>
        <td>11</td>
        <td>2</td>
        <td>3.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bd6b24b14770a775ccf8ac4dac0e661ecd593d7c" class="src_link" title="app/validators/email_validator.rb">app/validators/email_validator.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>2</td>
        <td>2</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#40217dca5f1e66b488427de2a260d00f439a57ea" class="src_link" title="app/workers/fax_worker.rb">app/workers/fax_worker.rb</a></td>
        <td class="yellow strong">87.5 %</td>
        <td>32</td>
        <td>16</td>
        <td>14</td>
        <td>2</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e2b49d0da10da7703143a2d57edcacccb823b584" class="src_link" title="lib/devise_pdf_failure.rb">lib/devise_pdf_failure.rb</a></td>
        <td class="red strong">44.44 %</td>
        <td>16</td>
        <td>9</td>
        <td>4</td>
        <td>5</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#49f20e47891ffb6440550b933d316da5ff79b59d" class="src_link" title="lib/faker/vendor.rb">lib/faker/vendor.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>7</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>25.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cc3011576206c3eacbfc0fa1b61b9ba578a7c3be" class="src_link" title="lib/settings.rb">lib/settings.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#763851f07029d2b3fc946fd1d73e40637dcd3f78" class="src_link" title="lib/twilio_client.rb">lib/twilio_client.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>20</td>
        <td>10</td>
        <td>5</td>
        <td>5</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#daf229d7628e44766d4f11381c1d14663de4018a" class="src_link" title="vendor/patch/active-record-lax-includes/lib/activerecord_lax_includes.rb">vendor/patch/active-record-lax-includes/lib/activerecord_lax_includes.rb</a></td>
        <td class="red strong">63.89 %</td>
        <td>64</td>
        <td>36</td>
        <td>23</td>
        <td>13</td>
        <td>4.1</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent"><span class="red">31.04%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1.75
       </span>
    </span> hits/line)
  </h2>
  <a name="Controllers"></a>
  <div>
    <b>21</b> files in total.
    <b>1234</b> relevant lines. 
    <span class="green"><b>383</b> lines covered</span> and
    <span class="red"><b>851</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#e1eda1465ed77ef6c5477fe6b36e6c84e9d479e2" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="red strong">67.74 %</td>
        <td>104</td>
        <td>62</td>
        <td>42</td>
        <td>20</td>
        <td>24.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c4c0e5fb3f29d1c7b4b5a2eee43b2251f45ba029" class="src_link" title="app/controllers/budgets_controller.rb">app/controllers/budgets_controller.rb</a></td>
        <td class="green strong">93.75 %</td>
        <td>79</td>
        <td>48</td>
        <td>45</td>
        <td>3</td>
        <td>2.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#423a99c0bdac0677defcd7beb8dfa0fa8e24f54a" class="src_link" title="app/controllers/categories_controller.rb">app/controllers/categories_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#086c6c05ca2163ee881e2f098ef952795a0e7217" class="src_link" title="app/controllers/corporate_connections_controller.rb">app/controllers/corporate_connections_controller.rb</a></td>
        <td class="red strong">47.73 %</td>
        <td>68</td>
        <td>44</td>
        <td>21</td>
        <td>23</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ea5a25437f902c7c0da804c3633170cc03e69adc" class="src_link" title="app/controllers/departments_controller.rb">app/controllers/departments_controller.rb</a></td>
        <td class="green strong">94.12 %</td>
        <td>58</td>
        <td>34</td>
        <td>32</td>
        <td>2</td>
        <td>1.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6ecc718eaf84b55ac4e2f9dce75cde908b24c284" class="src_link" title="app/controllers/fax_controller.rb">app/controllers/fax_controller.rb</a></td>
        <td class="red strong">46.88 %</td>
        <td>49</td>
        <td>32</td>
        <td>15</td>
        <td>17</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8e4cf7a330c6d20b540cb7cb00ac00243d0c8e66" class="src_link" title="app/controllers/items_controller.rb">app/controllers/items_controller.rb</a></td>
        <td class="red strong">64.94 %</td>
        <td>131</td>
        <td>77</td>
        <td>50</td>
        <td>27</td>
        <td>2.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#327d2ee069e6dac9d06c282811c82fd1f2fac3cf" class="src_link" title="app/controllers/join_invitations_controller.rb">app/controllers/join_invitations_controller.rb</a></td>
        <td class="red strong">22.22 %</td>
        <td>37</td>
        <td>18</td>
        <td>4</td>
        <td>14</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8a8b7bf3169b20888b636b7881459a698f1ea897" class="src_link" title="app/controllers/lists_controller.rb">app/controllers/lists_controller.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>8</td>
        <td>5</td>
        <td>4</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3d1e981dc40e16c01c4845f2510a562c127a4339" class="src_link" title="app/controllers/locations_controller.rb">app/controllers/locations_controller.rb</a></td>
        <td class="yellow strong">83.33 %</td>
        <td>11</td>
        <td>6</td>
        <td>5</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d41e80bc6a0d609411a9a02cf03944258b40cfc0" class="src_link" title="app/controllers/messages_controller.rb">app/controllers/messages_controller.rb</a></td>
        <td class="red strong">31.25 %</td>
        <td>29</td>
        <td>16</td>
        <td>5</td>
        <td>11</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d6454a6505e4807ea950b1eb8fa6e5b716236cfd" class="src_link" title="app/controllers/pages_controller.rb">app/controllers/pages_controller.rb</a></td>
        <td class="red strong">26.19 %</td>
        <td>66</td>
        <td>42</td>
        <td>11</td>
        <td>31</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c55421a31395a6ae720d968ead20cea1630f40e2" class="src_link" title="app/controllers/properties_controller.rb">app/controllers/properties_controller.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>35</td>
        <td>21</td>
        <td>7</td>
        <td>14</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6f4b65f47733e2bb182266e2ce882e0504d10fb0" class="src_link" title="app/controllers/property_settings_controller.rb">app/controllers/property_settings_controller.rb</a></td>
        <td class="red strong">37.5 %</td>
        <td>11</td>
        <td>8</td>
        <td>3</td>
        <td>5</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#db88345277a1aeda5b9b9d0535bb1a8f58a4f05a" class="src_link" title="app/controllers/purchase_orders_controller.rb">app/controllers/purchase_orders_controller.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>69</td>
        <td>42</td>
        <td>14</td>
        <td>28</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f068744f3605d454550a109d5476dfa53c3e4469" class="src_link" title="app/controllers/purchase_receipts_controller.rb">app/controllers/purchase_receipts_controller.rb</a></td>
        <td class="red strong">31.43 %</td>
        <td>57</td>
        <td>35</td>
        <td>11</td>
        <td>24</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e27042dc3f77a1cd93c42b7b7b7fd218ead80da8" class="src_link" title="app/controllers/purchase_requests_controller.rb">app/controllers/purchase_requests_controller.rb</a></td>
        <td class="red strong">17.98 %</td>
        <td>147</td>
        <td>89</td>
        <td>16</td>
        <td>73</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#29f68bc17fbfb3bcbbaeac00e5d460e240894611" class="src_link" title="app/controllers/reports_controller.rb">app/controllers/reports_controller.rb</a></td>
        <td class="red strong">7.69 %</td>
        <td>911</td>
        <td>455</td>
        <td>35</td>
        <td>420</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#beec737391bf54fe66309fbd911b8364a96f662c" class="src_link" title="app/controllers/tags_controller.rb">app/controllers/tags_controller.rb</a></td>
        <td class="red strong">58.7 %</td>
        <td>76</td>
        <td>46</td>
        <td>27</td>
        <td>19</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9db5e11457fec04ccaad53e85b2d0849e4590de3" class="src_link" title="app/controllers/users_controller.rb">app/controllers/users_controller.rb</a></td>
        <td class="red strong">15.38 %</td>
        <td>192</td>
        <td>117</td>
        <td>18</td>
        <td>99</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#757cc5d2df06db430841358537c938cf2239c194" class="src_link" title="app/controllers/vendors_controller.rb">app/controllers/vendors_controller.rb</a></td>
        <td class="red strong">45.71 %</td>
        <td>62</td>
        <td>35</td>
        <td>16</td>
        <td>19</td>
        <td>0.5</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent"><span class="red">57.03%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         10.17
       </span>
    </span> hits/line)
  </h2>
  <a name="Models"></a>
  <div>
    <b>40</b> files in total.
    <b>1508</b> relevant lines. 
    <span class="green"><b>860</b> lines covered</span> and
    <span class="red"><b>648</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#dbcb2c8b1c2ae0629066966d4cd362b921290232" class="src_link" title="app/models/ability.rb">app/models/ability.rb</a></td>
        <td class="red strong">74.59 %</td>
        <td>184</td>
        <td>122</td>
        <td>91</td>
        <td>31</td>
        <td>13.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b20be24f8b518a80a6e5418eaf79370dbff43b56" class="src_link" title="app/models/admin.rb">app/models/admin.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6d3b22ebae3faae08bda355a86afadeaff1f6845" class="src_link" title="app/models/brand.rb">app/models/brand.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>12</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e86539f79755b507e59ad2e8356e61f40ee13ac" class="src_link" title="app/models/budget.rb">app/models/budget.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>11</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>59.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3f8699d7da975e3068ff37c6aeb23f61e3ec465b" class="src_link" title="app/models/category.rb">app/models/category.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>23</td>
        <td>5</td>
        <td>4</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7fbc9476ecb4f51280e7b9b817719c61995a0649" class="src_link" title="app/models/concerns/stamp_user.rb">app/models/concerns/stamp_user.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>25</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>34.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8371af4b9e9b6cb7455c4c49a0d0c2dd2e45a892" class="src_link" title="app/models/corporate.rb">app/models/corporate.rb</a></td>
        <td class="red strong">40.0 %</td>
        <td>23</td>
        <td>15</td>
        <td>6</td>
        <td>9</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3e77c25b15f687a556203d894b55a2b85e690775" class="src_link" title="app/models/corporate/connection.rb">app/models/corporate/connection.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>35</td>
        <td>20</td>
        <td>15</td>
        <td>5</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a6664d5ab569e1f82e4d37a6ef548c4c12b000d1" class="src_link" title="app/models/department.rb">app/models/department.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>17</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>50.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3ec62e4dc23b27c9a77c32b638c534d4500bc63e" class="src_link" title="app/models/departments_tag.rb">app/models/departments_tag.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4e3ac73489fcdcabc92a15261a4c4150d6c1cb0b" class="src_link" title="app/models/departments_user.rb">app/models/departments_user.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b05cb236d823b6f124ac73c1eddbbf73337c2a19" class="src_link" title="app/models/item.rb">app/models/item.rb</a></td>
        <td class="red strong">63.92 %</td>
        <td>206</td>
        <td>97</td>
        <td>62</td>
        <td>35</td>
        <td>7.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b36274bc005d7e15180141896300f2f27b42028a" class="src_link" title="app/models/item_order.rb">app/models/item_order.rb</a></td>
        <td class="red strong">65.52 %</td>
        <td>64</td>
        <td>29</td>
        <td>19</td>
        <td>10</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e092cb510fdb11b11377cb2d620ca3a6052c2574" class="src_link" title="app/models/item_request.rb">app/models/item_request.rb</a></td>
        <td class="red strong">72.73 %</td>
        <td>51</td>
        <td>22</td>
        <td>16</td>
        <td>6</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#42c454128ef23ed48f48b33200eb505bf202dad6" class="src_link" title="app/models/item_tag.rb">app/models/item_tag.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#495962d13806c997aee47ad8282ec2aeeb5142a1" class="src_link" title="app/models/list.rb">app/models/list.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>31</td>
        <td>8</td>
        <td>4</td>
        <td>4</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#40165c28440da1190fd5ec056d0d7767b36b74d5" class="src_link" title="app/models/location.rb">app/models/location.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>17</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#48ead0e497ebd6c937c550960668617b9a132b43" class="src_link" title="app/models/maintenance.rb">app/models/maintenance.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b9bfd69a64d4c55a1ac4ff313cd500067278bbeb" class="src_link" title="app/models/maintenance/checklist_item.rb">app/models/maintenance/checklist_item.rb</a></td>
        <td class="yellow strong">84.0 %</td>
        <td>43</td>
        <td>25</td>
        <td>21</td>
        <td>4</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b6c67531fdc31efa1205577d809b637ef6bca2b4" class="src_link" title="app/models/maintenance/checklist_item_maintenance.rb">app/models/maintenance/checklist_item_maintenance.rb</a></td>
        <td class="red strong">72.73 %</td>
        <td>35</td>
        <td>22</td>
        <td>16</td>
        <td>6</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d5b33985ad1dfb976ad35856f1e35b18080e29ad" class="src_link" title="app/models/maintenance/cycle.rb">app/models/maintenance/cycle.rb</a></td>
        <td class="red strong">30.16 %</td>
        <td>204</td>
        <td>126</td>
        <td>38</td>
        <td>88</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#75f03a30026de5749e02c8283fd52e325b447bfe" class="src_link" title="app/models/maintenance/maintenance_record.rb">app/models/maintenance/maintenance_record.rb</a></td>
        <td class="red strong">66.07 %</td>
        <td>86</td>
        <td>56</td>
        <td>37</td>
        <td>19</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#12fbbebf597fa2027f8bcf52d4d645353ee22268" class="src_link" title="app/models/maintenance/public_area.rb">app/models/maintenance/public_area.rb</a></td>
        <td class="red strong">26.03 %</td>
        <td>107</td>
        <td>73</td>
        <td>19</td>
        <td>54</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4b555f1335d8225ec1fc745dd993ffdc16c8123b" class="src_link" title="app/models/maintenance/room.rb">app/models/maintenance/room.rb</a></td>
        <td class="red strong">29.21 %</td>
        <td>152</td>
        <td>89</td>
        <td>26</td>
        <td>63</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1a48da2986266dca740ba141919fe50a066703a7" class="src_link" title="app/models/maintenance/work_order.rb">app/models/maintenance/work_order.rb</a></td>
        <td class="red strong">53.1 %</td>
        <td>257</td>
        <td>113</td>
        <td>60</td>
        <td>53</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f55548d14f0220786d02ff7e5d37a6b7e11e795e" class="src_link" title="app/models/notification.rb">app/models/notification.rb</a></td>
        <td class="red strong">25.64 %</td>
        <td>57</td>
        <td>39</td>
        <td>10</td>
        <td>29</td>
        <td>2.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7602495140c597d5e4304ba00e2fef4356ab6fd7" class="src_link" title="app/models/permission.rb">app/models/permission.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>28</td>
        <td>10</td>
        <td>10</td>
        <td>0</td>
        <td>31.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7ef866112d399367a107bca193621885b42a1e5b" class="src_link" title="app/models/permission_attribute.rb">app/models/permission_attribute.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>12</td>
        <td>9</td>
        <td>9</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5c075d37b3fb65d2a7cc9af16470bf5c4abf4346" class="src_link" title="app/models/property.rb">app/models/property.rb</a></td>
        <td class="red strong">40.32 %</td>
        <td>238</td>
        <td>124</td>
        <td>50</td>
        <td>74</td>
        <td>35.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6624e36f5cec268a381a58b42914a10f069ce62b" class="src_link" title="app/models/purchase_order.rb">app/models/purchase_order.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>150</td>
        <td>70</td>
        <td>42</td>
        <td>28</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0967b902aa3edc624c23c27eccebafbad1f25c3e" class="src_link" title="app/models/purchase_receipt.rb">app/models/purchase_receipt.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>61</td>
        <td>25</td>
        <td>15</td>
        <td>10</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ed11a82eb42cef3e8d9ea565f2e6755d15c4401e" class="src_link" title="app/models/purchase_request.rb">app/models/purchase_request.rb</a></td>
        <td class="red strong">64.47 %</td>
        <td>166</td>
        <td>76</td>
        <td>49</td>
        <td>27</td>
        <td>1.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b56f1ff9066cc530742facd239b35139e959c920" class="src_link" title="app/models/report.rb">app/models/report.rb</a></td>
        <td class="red strong">59.09 %</td>
        <td>58</td>
        <td>22</td>
        <td>13</td>
        <td>9</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#656741560a80bbe9705c7743c0f5a6c7c027dc94" class="src_link" title="app/models/role.rb">app/models/role.rb</a></td>
        <td class="green strong">94.44 %</td>
        <td>33</td>
        <td>18</td>
        <td>17</td>
        <td>1</td>
        <td>33.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f2ae0ce065d82f7b544ca86451666ebba1a75f5e" class="src_link" title="app/models/tag.rb">app/models/tag.rb</a></td>
        <td class="red strong">52.0 %</td>
        <td>171</td>
        <td>75</td>
        <td>39</td>
        <td>36</td>
        <td>36.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2e9149c8406a1f474043984060b22b296b807092" class="src_link" title="app/models/unit.rb">app/models/unit.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>19</td>
        <td>5</td>
        <td>4</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d52c6aed0a2bc2631ad443122fa45c7e7eda5bdc" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">70.09 %</td>
        <td>205</td>
        <td>117</td>
        <td>82</td>
        <td>35</td>
        <td>16.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4a6e929255b325384a9026dd2c10fb2a82e4dfd4" class="src_link" title="app/models/user_role.rb">app/models/user_role.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>10</td>
        <td>10</td>
        <td>0</td>
        <td>69.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e6e6011e5f1f9bb16526f21f69d974d697298a32" class="src_link" title="app/models/vendor.rb">app/models/vendor.rb</a></td>
        <td class="red strong">70.59 %</td>
        <td>76</td>
        <td>34</td>
        <td>24</td>
        <td>10</td>
        <td>14.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ac39e26e8ff48fcde02c6091fbaf69d402373728" class="src_link" title="app/models/vendor_item.rb">app/models/vendor_item.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>26</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Mailers"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent"><span class="red">36.36%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1.12
       </span>
    </span> hits/line)
  </h2>
  <a name="Helpers"></a>
  <div>
    <b>7</b> files in total.
    <b>220</b> relevant lines. 
    <span class="green"><b>80</b> lines covered</span> and
    <span class="red"><b>140</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#13d111d145be886def86434b53c3a797358e69f6" class="src_link" title="app/helpers/activity_helper.rb">app/helpers/activity_helper.rb</a></td>
        <td class="red strong">25.0 %</td>
        <td>25</td>
        <td>12</td>
        <td>3</td>
        <td>9</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7b116802412a9cdecd059034225fe9e14fa9b76f" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
        <td class="red strong">38.55 %</td>
        <td>165</td>
        <td>83</td>
        <td>32</td>
        <td>51</td>
        <td>2.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b0c1a57d3a19c1274245f9d1417d882b08e4b1c7" class="src_link" title="app/helpers/budgets_helper.rb">app/helpers/budgets_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>11</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>7.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a741f2f9ad97005aebeb197bdfc29e9235cd5767" class="src_link" title="app/helpers/maintenance_helper.rb">app/helpers/maintenance_helper.rb</a></td>
        <td class="red strong">29.79 %</td>
        <td>99</td>
        <td>47</td>
        <td>14</td>
        <td>33</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#62c22822fd0fc8a83ac502fca8fdbd12ccc06d4a" class="src_link" title="app/helpers/permissions_helper.rb">app/helpers/permissions_helper.rb</a></td>
        <td class="red strong">41.18 %</td>
        <td>32</td>
        <td>17</td>
        <td>7</td>
        <td>10</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#561132ed1ea9793eab681bc9fff1dc6c3bdd39a4" class="src_link" title="app/helpers/pusher_helper.rb">app/helpers/pusher_helper.rb</a></td>
        <td class="red strong">70.0 %</td>
        <td>37</td>
        <td>20</td>
        <td>14</td>
        <td>6</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#162e13573b11f3a868c04d7d3af910b4dbb52291" class="src_link" title="app/helpers/report_helper.rb">app/helpers/report_helper.rb</a></td>
        <td class="red strong">13.89 %</td>
        <td>59</td>
        <td>36</td>
        <td>5</td>
        <td>31</td>
        <td>0.1</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent"><span class="red">63.49%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         4.15
       </span>
    </span> hits/line)
  </h2>
  <a name="Libraries"></a>
  <div>
    <b>5</b> files in total.
    <b>63</b> relevant lines. 
    <span class="green"><b>40</b> lines covered</span> and
    <span class="red"><b>23</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#e2b49d0da10da7703143a2d57edcacccb823b584" class="src_link" title="lib/devise_pdf_failure.rb">lib/devise_pdf_failure.rb</a></td>
        <td class="red strong">44.44 %</td>
        <td>16</td>
        <td>9</td>
        <td>4</td>
        <td>5</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#49f20e47891ffb6440550b933d316da5ff79b59d" class="src_link" title="lib/faker/vendor.rb">lib/faker/vendor.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>7</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>25.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cc3011576206c3eacbfc0fa1b61b9ba578a7c3be" class="src_link" title="lib/settings.rb">lib/settings.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#763851f07029d2b3fc946fd1d73e40637dcd3f78" class="src_link" title="lib/twilio_client.rb">lib/twilio_client.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>20</td>
        <td>10</td>
        <td>5</td>
        <td>5</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#daf229d7628e44766d4f11381c1d14663de4018a" class="src_link" title="vendor/patch/active-record-lax-includes/lib/activerecord_lax_includes.rb">vendor/patch/active-record-lax-includes/lib/activerecord_lax_includes.rb</a></td>
        <td class="red strong">63.89 %</td>
        <td>64</td>
        <td>36</td>
        <td>23</td>
        <td>13</td>
        <td>4.1</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent"><span class="red">64.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         9.18
       </span>
    </span> hits/line)
  </h2>
  <a name="Ungrouped"></a>
  <div>
    <b>10</b> files in total.
    <b>150</b> relevant lines. 
    <span class="green"><b>96</b> lines covered</span> and
    <span class="red"><b>54</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#312ce01c3e846734ee018d9ae042950c1594854f" class="src_link" title="app/decorators/item_order_decorator.rb">app/decorators/item_order_decorator.rb</a></td>
        <td class="red strong">40.0 %</td>
        <td>58</td>
        <td>30</td>
        <td>12</td>
        <td>18</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4ef202091d9ca1b3ae74a77693ff964b5612fe24" class="src_link" title="app/policies/access_policy.rb">app/policies/access_policy.rb</a></td>
        <td class="yellow strong">81.25 %</td>
        <td>32</td>
        <td>16</td>
        <td>13</td>
        <td>3</td>
        <td>16.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ca4542862f1fc01723aa84f02954ab7812fa6002" class="src_link" title="app/policies/application_policy.rb">app/policies/application_policy.rb</a></td>
        <td class="yellow strong">85.71 %</td>
        <td>22</td>
        <td>14</td>
        <td>12</td>
        <td>2</td>
        <td>56.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d1700c86e7e9d77f893cc9635651d8b88d37c6be" class="src_link" title="app/policies/maintenance/base_policy.rb">app/policies/maintenance/base_policy.rb</a></td>
        <td class="red strong">45.0 %</td>
        <td>37</td>
        <td>20</td>
        <td>9</td>
        <td>11</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6eda0956926f03129924734b2c9f2681abaee058" class="src_link" title="app/policies/maintenance/work_order_policy.rb">app/policies/maintenance/work_order_policy.rb</a></td>
        <td class="red strong">44.0 %</td>
        <td>56</td>
        <td>25</td>
        <td>11</td>
        <td>14</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0eaacdf6db49592412ce6266de1d4b12cde7a00b" class="src_link" title="app/policies/report_policy.rb">app/policies/report_policy.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>8</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>18.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a8d317ac776e74208dfc0c3b5b74cd4e6615996b" class="src_link" title="app/policies/user_policy.rb">app/policies/user_policy.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>17</td>
        <td>8</td>
        <td>8</td>
        <td>0</td>
        <td>13.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2fee65bba191239c4eb4bc0333e49fcc72b0dcbe" class="src_link" title="app/uploaders/avatar_uploader.rb">app/uploaders/avatar_uploader.rb</a></td>
        <td class="yellow strong">84.62 %</td>
        <td>55</td>
        <td>13</td>
        <td>11</td>
        <td>2</td>
        <td>3.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bd6b24b14770a775ccf8ac4dac0e661ecd593d7c" class="src_link" title="app/validators/email_validator.rb">app/validators/email_validator.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>2</td>
        <td>2</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#40217dca5f1e66b488427de2a260d00f439a57ea" class="src_link" title="app/workers/fax_worker.rb">app/workers/fax_worker.rb</a></td>
        <td class="yellow strong">87.5 %</td>
        <td>32</td>
        <td>16</td>
        <td>14</td>
        <td>2</td>
        <td>0.9</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.9.0 
        and simplecov-html v0.8.0<br/>
        using Unit Tests
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="e1eda1465ed77ef6c5477fe6b36e6c84e9d479e2">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4><span class="red">67.74 %</span> covered</h4>
    <div>
      <b>62</b> relevant lines. 
      <span class="green"><b>42</b> lines covered</span> and
      <span class="red"><b>20</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Pundit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  protect_from_forgery</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :scope_current_property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :set_cache_buster</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_cycle(cycle_type=:room)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    Maintenance::Cycle.current cycle_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def previous_cycle(cycle_type)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    Maintenance::Cycle.previous cycle_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :current_cycle</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :previous_cycle</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  helper :all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_cache_buster</code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="21">
          <span class="hits">76</span>
          
          <code class="ruby">    response.headers[&quot;Cache-Control&quot;] = &quot;no-cache, no-store, max-age=0, must-revalidate&quot;</code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="22">
          <span class="hits">76</span>
          
          <code class="ruby">    response.headers[&quot;Pragma&quot;] = &quot;no-cache&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def scope_current_property</code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="26">
          <span class="hits">76</span>
          
          <code class="ruby">    Property.current_id = current_property.try(:id) if user_signed_in?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  rescue_from CanCan::AccessDenied do |e|</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="30">
          <span class="hits">16</span>
          
          <code class="ruby">    flash[:alert] = e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="32">
          <span class="hits">16</span>
          
          <code class="ruby">    if request.env[&quot;HTTP_REFERER&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      redirect_to :back</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="35">
          <span class="hits">16</span>
          
          <code class="ruby">      redirect_to &#39;/&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  rescue_from Pundit::NotAuthorizedError do |e|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="40">
          <span class="hits">6</span>
          
          <code class="ruby">    flash[:alert] = &#39;You are not authorized to access page.&#39;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="41">
          <span class="hits">6</span>
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="42">
          <span class="hits">6</span>
          
          <code class="ruby">      format.any(:all, :json) { render json: &#39;You cannot perform this action&#39;, status: :forbidden }</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="43">
          <span class="hits">12</span>
          
          <code class="ruby">      format.html { redirect_to request.env[&quot;HTTP_REFERER&quot;] ? :back : &#39;/&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def user_properties</code>
        </li>
      
        <li class="covered" data-hits="230" data-linenumber="48">
          <span class="hits">230</span>
          
          <code class="ruby">    @user_properties ||= current_user.all_properties</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :user_properties</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_corporate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    current_user.corporate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :current_corporate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    # return nil if current_user.corporate? &amp;&amp; session[:property_id].blank?</code>
        </li>
      
        <li class="covered" data-hits="163" data-linenumber="59">
          <span class="hits">163</span>
          
          <code class="ruby">    if current_user.corporate?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      if session[:property_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        return user_properties.where(id: session[:property_id]).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="163" data-linenumber="67">
          <span class="hits">163</span>
          
          <code class="ruby">    @current_property = user_properties.where(id: session[:property_id]).first</code>
        </li>
      
        <li class="covered" data-hits="163" data-linenumber="68">
          <span class="hits">163</span>
          
          <code class="ruby">    @current_property ||= user_properties.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="163" data-linenumber="70">
          <span class="hits">163</span>
          
          <code class="ruby">    raise I18n.t(&#39;controllers.application.no_properties_for_user&#39;) if @current_property.nil?</code>
        </li>
      
        <li class="covered" data-hits="163" data-linenumber="71">
          <span class="hits">163</span>
          
          <code class="ruby">    session[:property_id] = @current_property.id</code>
        </li>
      
        <li class="covered" data-hits="163" data-linenumber="72">
          <span class="hits">163</span>
          
          <code class="ruby">    @current_property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :current_property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  def selected_property</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    @selected_property ||= Property.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :selected_property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def after_sign_in_path_for(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    devise_urls = [new_user_session_path, user_confirmation_path]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    if user.is_a? Admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      admin_root_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      if request.referer &amp;&amp; devise_urls.any? { |url| request.referer.index(url).present? }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        session[:property_id] = user.settings[&#39;primary_hotel&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        stored_location_for(user) || request.referer || authenticated_root_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  # use around_filter to render action with scoping property.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">  # need to pass param[:property_id]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  def action_with_property</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    @prev_property_id = Property.current_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    property_id = current_user.corporate? ? current_corporate.properties.first.try(:id) : Property.current_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    Property.current_id = params[:property_id] || property_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    yield</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">    Property.current_id = @prev_property_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c4c0e5fb3f29d1c7b4b5a2eee43b2251f45ba029">
  <div class="header">
    <h3>app/controllers/budgets_controller.rb</h3>
    <h4><span class="green">93.75 %</span> covered</h4>
    <div>
      <b>48</b> relevant lines. 
      <span class="green"><b>45</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class BudgetsController &lt; ApplicationController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html, :json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="9">
          <span class="hits">5</span>
          
          <code class="ruby">    @first_half = (params[:first_half] || (Date.today.month - 1) / 6).to_i</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="10">
          <span class="hits">5</span>
          
          <code class="ruby">    @year = (params[:year] || Date.today.year).to_i</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="11">
          <span class="hits">5</span>
          
          <code class="ruby">    months = ((@first_half * 6)..(@first_half * 6 + 6)).to_a</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="12">
          <span class="hits">5</span>
          
          <code class="ruby">    @budgets = Budget.where(year: @year, month: months).includes(:user)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="13">
          <span class="hits">5</span>
          
          <code class="ruby">    @total = @budgets.group(:month).sum(:amount)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="15">
          <span class="hits">5</span>
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="16">
          <span class="hits">10</span>
          
          <code class="ruby">      format.html { render :index }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="17">
          <span class="hits">5</span>
          
          <code class="ruby">      format.json { </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">          year: @year, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">          first_half: @first_half, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">          budgets: @budgets.to_json(include: {user: {only: :name}})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">    categories = params[:budget].delete(:categories).reject(&amp;:blank?)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="29">
          <span class="hits">2</span>
          
          <code class="ruby">    categories = Category.pluck(:id) if categories.blank?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="30">
          <span class="hits">2</span>
          
          <code class="ruby">    amount = params[:budget].delete :amount</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="31">
          <span class="hits">2</span>
          
          <code class="ruby">    @budgets = []</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="32">
          <span class="hits">2</span>
          
          <code class="ruby">    Category.where(id: categories).each do |c|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="33">
          <span class="hits">2</span>
          
          <code class="ruby">      budget = c.budgets.where(params[:budget]).first || c.budgets.build(budget_params)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="34">
          <span class="hits">2</span>
          
          <code class="ruby">      budget.user = current_user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">      budget.amount = amount</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">      budget.save!</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="37">
          <span class="hits">2</span>
          
          <code class="ruby">      @budgets &lt;&lt; budget</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">    render json: {budgets: @budgets}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    @budget = Budget.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    respond_with @budget</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    @budget = Budget.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    @old_category_id = @budget.category_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    @old_month = @budget.month</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    if @budget.update_attributes(budget_params)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {budgets: [@budget], old_category_id: @old_category_id, old_month: @old_month}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      render json: {error: &quot;Failed to update budget.&quot;}, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    @budget = Budget.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    @category_id = @budget.category_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    @month = @budget.month</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    if @budget.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {category_id: @category_id, month: @month}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      render json: {}, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def authorize</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="72">
          <span class="hits">13</span>
          
          <code class="ruby">    authorize! params[:action].to_sym, Budget</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def budget_params</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="76">
          <span class="hits">2</span>
          
          <code class="ruby">    params.require(:budget).permit(:amount, :year, :month)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="423a99c0bdac0677defcd7beb8dfa0fa8e24f54a">
  <div class="header">
    <h3>app/controllers/categories_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class CategoriesController &lt; TagsController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&#39;controllers.categories.categories&#39;), :categories_path, :options =&gt; { :title =&gt; &quot;Categories&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="086c6c05ca2163ee881e2f098ef952795a0e7217">
  <div class="header">
    <h3>app/controllers/corporate_connections_controller.rb</h3>
    <h4><span class="red">47.73 %</span> covered</h4>
    <div>
      <b>44</b> relevant lines. 
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>23</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class CorporateConnectionsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    if current_property.corporate_connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      redirect_to corporate_connections_path and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    add_breadcrumb t(&#39;controllers.corporate_connections.settings&#39;), property_settings_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    add_breadcrumb t(&#39;controllers.corporate_connections.connect_to_corporate&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    @connection = Corporate::Connection.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">    add_breadcrumb t(&#39;controllers.corporate_connections.settings&#39;), property_settings_path</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">    add_breadcrumb t(&#39;controllers.corporate_connections.connect_to_corporate&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">    @connection = current_property.corporate_connection</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">    !@connection &amp;&amp; redirect_to(new_corporate_connections_path) and return</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">    unless @connection.corporate_approved?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">      render :show_verification</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      render :show_confirm</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    @connection = current_property.corporate_connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    if params[:approve]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      @connection.approve!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      flash[:notice] = t(&#39;controllers.corporate_connections.connected_successfully&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    elsif params[:reject]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      @connection.reject!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      flash[:notice] = t(&#39;controllers.corporate_connections.connection_declined&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    redirect_to :property_settings</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    @connection = current_property.build_corporate_connection(create_attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    if @connection.valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      user = @connection.corp_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      if user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        @connection.corporate_id  = user.corporate_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        @connection.created_by_id = current_user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        @connection.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        CorporateConnectionsMailer.delay.new_connection_notification(@connection.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        redirect_to corporate_connections_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        flash.now[:alert] = t(&#39;controllers.corporate_connections.no_such_user&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        render :new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      flash.now[:alert] = @connection.errors.full_messages.to_sentence</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      render :new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def authorize</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="62">
          <span class="hits">9</span>
          
          <code class="ruby">    authorize!params[:action], Corporate::Connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_attributes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    params.require(:corporate_connection).permit(:email, :email_confirmation)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ea5a25437f902c7c0da804c3633170cc03e69adc">
  <div class="header">
    <h3>app/controllers/departments_controller.rb</h3>
    <h4><span class="green">94.12 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>32</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class DepartmentsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&#39;controllers.departments.departments&#39;), :departments_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">    scope = params[:scope] == &#39;deleted&#39; &amp;&amp; &#39;only_deleted&#39; || &#39;all&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">    @departments = Department.send(scope)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    @department = Department.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    render &#39;form&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    @department = Department.with_deleted.find params[:id]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    add_breadcrumb @department.name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    render &#39;form&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    @department = Department.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    save_department_changes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    @department = Department.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    save_department_changes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    @department = Department.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    @department.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    redirect_to :departments, notice: I18n.t(&#39;controllers.departments.department_inactivated&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_permissions</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="41">
          <span class="hits">13</span>
          
          <code class="ruby">    authorize User, :index?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def department_params</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="45">
          <span class="hits">2</span>
          
          <code class="ruby">    params.require(:department).permit(:name, category_ids: [], user_ids: [])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def save_department_changes</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="49">
          <span class="hits">2</span>
          
          <code class="ruby">    @department.assign_attributes(department_params)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="50">
          <span class="hits">2</span>
          
          <code class="ruby">    if @department.save</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="51">
          <span class="hits">2</span>
          
          <code class="ruby">      redirect_to :departments, notice: I18n.t(&#39;controllers.departments.department_updated&#39;, name: @department.name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      flash.now[:error] = @department.errors.full_messages.to_sentence</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      render &#39;form&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6ecc718eaf84b55ac4e2f9dce75cde908b24c284">
  <div class="header">
    <h3>app/controllers/fax_controller.rb</h3>
    <h4><span class="red">46.88 %</span> covered</h4>
    <div>
      <b>32</b> relevant lines. 
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>17</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class FaxController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  require &#39;json&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include PusherHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :json, :html</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # before_filter :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :verify_authenticity_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    po = PurchaseOrder.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    respond_with({sent: po.sent_by_fax?}, location: po)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    po = PurchaseOrder.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    vendor_fax_number = po.vendor.fax</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    if vendor_fax_number.present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      FaxWorker.perform_async(vendor_fax_number, po.id, current_user.id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      respond_with({result: :ok, polling_url: fax_path(purchase_order_id: params[:id])}, status: :created, location: po) do |format|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">        format.html { redirect_to po, notice: I18n.t(&#39;controllers.fax.fax_being_processing&#39;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">        format.json { render json: { message: I18n.t(&#39;controllers.fax.fax_being_processing&#39;) } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      respond_with({result: :error}, status: :unprocessable_entity, location: nil) do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        format.html { redirect_to po, alert: I18n.t(&#39;controllers.fax.vendor_has_no_fax&#39;) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        format.json { render json: { message: I18n.t(&#39;controllers.fax.vendor_has_no_fax&#39;) }, status: :unprocessable_entity }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    response = JSON.parse(params[:fax])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    po = PurchaseOrder.unscoped.where(fax_id: response[&#39;id&#39;]).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    Property.current_id = po.property_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    if response[&#39;status&#39;] == &#39;success&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      po.update_attributes fax_last_message: &#39;Sent&#39;, fax_last_status: PurchaseOrder::FAX_SUCCESS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      po.sent!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      Notification.purchase_order_fax_notification po.last_user_id, &#39;fax.sent&#39;, po.id, I18n.t(&#39;controllers.fax.fax_sent_successfully&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      send_fax_event PurchaseOrder::FAX_SUCCESS, {message: I18n.t(&#39;controllers.fax.fax_sent&#39;), po_number: po.number, to: po.last_user_id}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    elsif response[&#39;status&#39;] == &#39;failure&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      po.update_attributes fax_last_message: response[&#39;error_code&#39;], fax_last_status: PurchaseOrder::FAX_FAILED</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      Notification.purchase_order_fax_notification &#39;fax.failed&#39;, &#39;fax.failed&#39;, po.last_user_id, I18n.t(&#39;controllers.fax.failed_to_send&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      send_fax_event PurchaseOrder::FAX_FAILED, {message: I18n.t(&#39;controllers.fax.failed_to_send&#39;), po_number: po.number, to: po.last_user_id}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    render nothing: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="8e4cf7a330c6d20b540cb7cb00ac00243d0c8e66">
  <div class="header">
    <h3>app/controllers/items_controller.rb</h3>
    <h4><span class="red">64.94 %</span> covered</h4>
    <div>
      <b>77</b> relevant lines. 
      <span class="green"><b>50</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ItemsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&quot;controllers.items.items&quot;), :items_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :load_item, only: :create</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # before_action :load_items, only: :index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :load_categories, only: [:new, :edit]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  load_and_authorize_resource except: [:index]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="11">
          <span class="hits">8</span>
          
          <code class="ruby">    authorize! :index, Item</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="12">
          <span class="hits">8</span>
          
          <code class="ruby">    accessible_items = Item.accessible_by(current_ability).includes(:vendors)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="13">
          <span class="hits">8</span>
          
          <code class="ruby">    unless params[:search].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      for column_name, query in params[:search]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        accessible_items = accessible_items.search_columns(column_name.to_sym, query) unless query.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="18">
          <span class="hits">8</span>
          
          <code class="ruby">    @total_items_count = accessible_items.count</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="19">
          <span class="hits">8</span>
          
          <code class="ruby">    @items = accessible_items.page(params[:page]).per(10)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="20">
          <span class="hits">8</span>
          
          <code class="ruby">    respond_to do |fmt|</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="21">
          <span class="hits">8</span>
          
          <code class="ruby">      fmt.html</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="22">
          <span class="hits">8</span>
          
          <code class="ruby">      fmt.json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="27">
          <span class="hits">5</span>
          
          <code class="ruby">    add_breadcrumb t(&quot;controllers.items.breadcrumb_new&quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="28">
          <span class="hits">5</span>
          
          <code class="ruby">    @item.build_unit</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="29">
          <span class="hits">5</span>
          
          <code class="ruby">    @item.vendor_items.build unless @item.vendor_items.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="33">
          <span class="hits">8</span>
          
          <code class="ruby">    add_breadcrumb t(&quot;controllers.items.breadcrumb_edit&quot;, number: @item.number)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="34">
          <span class="hits">8</span>
          
          <code class="ruby">    @item.build_unit unless @item.unit</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="35">
          <span class="hits">8</span>
          
          <code class="ruby">    @item.vendor_items.build unless @item.vendor_items.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit_multiple_tags</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    @items = Item.where(id: params[:selected_item_ids])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    respond_with @items do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      format.html {render layout: false}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def new_import</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    add_breadcrumb t(&#39;controllers.items.import&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def import</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    if params[:template].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      flash[:error] = t(&#39;controllers.items.need_to_select_file&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      redirect_to items_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    elsif @items = ItemIngestion.read_excel(current_property, params[:template])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      logger.fatal @items.inspect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      redirect_to items_url, notice: t(&#39;controllers.items.import_successful&#39;, file_name: params[:template].original_filename, items_count: @items.count) </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      flash[:error] = t(&#39;controllers.items.failed_to_upload_template&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      redirect_to items_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="63">
          <span class="hits">3</span>
          
          <code class="ruby">    @item = Item.new(item_params)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="64">
          <span class="hits">3</span>
          
          <code class="ruby">    if @item.save</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="65">
          <span class="hits">3</span>
          
          <code class="ruby">      redirect_to :items, notice: t(&#39;controllers.items.item_created&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      @item.build_unit unless @item.unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      render action: &#39;new&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="73">
          <span class="hits">3</span>
          
          <code class="ruby">    result = @item.update_attributes(item_params)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="74">
          <span class="hits">3</span>
          
          <code class="ruby">    respond_to do |fmt|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="75">
          <span class="hits">3</span>
          
          <code class="ruby">      fmt.html do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="76">
          <span class="hits">3</span>
          
          <code class="ruby">        if result</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="77">
          <span class="hits">3</span>
          
          <code class="ruby">          redirect_to :items, notice: t(&#39;controllers.items.item_updated&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          render action: &#39;edit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="82">
          <span class="hits">3</span>
          
          <code class="ruby">      fmt.json do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        if result</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">          render json: true, status: 200</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">          render json: true, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_multiple_tags</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    @items = Item.find(params[:selected_item_ids])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    @items.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      item.tag_ids |= item_params[:tag_ids]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      item.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    redirect_to items_path, notice: t(&#39;controllers.items.items_updated&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="102">
          <span class="hits">2</span>
          
          <code class="ruby">    @items = Item.where(id: params[:ids]).destroy_all</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="103">
          <span class="hits">2</span>
          
          <code class="ruby">    redirect_to items_path, notice: t(&#39;controllers.items.items_deleted&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_item</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="108">
          <span class="hits">4</span>
          
          <code class="ruby">    @item = Item.new(item_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_items</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    if current_user.current_property_role.manager?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">      @items = Item.find( ItemTag.where(tag_id: current_user.category_ids.uniq ).map(&amp;:item_id) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_categories</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="118">
          <span class="hits">14</span>
          
          <code class="ruby">    @categories = current_user.current_property_role.manager? ? current_user.categories : Category.all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">  def item_params</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="122">
          <span class="hits">10</span>
          
          <code class="ruby">    params.require(:item).permit :name, :description, :brand_id, :is_asset, :category_ids, :purchase_cost_unit_id, :purchase_cost, {tag_ids: []}, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      {location_ids: []}, :par_level, :is_taxable, :pack_size,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      :price, :unit_id, :subpack_unit_id, :pack_unit_id, :unit_subpack,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      :subpack_size, :inventory_unit_id, :price_unit_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      unit_attributes: [:name, :description],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      pack_attributes: [:name, :description],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      subpack_attributes: [:name, :description],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      vendor_items_attributes: [:id, :vendor_id, :price, :items_per_box, :sku, :preferred, :_destroy]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="327d2ee069e6dac9d06c282811c82fd1f2fac3cf">
  <div class="header">
    <h3>app/controllers/join_invitations_controller.rb</h3>
    <h4><span class="red">22.22 %</span> covered</h4>
    <div>
      <b>18</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class JoinInvitationsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def accept</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    invitation = JoinInvitation.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    if invitation &amp;&amp; current_user == invitation.invitee</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      if invitation.target_type == &#39;hotel&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">        invitation.targetable.run do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">          user_params = ActionController::Parameters.new(invitation.params).permit!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">          current_user.update(user_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">          current_user.reload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      elsif invitation.target_type == &#39;corporate&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        current_user.update_attributes(corporate_id: invitation.targetable_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        # invitation.targetable.properties.each do |p|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        #   p.run_block do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        #     current_user.current_property_role = Role.corporate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        #     current_user.title = &#39;Corporate User&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        #     current_user.order_approval_limit = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        #     current_user.departments &lt;&lt; Department.find_or_create_by(name: &#39;All&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        #     current_user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      redirect_to authenticated_root_path, notice: &quot;You now have access to #{invitation.targetable.name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      invitation.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      redirect_to authenticated_root_path, alert: &quot;Attempted to access an invitation they didn&#39;t own&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    invitation = JoinInvitation.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    invitation.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    redirect_to users_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="8a8b7bf3169b20888b636b7881459a698f1ea897">
  <div class="header">
    <h3>app/controllers/lists_controller.rb</h3>
    <h4><span class="red">80.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ListsController &lt; TagsController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_permissions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&#39;controllers.lists.lists&#39;), :lists_path, :options =&gt; { :title =&gt; &quot;Lists&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    authorize!(params[:action].to_sym, tag || List)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3d1e981dc40e16c01c4845f2510a562c127a4339">
  <div class="header">
    <h3>app/controllers/locations_controller.rb</h3>
    <h4><span class="yellow">83.33 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class LocationsController &lt; TagsController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&#39;controllers.locations.locations&#39;), :locations_path, :options =&gt; { :title =&gt; I18n.t(&#39;controllers.locations.locations&#39;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    authorize!(params[:action].to_sym, @tag || Location)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d41e80bc6a0d609411a9a02cf03944258b40cfc0">
  <div class="header">
    <h3>app/controllers/messages_controller.rb</h3>
    <h4><span class="red">31.25 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class MessagesController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  around_filter :action_with_property, only: [:index]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    messagable = params[:model_type].classify.constantize.find(params[:model_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    @messages = messagable.messages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    @messages.build(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      user_id: messagable.closed_by_user_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      body: &quot;(Closing Comment) #{messagable.closing_comment}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      created_at: messagable.closed_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    ) if messagable.is_a?(Maintenance::WorkOrder) &amp;&amp; messagable.closed? &amp;&amp; messagable.closing_comment.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @messages = @messages.to_a.sort_by(&amp;:created_at).reverse!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    @message = Message.new body: params[:body], attachment: params[:attachment]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @message.user = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    @message.messagable_type = params[:model_type]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @message.messagable_id = params[:model_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    if @message.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      render action: &#39;show&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      render json: {error: &#39;Failed to add message&#39;}, status: :unprocessable_entity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d6454a6505e4807ea950b1eb8fa6e5b716236cfd">
  <div class="header">
    <h3>app/controllers/pages_controller.rb</h3>
    <h4><span class="red">26.19 %</span> covered</h4>
    <div>
      <b>42</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>31</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class PagesController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include PermissionsHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!, except: :home</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :load_requests_orders_and_lists, only: [:dashboard]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def dashboard</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @pos = PurchaseOrderDecorator.decorate_collection @pos</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @requests_and_orders = @prs + @pos</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    @requests_and_orders = @requests_and_orders.sort_by {|ro| ro.state }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def setup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def spend_vs_budgets_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    time_from = params[:range] == &#39;year&#39; ? Time.now.beginning_of_year : Time.now.beginning_of_month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @budget_spend_data = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      data: { budget:[], spend: []},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      categories: []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    Category.includes(:items).load.each do |category|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      item_ids = category.item_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      next if item_ids.count == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      spend  = PurchaseReceipt.include_items(item_ids).where(created_at: time_from..Time.now).map{ |receipt| receipt.total(item_ids) }.reduce(&amp;:+).to_f</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      budget = category.budgets.where(created_at: Time.now.beginning_of_year..Time.now).sum(:amount).to_f</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      next if !spend &amp;&amp; !budget</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      @budget_spend_data[:categories] &lt;&lt; category.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      @budget_spend_data[:data][:budget] &lt;&lt; budget</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      @budget_spend_data[:data][:spend] &lt;&lt; spend</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    render json: @budget_spend_data.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def home</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    if user_signed_in?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      if current_user.corporate? &amp;&amp; Property.current.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        redirect_to :corporate_root</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      elsif current_user.permission_attributes.level2.access_attributes.count == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        redirect_to priority_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      elsif policy(:access).maintenance?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        redirect_to :maintenance_root</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        redirect_to dashboard_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      render layout: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_requests_orders_and_lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    @prs = PurchaseRequest.order(updated_at: :asc).without_inventory_finished.where.not(state: &#39;ordered&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    @pos = PurchaseOrder.order(updated_at: :asc).where(closed_at: nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    if current_user.current_property_role == Role.manager</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      @prs = @prs.where(user: current_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      @pos = @pos.where(&quot;user_id=? OR purchase_request_id IN (?)&quot;, current_user.id, current_user.purchase_request_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      @lists = List.where(user: current_user).top_six_for_user(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      @lists = List.top_six_for_user(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c55421a31395a6ae720d968ead20cea1630f40e2">
  <div class="header">
    <h3>app/controllers/properties_controller.rb</h3>
    <h4><span class="red">33.33 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class PropertiesController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    @property = user_properties.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    session[:property_id] = @property.try(:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    info = t(&quot;controllers.properties.property_changed&quot;, name: @property.name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    flash[:info]  = t(&quot;controllers.properties.content_may_have_changed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    respond_with @property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    authorize! :settings, Property</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @property = current_user.all_properties.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @property.update_attributes(property_attributes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    respond_with @property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    @properties = user_properties</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    session[:property_id] = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    flash[:info]  = t(&quot;controllers.properties.no_properties_selected&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    respond_with @properties</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def property_attributes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    params.require(:property).permit :name, :contact_name, :street_address, :zip_code,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        :city, :email, :phone, :fax, settings: [:target_inspection_percent]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6f4b65f47733e2bb182266e2ce882e0504d10fb0">
  <div class="header">
    <h3>app/controllers/property_settings_controller.rb</h3>
    <h4><span class="red">37.5 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class PropertySettingsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    @role_id = params[:role_id] || Role.first.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    @department_id = params[:department_id] || Department.order(:name).first.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @filter = params[:filter] || &#39;active&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    authorize :access, :settings?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    add_breadcrumb t(&quot;controllers.property_settings.property_settings&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="db88345277a1aeda5b9b9d0535bb1a8f58a4f05a">
  <div class="header">
    <h3>app/controllers/purchase_orders_controller.rb</h3>
    <h4><span class="red">33.33 %</span> covered</h4>
    <div>
      <b>42</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>28</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;active_support/core_ext/hash/deep_merge&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class PurchaseOrdersController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&quot;purchase_orders.index.name&quot;), :purchase_orders_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authenticate_user!, unless: :pdf_order?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  load_and_authorize_resource except: [:index]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html, :pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def pdf_order?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    request.format.pdf? &amp;&amp; params[:action] == &#39;show&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    authorize! :index, PurchaseOrder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    @purchase_orders = if current_user.current_property_role == Role.manager</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      PurchaseOrder.where(&quot;user_id=? OR purchase_request_id IN (?)&quot;, current_user.id, current_user.purchase_request_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      PurchaseOrder.accessible_by(current_ability)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    @purchase_orders = @purchase_orders.order(created_at: :desc)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @showing_closed  = params[:scope] == &#39;closed&#39; </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    @purchase_orders = @showing_closed ? @purchase_orders.closed : @purchase_orders.not_closed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    @purchase_orders = PurchaseOrderDecorator.decorate_collection( @purchase_orders )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    respond_with @purchase_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    @purchase_order = @purchase_order.decorate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    @emails = [@purchase_order.vendor.email, @purchase_order.purchase_request.user.email, current_user.email].uniq.reject(&amp;:blank?) rescue []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    @item_receipts_per_item = @purchase_order.purchase_receipts.map(&amp;:item_receipts).flatten.group_by(&amp;:item)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    @purchase_request = @purchase_order.purchase_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    @item_orders = @purchase_order.item_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      format.pdf do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        pdf = WickedPdf.new.pdf_from_string(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">                render_to_string(&#39;purchase_orders/pdf.html.slim&#39;, :layout =&gt; &#39;layouts/pdf.html.haml&#39;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">              )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        send_data pdf, type: &#39;application/pdf&#39;, filename: &quot;purchase_order_#{@purchase_order.id}.pdf&quot;, disposition: params[:disposition] || &#39;attachment&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def print</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    @purchase_order = PurchaseOrder.find(params[:id]).decorate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    @purchase_request = @purchase_order.purchase_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    render layout: &#39;print&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    @purchase_order.update_attributes(purchase_order_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    redirect_to purchase_orders_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy # not really</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    @purchase_order.close!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    redirect_to purchase_orders_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def purchase_order_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    params.require(:purchase_order).permit :id, :sent, purchase_receipts_attributes: [:id, item_receipts_attributes: [:id, :item_id, :item_order_id, :quantity, :price]]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f068744f3605d454550a109d5476dfa53c3e4469">
  <div class="header">
    <h3>app/controllers/purchase_receipts_controller.rb</h3>
    <h4><span class="red">31.43 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>24</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class PurchaseReceiptsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&quot;controllers.purchase_receipts.orders&quot;), :purchase_orders_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    @purchase_order = PurchaseOrder.find(params[:purchase_order_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @purchase_receipt = PurchaseReceipt.new(purchase_order: @purchase_order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    authorize! :new, @purchase_receipt</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    add_breadcrumb t(&quot;controllers.purchase_receipts.order&quot;, number: @purchase_order.number), purchase_order_path(@purchase_order) </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    add_breadcrumb t(&quot;controllers.purchase_receipts.receiving&quot;, ordinal: ordinal)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    respond_with @purchase_receipt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @purchase_receipt = PurchaseReceipt.new(purchase_receipt_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    authorize! :create, @purchase_receipt</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @purchase_receipt.property = current_property</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    @purchase_receipt.user = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @purchase_receipt.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    update_item_price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    if @purchase_receipt.purchase_order.complete?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      @purchase_receipt.purchase_order.closed!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      @purchase_receipt.purchase_order.partially_received!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    redirect_to purchase_orders_path, notice: t(&quot;controllers.purchase_receipts.order_received&quot;, number: @purchase_receipt.purchase_order.number)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def purchase_receipt_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    params.require(:purchase_receipt).permit :purchase_order_id, :freight_shipping, item_receipts_attributes: [:id, :item_id, :item_order_id, :quantity, :price]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def ordinal</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    @purchase_receipt.is_first? ? &#39;&#39; : current_receiving_number.ordinalize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_receiving_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    @purchase_order.purchase_receipts.count + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_item_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    @purchase_receipt.item_receipts.each do |ir|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      vendor_item = ir.item.vendor_items.find_by_vendor_id(@purchase_receipt.purchase_order.vendor.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      unless vendor_item.price == ir.price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        vendor_item.price = ir.price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        vendor_item.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e27042dc3f77a1cd93c42b7b7b7fd218ead80da8">
  <div class="header">
    <h3>app/controllers/purchase_requests_controller.rb</h3>
    <h4><span class="red">17.98 %</span> covered</h4>
    <div>
      <b>89</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>73</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class PurchaseRequestsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&quot;purchase_requests.index.name&quot;), :purchase_requests_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  load_and_authorize_resource except: [:index, :edit, :create, :add_message, :messages]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :load_requests, only: [:index]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html, :json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    authorize! :index, PurchaseRequest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    respond_with @purchase_requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    authorize! :create, PurchaseRequest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    @q = Item.search_tree(params[:q])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @items = @q.result(distinct: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    (params[:q] &amp;&amp; params[:q][:lists_id_eq_any] || [] ).each do |list_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      UserListUsage.create(user_id: current_user.id, list_id: list_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    @purchase_request = PurchaseRequest.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    @items.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      @purchase_request.item_requests.build(item: item)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    respond_with @purchase_request do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      format.html {render &#39;inventory&#39;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    authorize! :create, PurchaseRequest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    @purchase_request = PurchaseRequest.new(purchase_request_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    @purchase_request.property = current_property</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    @purchase_request.user = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    @purchase_request.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    @purchase_request.send(params[:commit].gsub(/&amp;/, &#39;and&#39;).parameterize(&#39;_&#39;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    @purchase_request.messages &lt;&lt; Message.where(id: params[:message_ids].split(&#39;,&#39;)) unless params[:message_ids].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    flash[:notice] = &#39;Success&#39; if params[:commit] == &#39;commit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    if params[:commit] == &#39;finish&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      flash[:notice] = I18n.t(&quot;purchase_requests.finish_step_message.finish&quot;, req_number: @purchase_request.number, orders_count: @purchase_request.purchase_orders.count)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      redirect_to :purchase_requests and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    unless params[:print].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      redirect_to inventory_print_purchase_request_path(@purchase_request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      redirect_to edit_purchase_request_path(@purchase_request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    @purchase_request = PurchaseRequest.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    authorize! :edit, @purchase_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    add_breadcrumb I18n.t(&quot;purchase_requests.edit.states.#{ @purchase_request.state }&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    add_breadcrumb I18n.t(&quot;purchase_requests.edit.request_number&quot;, request_number: @purchase_request.number)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    @item_requests = @purchase_request.item_requests</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    @item_requests_grouped = @item_requests.group_by { |ir| ir.order_number } if @purchase_request.ordered?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    respond_with @purchase_request do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      format.html {render @purchase_request.state}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      format.pdf do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        kit = PDFKit.new(render_to_string action: :inventory, layout: false, formats: :html)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        kit.stylesheets &lt;&lt; Rails.root.join(&#39;public&#39;, &#39;stylesheets&#39;, &#39;print.css&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        send_data kit.to_pdf, type: &#39;application/pdf&#39;, filename: &quot;inventory_pr_#{@purchase_request.id}.pdf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    @item_requests = @purchase_request.item_requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    commit = params[:commit]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    original_id = @purchase_request.user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    unless params[:print].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      redirect_to inventory_print_purchase_request_path(@purchase_request) and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    @purchase_request.assign_attributes(purchase_request_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    item_requests_changed = @purchase_request.quantities_changed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    if @purchase_request.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      @purchase_request.send(commit.gsub(/&amp;/, &#39;and&#39;).parameterize(&#39;_&#39;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      approval = @purchase_request.approval_request current_property, current_user if @purchase_request.state == &#39;completed&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      if %w(reject approve commit finish).index(commit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        @purchase_request.create_orders_on_approval!(current_user, current_property) if commit == &#39;approve&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        Notification.purchase_request_approval([@purchase_request.user_id], @purchase_request.id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">          I18n.t(&quot;purchase_requests.completed_with_edits.#{ commit }&quot;, req_number: @purchase_request.number)) if %w(reject approve).index(commit) &amp;&amp; item_requests_changed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        @purchase_request.approve_reject commit, original_id, current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        flash[ commit == &#39;reject&#39; ? :error : :notice ] = I18n.t(&quot;purchase_requests.finish_step_message.#{ commit }&quot;, req_number: @purchase_request.number, orders_count: @purchase_request.purchase_orders.count)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        redirect_to :purchase_requests and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      redirect_to [:edit, @purchase_request]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      render @purchase_request.state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def inventory_print</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    @item_requests = @purchase_request.item_requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    respond_with @purchase_request do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">      format.html {render layout: &#39;print&#39;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_requests</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    @showing_closed = params[:scope] == &#39;closed&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    if current_user.current_property_role == Role.corporate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      @purchase_requests = PurchaseRequest.where(state: &#39;completed&#39;).without_inventory_finished.order(updated_at: :desc)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">        .select{|pr| pr.total_price &gt; current_property.highest_gm_approval_limit }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      @purchase_requests = PurchaseRequest.accessible_by(current_ability).without_inventory_finished.order(updated_at: :desc)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      @purchase_requests = @showing_closed ? @purchase_requests.with_state(:ordered) : @purchase_requests.without_state(:ordered)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">  def purchase_request_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    if params.include? :purchase_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      if params[:purchase_request][:item_requests_attributes]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        params[:purchase_request][:item_requests_attributes].each do |key, ir|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">          if ir[:count].is_a? Array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">            sum = ir[:count].map(&amp;:to_i).reduce(&amp;:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">            ir[:count] = sum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      params.require(:purchase_request).permit :rejection_reason, item_requests_attributes: [:id, :item_id, :quantity, :count, :skip_inventory, :_destroy]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      params.to_hash.delete :utf8</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="29f68bc17fbfb3bcbbaeac00e5d460e240894611">
  <div class="header">
    <h3>app/controllers/reports_controller.rb</h3>
    <h4><span class="red">7.69 %</span> covered</h4>
    <div>
      <b>455</b> relevant lines. 
      <span class="green"><b>35</b> lines covered</span> and
      <span class="red"><b>420</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ReportsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :get_date_range, except: [:index, :favorites, :favorite, :show, :trending_cloud]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  around_filter :action_with_property, except: [:index, :favorites, :favorite, :show]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&quot;controllers.reports.reports&quot;), :reports_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html, :pdf</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  layout false, except: [:index, :favorites, :favorite, :show]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  include MaintenanceHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  include ApplicationHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def favorites</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    authorize Report.new, :index?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    add_breadcrumb t(&quot;controllers.reports.favorites&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @title = t(&quot;controllers.reports.favorite_reports&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    # @reports = current_user.favorite_reports</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    # TODO: show only maintenance reports</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    @reports = current_user.favorite_reports.for_maintenance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    render :index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    authorize Report.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    @title = t(&quot;controllers.reports.reports_listing&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    # TODO: show only maintenance reports</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    # @reports = Report.all</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    # @reports = @reports.for_maintenance if current_user.frontdesk_department?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    @reports = Report.for_maintenance</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  def favorite</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    @report = Report.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    @report.toggle_favorited_by!(current_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    render json: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    @report = Report.find_by(permalink: params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    @report.record_run_by!(current_user)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    add_breadcrumb @report.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    render :show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  def item_price_variance</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      format.json do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        results = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        Item.all.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">          ipv = ItemPriceVariance.new(item, @from..@to)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">          row = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">          row[:item_id]  = item.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">          row[:vendor]   = item.vendor_ids.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">          row[:category] = item.category_ids.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">          row[:lists]    = item.list_ids.join(&#39;,&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">          row[:item_name] = item.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">          row[:num_orders] = ipv.num_orders</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">          next if row[:num_orders] == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">          row[:average_price] = ipv.average_price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">          row[:average_variance] = ipv.average_variance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">          row[:increase] = ipv.increase</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          next if row[:average_variance] == &#39;0&#39; &amp;&amp; row[:increase] == &#39;0&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">          results &lt;&lt; row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        render json: results</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">  def vendor_spend</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      format.json do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        total_spend = PurchaseReceipt.where(created_at: @from..@to).map(&amp;:total_w_freight).reduce(&amp;:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        result = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        Vendor.all.each do |vendor|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          row = {vendor_name: vendor.name }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          receipts = vendor.purchase_receipts.where(created_at: @from..@to)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">          row[:num_orders] = receipts.map(&amp;:purchase_order_id).uniq.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">          spend = receipts.map(&amp;:total_w_freight).reduce(&amp;:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">          next unless spend</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">          row[:spend] = spend.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">          row[:percentage_of_spend] = spend ? spend / total_spend * 100 : 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          result &lt;&lt; row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        render json: result.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">  ### ITEM CONSUMED REPORT ========&gt;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">  def items_consumption</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      format.json do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        result = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        months_count_in_the_range = ((@to - @from).to_f / (24 *60 *60) / 30.44).round # 30.44 avg days number in month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        Item.where(created_at: @from..@to).includes(:purchase_orders, :vendors).load.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          row    = {name: item.name}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">          orders = item.purchase_orders.joins(:purchase_receipts).where(created_at: @from..@to).uniq</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">          next unless orders.any?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">          row[:item_id]  = item.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">          row[:vendor]   = item.vendors.first.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">          row[:category] = item.categories.first.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          row[:lists]    = item.lists.pluck(:name).join(&#39;,&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">          row[:last_inventory_time] = item.purchase_requests.where(created_at: @from..@to).order(created_at: :desc).limit(1).first.try(:created_at)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          row[:avg_monthly_orders]  = (orders.count.to_f / months_count_in_the_range * 100).round / 100.0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">          item_receipts             = item.item_receipts.where(created_at: @from..@to)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">          row[:avg_order_qty]  = &quot;#{ (item_receipts.sum(:quantity) / orders.count.to_f * 100).round / 100.0 } &lt;br&gt;&lt;span class=&#39;text-muted semibold&#39;&gt;#{ item.unit.name }&lt;/span&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">          row[:avg_order_cost] = item_receipts.any? ? &quot;#{I18n.t :currency}#{ (item_receipts.map(&amp;:total).map(&amp;:to_f).inject(&amp;:+) / orders.count.to_f * 100).round / 100.0 }&quot; : &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          result &lt;&lt; row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        render json: result.to_json</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">  def item_orders_chart_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    # @to - @from &lt;-- current period selected, for the chart we need to consider it and 5 periods (of the same size) before</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    result = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    item = Item.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    months_count_in_the_range = ((@to - @from).to_f / (24 *60 *60) / 30.44).round # 30.44 avg days number in month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    periods_count = {3 =&gt; 5, 6 =&gt; 3, 12 =&gt; 2}[months_count_in_the_range]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    chart_data_start = @from - (months_count_in_the_range * periods_count).month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">    chart_date_check_point = chart_data_start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    while(chart_date_check_point &lt; @to)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">      orders = item.purchase_orders.joins(:purchase_receipts).where(created_at: chart_date_check_point..chart_date_check_point + months_count_in_the_range.month)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      result &lt;&lt; [chart_date_check_point, orders.count]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      chart_date_check_point += months_count_in_the_range.month</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    render json: result.to_json</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">  ### &lt;======== ITEM CONSUMED REPORT</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">  def category_spend</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      format.json do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">        total_spend = PurchaseReceipt.where(created_at: @from..@to).map(&amp;:total_w_freight).reduce(&amp;:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">        result = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">        Category.includes(:items).load.each do |category|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">          item_ids = category.item_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">          next if item_ids.count == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          row = {category_name: category.name }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">          receipts = PurchaseReceipt.include_items(item_ids).where(created_at: @from..@to)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">          row[:num_orders] = receipts.map(&amp;:purchase_order_id).uniq.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">          spend = receipts.map { |receipt| receipt.total(item_ids) }.reduce(&amp;:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">          next unless spend</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">          row[:spend] = spend.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">          row[:percentage_of_spend] = spend / total_spend * 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">          result &lt;&lt; row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">        render json: result.to_json</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">  def items_spend</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      format.json do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">        total_spend = PurchaseReceipt.where(created_at: @from..@to).map(&amp;:total_w_freight).reduce(&amp;:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        result = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">        Item.all.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">          row = {name: item.name }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">          receipts = PurchaseReceipt.include_items([item.id]).where(created_at: @from..@to)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">          row[:num_orders] = receipts.map(&amp;:purchase_order_id).uniq.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">          spend = receipts.map { |receipt| receipt.total([item.id]) }.reduce(&amp;:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">          next unless spend</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">          row[:spend] = spend.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">          row[:percentage_of_spend] = spend * 100 / total_spend</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">          result &lt;&lt; row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        render json: result.to_json</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">  def inventory_vs_ordering</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">      format.json do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">        results = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">        Item.all.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">          ivo = InventoryVsOrdering.new(item, @from..@to)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">          row = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">          row[:item_id]  = item.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">          row[:locations] = item.location_ids.join(&#39;,&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">          row[:category] = item.category_ids.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">          row[:lists]  = item.list_ids.join(&#39;,&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">          row[:item_name] = item.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">          row[:avg_orders] = ivo.average_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">          row[:avg_counts] = ivo.average_counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">          next if row[:avg_orders] == &#39;0.00&#39; and row[:avg_counts] == &#39;0.00&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">          row[:last_count_at] = ivo.last_count_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">          row[:last_order_at] = ivo.last_order_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">          results &lt;&lt; row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">        render json: results</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">  def maintenance_work_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">    unless request.format.html?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      @results = Maintenance::WorkOrder.all.order_by_priority</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">      if params[:date_range].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">        @results = @results.where(created_at: @from..@to)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">                    .includes([:opened_by, :closed_by, :maintainable, :assigned_to, :material_items,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">                               materials: [:item],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">                               checklist_item_maintenance: [:maintenance_checklist_item]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">                              ])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      @results = @results.map do |wo|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">        data = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">          id: wo.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">          number: wo.number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">          description: wo.description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">          priority: t(&quot;reports.work_order_trendings.priority.#{wo.priority}&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">          opened_by_name: wo.opened_by.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">          location_name: wo.location_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">          status: work_order_status_labels[wo.status.to_sym],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">          type: wo.maintainable_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">          priority_value: wo.priority,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">          days_opened: wo.days_opened,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">          is_unassigned: wo.assigned_to_id == Maintenance::WorkOrder::UNASSIGNED,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">          assigned_to_name: work_order_assigned_to(wo),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">          materials_exists: wo.materials.count &gt; 0,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">          material_items: wo.materials.map do |m|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">            {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">              quantity: quantity_format(m.quantity),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">              unit: m.item.inventory_unit.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">              name: m.item.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">          end,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">          materials_cost: humanized_currency_format(wo.material_total),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">          detail_exists: wo.materials.count &gt; 0 || wo.closing_comment.present? || wo.duration.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">        if wo.status == Maintenance::WorkOrder::STATUS_CLOSED.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">          data.merge! ({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">                        closed_by_name: wo.closed_by.try(:name),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">                        closed_on: wo.closed_at ? l(wo.closed_at, format: :short) : nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">                        closing_comment: wo.closing_comment,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">                        duration: minutes_to_hours(wo.duration),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">                        closed_same_day: wo.days_elapsed == 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">                        days_elapsed: wo.days_elapsed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">                      })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">          data.merge! ({</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">                        due_to_date: wo.due_to_date ? l(wo.due_to_date, format: :short) : nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">                      })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">        data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">        format.json do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">          render json: @results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">        format.pdf do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">          title = format(&#39;Work Order Listing Report&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">          @results = @results.select do |wo|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">            (params[:status].blank? || params[:status].include?(wo[:status])) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">              (params[:priority].blank? || params[:priority].include?(wo[:priority_value])) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">              (params[:location].blank? || params[:location] == wo[:type]) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">              (params[:checklist].blank? || !(Regexp.new(params[:checklist].join(&#39;|&#39;)) =~ wo[:location_name]).nil? )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">          render pdf: title,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">                 template: &#39;reports/pdf/maintenance_work_orders&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">                 layout: &#39;layouts/pdf.html.haml&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">                 header: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">                   html: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">                     template: &#39;reports/pdf/header&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">                     locals: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">                       report_title: title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">                     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">                   },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">                   spacing: -10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">                 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">                 footer: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">                   center: &#39;[page] of [topage]&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">                 }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">  def maintenance_pm_productivity_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">    maintenance_records = Maintenance::MaintenanceRecord.finished</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    maintenance_records = maintenance_records.where(started_at: @from..@to) if params[:date_range].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">    if params[:location].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">      maintainable_type = params[:location] == &quot;Other&quot; ? nil : params[:location]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">      maintenance_records = maintenance_records.where(maintainable_type: maintainable_type)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">    records_duration_data = maintenance_records.map(&amp;:minutes_to_complete)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">    duration_ranges = [[0, 15], [15,30], [30,45], [45,60], [60,75], [75, nil]]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">    data = duration_ranges.map do |range|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">      if range.last.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">        label = &quot;&lt;strong&gt;#{range.first}-more&lt;/strong&gt;&lt;br/&gt;\n minutes&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">        value = records_duration_data.count{ |duration| duration &gt; range.first  } </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">      else </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">        label = &quot;&lt;strong&gt;#{range.first}-#{range.last}&lt;/strong&gt;&lt;br/&gt;\n minutes&quot; </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">        value = records_duration_data.count{ |duration| duration &gt; range.first and duration &lt;= range.last  } </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">      [label, value]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">    results = [{ &quot;label&quot; =&gt; &quot;Completed Room PM Count&quot;,&quot;color&quot; =&gt; &quot;#00B1E1&quot;,&quot;data&quot; =&gt; data }]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">    render json: results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">  def room_pm_progress_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">    if params[:date_range] == &quot;month&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">      date_range = (Date.today.end_of_month - ((@dates_offset + 1) * 6).months + 1.day .. Date.today.end_of_month - (@dates_offset * 6).months)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">      maintenance_records = Maintenance::MaintenanceRecord.for_rooms.finished.group_by_month(:started_at, range: date_range).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">      label_format = &quot;&lt;strong&gt;%b&lt;/strong&gt;&lt;br/&gt;\n %Y&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">      data = maintenance_records.map{ |record| [ record[0].strftime(label_format), record[1] ] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">    elsif params[:date_range] == &quot;week&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">      date_range = (Date.today.end_of_week - ((@dates_offset + 1) * 4).weeks + 1.day .. Date.today.end_of_week - (@dates_offset * 4).weeks)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">      maintenance_records = Maintenance::MaintenanceRecord.for_rooms.finished.group_by_week(:started_at, range: date_range).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">      label_format = lambda{ |date| &quot;&lt;strong&gt;#{ date.strftime(&quot;%b %d&quot;) } - #{ date.end_of_week.strftime(&quot;%b %d&quot;) }&lt;/strong&gt;&lt;br/&gt;\n #{ date.strftime(&quot;%Y&quot;) }&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">      data = maintenance_records.map{ |record| [ label_format.call(record[0]), record[1] ] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">    elsif params[:date_range] == &quot;quarter&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">      data = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">      period_start = Date.today.beginning_of_year - params[:offset].to_i.years</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">      4.times do |i|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">        maintenance_records_count = Maintenance::MaintenanceRecord.where(created_at: period_start..period_start + 3.month).for_rooms.finished.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">        label = &quot;&lt;strong&gt;#{i + 1}&lt;/strong&gt;&lt;br/&gt;\n #{period_start.year}&quot; </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">        data &lt;&lt; [label,maintenance_records_count]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">        period_start += 3.month</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="349">
          <span class="hits">1</span>
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">    results = [{ &quot;label&quot; =&gt; &quot;Room Pm Progress&quot;,&quot;color&quot; =&gt; &quot;#00B1E1&quot;,&quot;data&quot; =&gt; data }]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">    render json: results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">  def work_order_productivity_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">    if params[:date_range] == &quot;month&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby">      date_range = (Date.today.end_of_month - ((@dates_offset + 1) * 6).months + 1.day .. Date.today.end_of_month - (@dates_offset * 6).months)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">      opened_work_orders = Maintenance::WorkOrder.group_by_month(:created_at, range: date_range).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">      closed_work_orders = Maintenance::WorkOrder.closed.group_by_month(:updated_at, range: date_range).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">      label_format = &quot;&lt;strong&gt;%b&lt;/strong&gt;&lt;br/&gt;\n %Y&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">      opened_data  = opened_work_orders.map{   |record| [ record[0].strftime(label_format), record[1] ] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">      close_data = closed_work_orders.map{ |record| [ record[0].strftime(label_format), record[1] ] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">    elsif params[:date_range] == &quot;week&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">      date_range = (Date.today.end_of_week - ((@dates_offset + 1) * 4).weeks + 1.day .. Date.today.end_of_week - (@dates_offset * 4).weeks)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">      opened_work_orders = Maintenance::WorkOrder.group_by_week(:created_at, range: date_range).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">      closed_work_orders = Maintenance::WorkOrder.closed.group_by_week(:updated_at, range: date_range).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">      label_format = lambda{ |date| &quot;&lt;strong&gt;#{ date.strftime(&quot;%b %d&quot;) } - #{ date.end_of_week.strftime(&quot;%b %d&quot;) }&lt;/strong&gt;&lt;br/&gt;\n #{ date.strftime(&quot;%Y&quot;) }&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">      opened_data  = opened_work_orders.map{   |record| [ label_format.call(record[0]), record[1] ] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">      close_data = closed_work_orders.map{ |record| [ label_format.call(record[0]), record[1] ] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">    elsif params[:date_range] == &quot;quarter&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">      opened_data,close_data = [],[]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">      period_start = Date.today.beginning_of_year - params[:offset].to_i.years</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">      4.times do |i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">        date_range = period_start..period_start + 3.month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">        opened_work_orders = Maintenance::WorkOrder.where(created_at: date_range)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">        closed_work_orders = Maintenance::WorkOrder.closed.where(updated_at: date_range)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">        label = &quot;&lt;strong&gt;#{i + 1}&lt;/strong&gt;&lt;br/&gt;\n #{period_start.year}&quot; </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">        opened_data &lt;&lt; [label, opened_work_orders.count ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">        close_data &lt;&lt; [label, closed_work_orders.count ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">        period_start += 3.month</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">    #results = [{ &quot;label&quot; =&gt; &quot;Work Order Productivity&quot;,&quot;color&quot; =&gt; &quot;#00B1E1&quot;,&quot;data&quot; =&gt; data }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">    results = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">      {color: &quot;#f0ad4e&quot;, data: opened_data, bars: {order: 2, align: &quot;left&quot;}, label: &quot;Work Orders Opened&quot;},</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="388">
          <span class="hits">1</span>
          
          <code class="ruby">      {color: &quot;#4cae4c&quot;, data: close_data, bars: {order: 1, align: &quot;left&quot;}, label: &quot;Work Orders Fixed&quot;}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">    render json: results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">  def guest_room_pm_analysis</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">    if request.format.html? # Query all data only if report_type exists. In case of html request, report_type is nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">      if current_cycle.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">        respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">          format.json { render json: &#39;Current cycle does not exist&#39; , status: :unprocessable_entity }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">        set_property_info(:room)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">        @rooms = Maintenance::Room.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">        @results = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">        if params[:report_type] == &#39;cyclely&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">          unless params[:property_switched].present? # if property_switched, ignore cycle param and return current cycle data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">            @cycle = Maintenance::Cycle.by_cycle_type(:room).offset(params[:cycle]).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">          @cycle ||= current_cycle</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">          @results = get_room_pm_data_by_cycle(@cycle, @rooms)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">          @remaining_rooms = @results.select { |r| r[:status] == :_remaining }.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">          respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">            format.json { render json: { result: @results, cycle: {number: @cycle.ordinality_number, period: @cycle.period} } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">            format.csv  { }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">            format.pdf do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">              title = format(&quot;Guest Room PM Analysis - Cycle #{@cycle.ordinality_number} (#{@cycle.period})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">              render pdf: title,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">                     template: &#39;reports/pdf/guest_room_pm_analysis_cycle&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">                     layout: &#39;layouts/pdf.html.haml&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">                     header: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby">                       html: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">                         template: &#39;reports/pdf/header&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">                         locals: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">                           report_title: title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">                         }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby">                       },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby">                       spacing: -10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">                     },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">                     footer: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">                       center: &#39;[page] of [topage]&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">                     }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">        elsif params[:report_type] == &#39;yearly&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">          cycles = Maintenance::Cycle.by_year(params[:year]).by_cycle_type(:room)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">          missing_rooms = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">          total_rooms = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">          cycles.each_with_index do |cycle|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">            @results.push({</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">                            ordinality_number: cycle.ordinality_number,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="444">
          
          
          <code class="ruby">                            data: get_room_pm_data_by_cycle(cycle, @rooms)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="445">
          
          
          <code class="ruby">                          })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="446">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">          previous_cycle_data = @results.last(2).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">          missing_rooms = previous_cycle_data[:data].select { |r| r[:status] == :_remaining }.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">          total_rooms = previous_cycle_data[:data].count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">          @previous_quarter_completion = (1 - missing_rooms / total_rooms.to_f) * 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">          current_cycle_data = @results.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="453">
          
          
          <code class="ruby">          missing_rooms = current_cycle_data[:data].select { |r| r[:status] == :_remaining }.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">          total_rooms = current_cycle_data[:data].count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="455">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">          @current_quarter_completion = (1 - missing_rooms / total_rooms.to_f) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">          respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">            format.json { render json: {result: @results, cycle: {year: current_cycle(:room).year, number: current_cycle(:room).ordinality_number}} }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby">            format.csv  { }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">            format.pdf do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">              title = format(&quot;Guest Room PM Analysis Yearly Report&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">              render pdf: title,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">                     template: &#39;reports/pdf/guest_room_pm_analysis_year&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">                     layout: &#39;layouts/pdf.html.haml&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">                     header: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">                       html: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">                         template: &#39;reports/pdf/header&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">                         locals: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">                           report_title: title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">                         }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">                       },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">                       spacing: -10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">                     },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">                     footer: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby">                       center: &#39;[page] of [topage]&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">                     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="480">
          <span class="hits">1</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="483">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="485">
          
          
          <code class="ruby">  def public_area_pm_analysis</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">    if request.format.html? # Query all data only if report_type exists. In case of html request, report_type is nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="488">
          
          
          <code class="ruby">      if current_cycle(:public_area).nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby">        respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="490">
          
          
          <code class="ruby">          format.json { render json: &#39;Current cycle does not exist&#39; , status: :unprocessable_entity }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="492">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">        set_property_info(:public_area)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="494">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="495">
          
          
          <code class="ruby">        @areas = Maintenance::PublicArea.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="496">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">        @results = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="498">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="499">
          
          
          <code class="ruby">        if params[:report_type] == &#39;cyclely&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="500">
          
          
          <code class="ruby">          unless params[:property_switched].present? # if property_switched, ignore cycle param and return current cycle data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby">            @cycle = Maintenance::Cycle.by_cycle_type(:public_area).offset(params[:cycle]).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="502">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="503">
          
          
          <code class="ruby">          @cycle ||= current_cycle(:public_area)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="504">
          
          
          <code class="ruby">          @results = get_public_area_pm_data_by_cycle(@cycle, @areas)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="505">
          
          
          <code class="ruby">          @remaining_areas = @results.select { |r| r[:status] == :_remaining }.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="506">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="507">
          
          
          <code class="ruby">          respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">            format.json { render json: { result: @results, cycle: {number: @cycle.ordinality_number, period: @cycle.period} } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby">            format.csv  { }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="510">
          
          
          <code class="ruby">            format.pdf do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="511">
          
          
          <code class="ruby">              title = &quot;Public Area PM Analysis - Cycle C#{@cycle.ordinality_number} (#{@cycle.period})&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">              render pdf: title,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby">                     template: &#39;reports/pdf/public_area_pm_analysis_cycle&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="514">
          
          
          <code class="ruby">                     layout: &#39;layouts/pdf.html.haml&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby">                     header: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">                       html: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby">                         template: &#39;reports/pdf/header&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby">                         locals: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="519">
          
          
          <code class="ruby">                           report_title: title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="520">
          
          
          <code class="ruby">                         }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby">                       },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="522">
          
          
          <code class="ruby">                       spacing: -10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="523">
          
          
          <code class="ruby">                     },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="524">
          
          
          <code class="ruby">                     footer: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="525">
          
          
          <code class="ruby">                       center: &#39;Page [page] of [topage]&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="526">
          
          
          <code class="ruby">                     }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="527">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="528">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="529">
          
          
          <code class="ruby">        elsif params[:report_type] == &#39;yearly&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="530">
          
          
          <code class="ruby">          cycles = Maintenance::Cycle.by_year(params[:year]).by_cycle_type(:public_area).last(6)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="531">
          
          
          <code class="ruby">          missing_areas = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby">          total_areas = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="534">
          
          
          <code class="ruby">          cycles.each_with_index do |cycle|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby">            @results.push({</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="536">
          
          
          <code class="ruby">                            ordinality_number: cycle.ordinality_number,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="537">
          
          
          <code class="ruby">                            data: get_public_area_pm_data_by_cycle(cycle, @areas)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="538">
          
          
          <code class="ruby">                          })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="539">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="540">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="541">
          
          
          <code class="ruby">          previous_cycle_data = @results.last(2).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="542">
          
          
          <code class="ruby">          missing_areas = previous_cycle_data[:data].select { |r| puts r; r[:status] == :_remaining }.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="543">
          
          
          <code class="ruby">          total_areas = previous_cycle_data[:data].count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="544">
          
          
          <code class="ruby">          @previous_cycle_completion = (1 - missing_areas / total_areas.to_f) * 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="545">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">          current_cycle_data = @results.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="547">
          
          
          <code class="ruby">          missing_areas = current_cycle_data[:data].select { |r| r[:status] == :_remaining }.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="548">
          
          
          <code class="ruby">          total_areas = current_cycle_data[:data].count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="549">
          
          
          <code class="ruby">          @current_cycle_completion = (1 - missing_areas / total_areas.to_f) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="550">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="551">
          
          
          <code class="ruby">          respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby">            format.json { render json: {result: @results, cycle: {year: current_cycle(:public_area).year, number: current_cycle(:public_area).ordinality_number}} }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="553">
          
          
          <code class="ruby">            format.csv  { }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby">            format.pdf do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="555">
          
          
          <code class="ruby">              title = format(&quot;Public Area PM Room Analysis Yearly Report&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="556">
          
          
          <code class="ruby">              render pdf: title,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby">                     template: &#39;reports/pdf/public_area_pm_analysis_year&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="558">
          
          
          <code class="ruby">                     layout: &#39;layouts/pdf.html.haml&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="559">
          
          
          <code class="ruby">                     header: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="560">
          
          
          <code class="ruby">                       html: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="561">
          
          
          <code class="ruby">                         template: &#39;reports/pdf/header&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="562">
          
          
          <code class="ruby">                         locals: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="563">
          
          
          <code class="ruby">                           report_title: title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="564">
          
          
          <code class="ruby">                         }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="565">
          
          
          <code class="ruby">                       },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="566">
          
          
          <code class="ruby">                       spacing: -10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="567">
          
          
          <code class="ruby">                     },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="568">
          
          
          <code class="ruby">                     footer: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby">                       center: &#39;[page] of [topage]&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="570">
          
          
          <code class="ruby">                     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="571">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="572">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="573">
          <span class="hits">1</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="574">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="575">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="576">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="577">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="578">
          
          
          <code class="ruby">  def equipment_pm_analysis</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby">    unless request.format.html?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby">      @filter_range = params[:filter_range] || &#39;Quarter&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">      @equipments = Maintenance::Equipment.active.joins(:equipment_type).merge(Maintenance::EquipmentType.active).reorder(&#39;maintenance_equipment_types.row_order ASC, maintenance_equipment.row_order ASC&#39;).map do |equipment|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="582">
          
          
          <code class="ruby">        records = equipment.maintenance_records.finished.where(completed_on: @from..@to).map do |record|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="583">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="584">
          
          
          <code class="ruby">            checklist_group_id: record.equipment_checklist_group_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby">            checklist_group_name: record.equipment_checklist_group.name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="586">
          
          
          <code class="ruby">            checklist_group_frequency: record.equipment_checklist_group.frequency_text,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="587">
          
          
          <code class="ruby">            fixes: record.checklist_item_maintenances.fixed.count,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="588">
          
          
          <code class="ruby">            issues: record.checklist_item_maintenances.issues.count,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="589">
          
          
          <code class="ruby">            inspected: record.status == Maintenance::MaintenanceRecord::STATUS_COMPLETED,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="590">
          
          
          <code class="ruby">            completed_on: record.completed_on</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="593">
          
          
          <code class="ruby">        records = records.group_by { |r|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="594">
          
          
          <code class="ruby">          @filter_range == &#39;Quarter&#39; ?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="595">
          
          
          <code class="ruby">            r[:completed_on].beginning_of_month.strftime(&#39;%B&#39;) :</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="596">
          
          
          <code class="ruby">            &quot;Week #{r[:completed_on].to_date.day / 7 + 1}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="598">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="599">
          
          
          <code class="ruby">          id: equipment.id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="600">
          
          
          <code class="ruby">          name: equipment.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby">          type_id: equipment.equipment_type.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="602">
          
          
          <code class="ruby">          type_name: equipment.equipment_type.name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="603">
          
          
          <code class="ruby">          location: equipment.location,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="604">
          
          
          <code class="ruby">          maintenance_records: records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="605">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="606">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="607">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="608">
          
          
          <code class="ruby">      data = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="609">
          
          
          <code class="ruby">      if params[:property_switched] == &#39;true&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="610">
          
          
          <code class="ruby">        data = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="611">
          
          
          <code class="ruby">          data: @equipments.to_json,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby">          groups: Maintenance::EquipmentChecklistItem.checklist_groups.select([:equipment_type_id, :id, :name]).map(&amp;:serializable_hash).to_json,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="613">
          
          
          <code class="ruby">          types: Maintenance::EquipmentType.active.includes(:equipments).merge(Maintenance::Equipment.active).to_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="614">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="615">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="616">
          
          
          <code class="ruby">      data ||= @equipments.to_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="617">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="618">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="619">
          
          
          <code class="ruby">        format.json { render json: data }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="620">
          
          
          <code class="ruby">        format.pdf do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="621">
          
          
          <code class="ruby">          title = format(&quot;Equipment PM Analysis Report&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="622">
          
          
          <code class="ruby">          date = @from</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby">          @steps = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="624">
          
          
          <code class="ruby">          while date &lt; @to do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="625">
          
          
          <code class="ruby">            step = @filter_range == &#39;Quarter&#39; ? date.strftime(&#39;%B&#39;) : &quot;Week #{date.strftime(&#39;%U&#39;).to_i - @from.strftime(&#39;%U&#39;).to_i + 1}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="626">
          
          
          <code class="ruby">            @steps.push step</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="627">
          
          
          <code class="ruby">            @filter_range == &#39;Quarter&#39; ? date += 1.months : date += 1.weeks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="628">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">          @selected_groups = (params[:groups] || []).map(&amp;:to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="630">
          
          
          <code class="ruby">          @selected_types = (params[:types] || []).map(&amp;:to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby">          @sgroups = Maintenance::EquipmentChecklistItem.where(id: @selected_groups).group_by(&amp;:equipment_type_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="632">
          
          
          <code class="ruby">          @stypes = Maintenance::EquipmentType.where(id: @selected_types)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="633">
          
          
          <code class="ruby">          render pdf: title,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="634">
          
          
          <code class="ruby">                 template: &#39;reports/pdf/equipment_pm_analysis&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="635">
          
          
          <code class="ruby">                 layout: &#39;layouts/pdf.html.haml&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="636">
          
          
          <code class="ruby">                 header: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="637">
          
          
          <code class="ruby">                   html: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="638">
          
          
          <code class="ruby">                     template: &#39;reports/pdf/header&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="639">
          
          
          <code class="ruby">                     locals: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="640">
          
          
          <code class="ruby">                       report_title: title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="641">
          
          
          <code class="ruby">                     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="642">
          
          
          <code class="ruby">                   },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="643">
          
          
          <code class="ruby">                   spacing: -10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="644">
          
          
          <code class="ruby">                 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="645">
          
          
          <code class="ruby">                 footer: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="646">
          
          
          <code class="ruby">                   center: &#39;[page] of [topage]&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="647">
          
          
          <code class="ruby">                 }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="648">
          <span class="hits">1</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="649">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="650">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="651">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="652">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="653">
          
          
          <code class="ruby">  def trending_cloud</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="654">
          
          
          <code class="ruby">    @from = params[:from] || (Date.today - 3.months).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="655">
          
          
          <code class="ruby">    @from = Date.parse(@from).beginning_of_day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="656">
          
          
          <code class="ruby">    @to   = params[:to] || Date.today.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="657">
          
          
          <code class="ruby">    @to   = Date.parse(@to).end_of_day</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="658">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="659">
          
          
          <code class="ruby">    wo_data = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="660">
          
          
          <code class="ruby">    cim_data = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby">    ActiveRecord::lax_includes do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="662">
          
          
          <code class="ruby">      work_orders = Maintenance::WorkOrder.where(created_at: @from..@to)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="663">
          
          
          <code class="ruby">                      .includes(maintainable: :equipment_type)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="664">
          
          
          <code class="ruby">                      .includes(checklist_item_maintenance: :maintenance_checklist_item)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="665">
          
          
          <code class="ruby">      wo_data = JSON.parse(work_orders.to_json(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="666">
          
          
          <code class="ruby">                          only: [:id, :maintainable_type],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="667">
          
          
          <code class="ruby">                          methods: [:maintainable_name, :checklist_item_name, :trending_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="668">
          
          
          <code class="ruby">                        ))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="669">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="670">
          
          
          <code class="ruby">      checklist_item_fixes =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="671">
          
          
          <code class="ruby">        Maintenance::ChecklistItemMaintenance.fixed.where(created_at: @from..@to)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="672">
          
          
          <code class="ruby">          .includes(maintenance_record: {maintainable: :equipment_type})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="673">
          
          
          <code class="ruby">          .includes(:maintenance_checklist_item)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="674">
          
          
          <code class="ruby">      cim_data = JSON.parse(checklist_item_fixes.to_json(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="675">
          
          
          <code class="ruby">                           only: [:id],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="676">
          
          
          <code class="ruby">                           methods: [:maintainable_type, :maintainable_name, :checklist_item_name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="677">
          
          
          <code class="ruby">                         ))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="678">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="679">
          
          
          <code class="ruby">    trends = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="680">
          
          
          <code class="ruby">    wo_data.each do |e|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="681">
          
          
          <code class="ruby">      if e[&#39;maintainable_name&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="682">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]] ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="683">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;ids&#39;] ||= {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="684">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;ids&#39;][&#39;wos&#39;] ||= []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="685">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;ids&#39;][&#39;trending_ids&#39;] ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="686">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;ids&#39;][&#39;wos&#39;] &lt;&lt; e[&#39;id&#39;] if e[&#39;id&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="687">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;weight&#39;] ||= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="688">
          
          
          <code class="ruby">        unless trends[e[&#39;maintainable_name&#39;]][&#39;ids&#39;][&#39;trending_ids&#39;].include?(e[&#39;trending_id&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="689">
          
          
          <code class="ruby">          trends[e[&#39;maintainable_name&#39;]][&#39;weight&#39;] = trends[e[&#39;maintainable_name&#39;]][&#39;weight&#39;] + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="690">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="691">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;ids&#39;][&#39;trending_ids&#39;] &lt;&lt; e[&#39;trending_id&#39;] if e[&#39;trending_id&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="692">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;location_trend&#39;] = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="693">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="694">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="695">
          
          
          <code class="ruby">      if e[&#39;maintainable_type&#39;] != &#39;Other&#39; &amp;&amp; e[&#39;checklist_item_name&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="696">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]] ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="697">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;ids&#39;] ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="698">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;ids&#39;][&#39;wos&#39;] ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="699">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;ids&#39;][&#39;trending_ids&#39;] ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="700">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;ids&#39;][&#39;wos&#39;] &lt;&lt; e[&#39;id&#39;] if e[&#39;id&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="701">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;weight&#39;] ||= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="702">
          
          
          <code class="ruby">        unless trends[e[&#39;checklist_item_name&#39;]][&#39;ids&#39;][&#39;trending_ids&#39;].include?(e[&#39;trending_id&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="703">
          
          
          <code class="ruby">          trends[e[&#39;checklist_item_name&#39;]][&#39;weight&#39;] = trends[e[&#39;checklist_item_name&#39;]][&#39;weight&#39;] + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="704">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="705">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;ids&#39;][&#39;trending_ids&#39;] &lt;&lt; e[&#39;trending_id&#39;] if e[&#39;trending_id&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="706">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;location_trend&#39;] = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="707">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="708">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="709">
          
          
          <code class="ruby">    cim_data.each do |e|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="710">
          
          
          <code class="ruby">      if e[&#39;maintainable_name&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="711">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]] ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="712">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;weight&#39;] ||= 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="713">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;weight&#39;] = trends[e[&#39;maintainable_name&#39;]][&#39;weight&#39;] + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="714">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;ids&#39;] ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="715">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;ids&#39;][&#39;cim&#39;] ||= []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="716">
          
          
          <code class="ruby">        trends[e[&#39;maintainable_name&#39;]][&#39;ids&#39;][&#39;cim&#39;] &lt;&lt; e[&#39;id&#39;] if e[&#39;id&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="717">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="718">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="719">
          
          
          <code class="ruby">      if e[&#39;maintainable_type&#39;] != &#39;Other&#39; &amp;&amp; e[&#39;checklist_item_name&#39;].present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="720">
          <span class="hits">1</span>
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]] ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="721">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;weight&#39;] ||= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="722">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;weight&#39;] = trends[e[&#39;checklist_item_name&#39;]][&#39;weight&#39;] + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="723">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;ids&#39;] ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="724">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;ids&#39;][&#39;cim&#39;] ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="725">
          
          
          <code class="ruby">        trends[e[&#39;checklist_item_name&#39;]][&#39;ids&#39;][&#39;cim&#39;] &lt;&lt; e[&#39;id&#39;] if e[&#39;id&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="726">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="727">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="728">
          
          
          <code class="ruby">    data = trends.collect { |k, v| {text: k}.merge!(v) }.sort_by { |a| -a[&#39;weight&#39;] }[0..19]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="729">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="730">
          
          
          <code class="ruby">    render json: data.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="731">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="732">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="733">
          
          
          <code class="ruby">  def work_order_trendings</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="734">
          
          
          <code class="ruby">    unless request.format.html?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="735">
          
          
          <code class="ruby">      if params[:wo_ids]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="736">
          
          
          <code class="ruby">        work_orders = Maintenance::WorkOrder.includes(:opened_by).order_by_priority</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="737">
          
          
          <code class="ruby">        work_orders = work_orders.where(id: params[:wo_ids])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="738">
          
          
          <code class="ruby">        work_orders = work_orders.map do |wo|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="739">
          
          
          <code class="ruby">          data = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="740">
          
          
          <code class="ruby">            id: wo.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="741">
          
          
          <code class="ruby">            number: wo.number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="742">
          
          
          <code class="ruby">            description: wo.description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="743">
          
          
          <code class="ruby">            priority: t(&quot;reports.work_order_trendings.priority.#{wo.priority}&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="744">
          
          
          <code class="ruby">            opened_by_name: wo.opened_by.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="745">
          
          
          <code class="ruby">            location_name: wo.location_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby">            status: work_order_status_labels[wo.status.to_sym],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="747">
          
          
          <code class="ruby">            type: wo.maintainable_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="748">
          
          
          <code class="ruby">            priority_value: wo.priority,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="749">
          
          
          <code class="ruby">            days_opened: wo.days_opened,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="750">
          
          
          <code class="ruby">            is_unassigned: wo.assigned_to_id == Maintenance::WorkOrder::UNASSIGNED,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="751">
          
          
          <code class="ruby">            assigned_to_name: work_order_assigned_to(wo),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="752">
          
          
          <code class="ruby">            materials_exists: wo.materials.count &gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="753">
          
          
          <code class="ruby">            material_items: wo.materials.map do |m|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="754">
          
          
          <code class="ruby">              {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="755">
          
          
          <code class="ruby">                quantity: quantity_format(m.quantity),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="756">
          
          
          <code class="ruby">                unit: m.item.inventory_unit.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="757">
          
          
          <code class="ruby">                name: m.item.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="758">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="759">
          
          
          <code class="ruby">            end,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="760">
          
          
          <code class="ruby">            materials_cost: humanized_currency_format(wo.material_total),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="761">
          
          
          <code class="ruby">            detail_exists: wo.materials.count &gt; 0 || wo.closing_comment.present? || wo.duration.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="762">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="763">
          
          
          <code class="ruby">          if wo.status == Maintenance::WorkOrder::STATUS_CLOSED.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="764">
          
          
          <code class="ruby">            data.merge! ({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="765">
          
          
          <code class="ruby">                          closed_by_name: wo.closed_by.try(:name),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="766">
          
          
          <code class="ruby">                          closed_on: wo.closed_at ? l(wo.closed_at, format: :short) : nil,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="767">
          
          
          <code class="ruby">                          closing_comment: wo.closing_comment,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="768">
          
          
          <code class="ruby">                          duration: minutes_to_hours(wo.duration),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="769">
          
          
          <code class="ruby">                          closed_same_day: wo.days_elapsed == 1,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="770">
          
          
          <code class="ruby">                          days_elapsed: wo.days_elapsed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="771">
          
          
          <code class="ruby">                        })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="772">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="773">
          
          
          <code class="ruby">            data.merge! ({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="774">
          
          
          <code class="ruby">                          due_to_date: wo.due_to_date ? l(wo.due_to_date, format: :short) : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="775">
          
          
          <code class="ruby">                        })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="776">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="777">
          
          
          <code class="ruby">          data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="778">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="779">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="780">
          
          
          <code class="ruby">      if params[:cim_ids]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="781">
          
          
          <code class="ruby">        fixes = Maintenance::ChecklistItemMaintenance.where(id: params[:cim_ids])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="782">
          
          
          <code class="ruby">        fixes = fixes.map do |cim|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="783">
          
          
          <code class="ruby">          checklist_item = cim.maintenance_checklist_item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="784">
          
          
          <code class="ruby">          data = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="785">
          
          
          <code class="ruby">              comment: cim.comment,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="786">
          
          
          <code class="ruby">              location: params[:checklist_trends] == &#39;true&#39; ? cim.checklist_item_name : cim.maintainable_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="787">
          
          
          <code class="ruby">              started_on: cim.maintenance_record ? l(cim.maintenance_record.created_at, format: :short) : nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="788">
          
          
          <code class="ruby">              started_by: cim.maintenance_record ? cim.maintenance_record.user.try(:name) : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="789">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="790">
          
          
          <code class="ruby">          if cim.maintenance_record &amp;&amp; cim.maintenance_record.completed_on</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="791">
          
          
          <code class="ruby">            data.merge!({</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="792">
          
          
          <code class="ruby">              completed_on: l(cim.maintenance_record.completed_on, format: :short),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="793">
          
          
          <code class="ruby">              completed_by: cim.maintenance_record.completed_by.try(:name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="794">
          
          
          <code class="ruby">            })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="795">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="796">
          
          
          <code class="ruby">          data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="797">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="798">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="799">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="800">
          
          
          <code class="ruby">      @results = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="801">
          
          
          <code class="ruby">          work_orders: work_orders,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="802">
          
          
          <code class="ruby">          fixes: fixes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="803">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="804">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="805">
          
          
          <code class="ruby">        format.json { render json: @results }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="806">
          
          
          <code class="ruby">        format.pdf do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="807">
          
          
          <code class="ruby">          title = format(&quot;Hotel Trending Issue Analysis&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="808">
          
          
          <code class="ruby">          render pdf: title,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="809">
          
          
          <code class="ruby">                 template: &#39;reports/pdf/work_order_trendings&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="810">
          
          
          <code class="ruby">                 layout: &#39;layouts/pdf.html.haml&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="811">
          
          
          <code class="ruby">                 header: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="812">
          
          
          <code class="ruby">                     html: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="813">
          
          
          <code class="ruby">                         template: &#39;reports/pdf/header&#39;,</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="814">
          <span class="hits">1</span>
          
          <code class="ruby">                         locals: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="815">
          
          
          <code class="ruby">                             report_title: title</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="816">
          <span class="hits">1</span>
          
          <code class="ruby">                         }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="817">
          
          
          <code class="ruby">                     },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="818">
          
          
          <code class="ruby">                     spacing: -10</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="819">
          
          
          <code class="ruby">                 },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="820">
          
          
          <code class="ruby">                 footer: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="821">
          
          
          <code class="ruby">                     center: &#39;[page] of [topage]&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="822">
          
          
          <code class="ruby">                 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="823">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="824">
          <span class="hits">1</span>
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="825">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="826">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="827">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="828">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="829">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="830">
          
          
          <code class="ruby">  def get_date_range</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="831">
          
          
          <code class="ruby">    @from = params[:from] || Date.today.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="832">
          
          
          <code class="ruby">    @from = Date.parse(@from).beginning_of_day</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="833">
          
          
          <code class="ruby">    @to   = params[:to] || Date.today.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="834">
          
          
          <code class="ruby">    @to   = Date.parse(@to).end_of_day</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="835">
          
          
          <code class="ruby">    @dates_offset = params[:offset].to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="836">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="837">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="838">
          
          
          <code class="ruby">  def get_room_pm_data_by_cycle(cycle, rooms)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="839">
          
          
          <code class="ruby">    rooms.map do |room|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="840">
          
          
          <code class="ruby">      records = room.maintenance_records.by_cycle(cycle)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="841">
          
          
          <code class="ruby">      checklist_items_maintenances = Maintenance::ChecklistItemMaintenance.where(maintenance_record_id: records.pluck(:id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="842">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="843">
          
          
          <code class="ruby">        id: room.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="844">
          
          
          <code class="ruby">        room_no: room.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="845">
          
          
          <code class="ruby">        floor: room.floor,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="846">
          
          
          <code class="ruby">        no_issues: checklist_items_maintenances.no_issues.count,</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="847">
          <span class="hits">1</span>
          
          <code class="ruby">        fixed: checklist_items_maintenances.fixed.count,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="848">
          
          
          <code class="ruby">        issues: checklist_items_maintenances.issues.count,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="849">
          
          
          <code class="ruby">        count_of_pm: records.count,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="850">
          
          
          <code class="ruby">        status: if records.completed.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="851">
          
          
          <code class="ruby">                  :completed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="852">
          
          
          <code class="ruby">                elsif records.finished.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="853">
          
          
          <code class="ruby">                  :finished</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="854">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="855">
          
          
          <code class="ruby">                  :_remaining</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="856">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="857">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="858">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="859">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="860">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="861">
          
          
          <code class="ruby">  def get_public_area_pm_data_by_cycle(cycle, areas)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="862">
          
          
          <code class="ruby">    areas.map do |area|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="863">
          
          
          <code class="ruby">      records = area.maintenance_records.by_cycle(cycle).finished</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="864">
          
          
          <code class="ruby">      checklist_items_maintenances = Maintenance::ChecklistItemMaintenance</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="865">
          
          
          <code class="ruby">                                       .where(maintenance_record_id: records.pluck(:id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="866">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="867">
          
          
          <code class="ruby">        id: area.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="868">
          
          
          <code class="ruby">        name: area.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="869">
          
          
          <code class="ruby">        no_issues: checklist_items_maintenances.no_issues.count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="870">
          
          
          <code class="ruby">        fixed: checklist_items_maintenances.fixed.as_json(include: [:maintenance_checklist_item, :maintenance_equipment_checklist_item]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="871">
          
          
          <code class="ruby">        issues: checklist_items_maintenances.issues.as_json(include: [:work_order]),</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="872">
          <span class="hits">1</span>
          
          <code class="ruby">        count_of_pm: records.count,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="873">
          
          
          <code class="ruby">        maintenance_records: maintenance_records_serializer(records),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="874">
          
          
          <code class="ruby">        status: if records.completed.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="875">
          
          
          <code class="ruby">                  :completed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="876">
          
          
          <code class="ruby">                elsif records.finished.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="877">
          
          
          <code class="ruby">                  :finished</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="878">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="879">
          
          
          <code class="ruby">                  :_remaining</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="880">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="881">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="882">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="883">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="884">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="885">
          
          
          <code class="ruby">  # TODO: Need to use active_model_serializer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="886">
          
          
          <code class="ruby">  def maintenance_records_serializer(records)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="887">
          
          
          <code class="ruby">    results = records.map do |record|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="888">
          <span class="hits">1</span>
          
          <code class="ruby">      hash = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="889">
          
          
          <code class="ruby">        completed_by: record.completed_by.try(:name),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="890">
          
          
          <code class="ruby">        completed_on: I18n.l(record.completed_on, format: :short),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="891">
          
          
          <code class="ruby">        inspected: record.completed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="892">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="893">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="894">
          
          
          <code class="ruby">      if record.completed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="895">
          
          
          <code class="ruby">        hash.merge! inspected_by: record.inspected_by.try(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="896">
          
          
          <code class="ruby">        hash.merge! inspected_on: I18n.l(record.inspected_on, format: :short)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="897">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="898">
          
          
          <code class="ruby">      hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="899">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="900">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="901">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="902">
          
          
          <code class="ruby">  def set_property_info(cycle_type)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="903">
          
          
          <code class="ruby">    return unless params[:property_switched].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="904">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="905">
          
          
          <code class="ruby">    response.headers[&#39;cycle_count&#39;] = Maintenance::Cycle.by_cycle_type(cycle_type).count.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="906">
          
          
          <code class="ruby">    response.headers[&#39;cycle_offset&#39;] = (Maintenance::Cycle.by_cycle_type(cycle_type).count - 1).to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="907">
          
          
          <code class="ruby">    response.headers[&#39;min_year&#39;] = Maintenance::Cycle.by_cycle_type(cycle_type).minimum(:year).to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="908">
          
          
          <code class="ruby">    response.headers[&#39;max_year&#39;] = Maintenance::Cycle.by_cycle_type(cycle_type).maximum(:year).to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="909">
          
          
          <code class="ruby">    response.headers[&#39;current_cycle&#39;] = &quot;C#{current_cycle(cycle_type).ordinality_number} (#{current_cycle(cycle_type).period})&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="910">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="911">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="beec737391bf54fe66309fbd911b8364a96f662c">
  <div class="header">
    <h3>app/controllers/tags_controller.rb</h3>
    <h4><span class="red">58.7 %</span> covered</h4>
    <div>
      <b>46</b> relevant lines. 
      <span class="green"><b>27</b> lines covered</span> and
      <span class="red"><b>19</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class TagsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"> </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">    @q = model.accessible_by(current_ability).roots_and_descendants_preordered.search(params[:q])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">    @tags = @q.result</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">    respond_with @tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @tag = model.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @excluded_items = Item.where{id.not_in my{@tag.items.map(&amp;:id)}}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    respond_with @tag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">    add_breadcrumb tag.name</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="20">
          <span class="hits">3</span>
          
          <code class="ruby">    @excluded_items = Item.where{id.not_in my{tag.items.map(&amp;:id)}}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    respond_with tag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    @tag = model.new(tag_params.merge(property: current_property))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    @tag.user = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    @tag.update_attribute(:siblings_position, :last) unless tag_params[:operation]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    if @tag.save &amp;&amp; @tag.update_items(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      flash[:notice] = t(&quot;controllers.tags.tag_created&quot;, model: model)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      redirect_to model  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      render action: &#39;new&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    if tag.update_attributes(tag_params) &amp;&amp; tag.update_items(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      flash[:notice] = t(&quot;controllers.tags.tag_updated&quot;, tag_type_h: tag_type_h, tag_name: tag.name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      redirect_to action: &#39;index&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      flash.now[:error] = tag.errors.full_messages.to_sentence</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      render action: &#39;edit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    tag.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    flash[:notice] = t(&quot;controllers.tags.tag_deleted&quot;, tag_name: model.to_s.downcase)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    redirect_to model</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def tag_type</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="55">
          <span class="hits">17</span>
          
          <code class="ruby">    params[:controller]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  def tag_type_h</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    tag_type.singularize.capitalize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :tag_type_h, :tag_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  def tag_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    params.require(:tag).permit(:name, :type, :unboxed_countable, :operation, :other_id, item_ids: [])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  def model</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="69">
          <span class="hits">4</span>
          
          <code class="ruby">    @model ||= tag_type.classify.constantize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  def tag</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="73">
          <span class="hits">4</span>
          
          <code class="ruby">    return nil unless params[:id]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="74">
          <span class="hits">4</span>
          
          <code class="ruby">    @tag ||= model.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="9db5e11457fec04ccaad53e85b2d0849e4590de3">
  <div class="header">
    <h3>app/controllers/users_controller.rb</h3>
    <h4><span class="red">15.38 %</span> covered</h4>
    <div>
      <b>117</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>99</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class UsersController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&quot;controllers.users.team&quot;), :users_path, :options =&gt; { :title =&gt; I18n.t(&quot;controllers.users.team&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html, :json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def user_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    if can? :manage_restricted_attributes, User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      params.require(:user).permit :name, :title, :email, :username, :phone_number, :password, :password_confirmation, :avatar, :remove_avatar,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        :current_property_role_id, current_property_user_role_attributes: [:id, :role_id, :title, :order_approval_limit], department_ids: [], settings: [:work_order_group_by, :primary_hotel]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      params.require(:user).permit( :name, :title, :email, :username, :phone_number, :password, :password_confirmation, :avatar, :remove_avatar, settings: [:work_order_group_by, :primary_hotel] )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  private :user_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    authorize User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    target = current_user.corporate? ? current_user.corporate : Property.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @scope = params[:scope]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    if @scope == &#39;deleted&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      @user_roles = target.user_roles.only_deleted.order(:deleted_at)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      @matching_users = target.users.active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      # @matching_users += current_property.corporate.users if current_property.corporate.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      @pending_invitations = target.join_invitations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    respond_with @matching_users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    @user = User.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    authorize User, :new?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    @user.current_property_user_role = UserRole.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    authorize! :create, @user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    add_breadcrumb t(&quot;controllers.users.add_member&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    respond_with @user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    @user = User.with_deleted.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    authorize @user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    add_breadcrumb t(&quot;controllers.users.user&quot;, name: @user.name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    flash.now[:warning] = t(&#39;devise.failure.unconfirmed_admin&#39;) unless @user.confirmed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    flash.now[:alert] = t(&quot;controllers.users.user_is_inactive&quot;) if @user.deleted?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def change_password</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    add_breadcrumb t(&quot;controllers.users.change_password&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def valid_username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    @user = User.find_for_database_authentication({username: params[:username]})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    current_id = params[:user_id].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    existing_user = @user &amp;&amp; @user.id != current_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    if existing_user &amp;&amp; @user.all_properties.include?(Property.current)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      render json: {status: &quot;not_valid&quot;, name: @user.name}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    elsif existing_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      render json: {status: &quot;confirm_code&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      render json: {status: &quot;valid&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def confirm_username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    @user = User.find_for_database_authentication({username: params[:username]})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    if @user &amp;&amp; @user.code == params[:code]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      render json: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      render json: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    authorize User, :create?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    @user = User.new(user_params.merge(created_by_user: current_user))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    @user_by_username = user_params[:username].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    warden_condition = @user_by_username ? {username: user_params[:username]} : {email: user_params[:email]}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    if user = User.find_for_database_authentication(warden_condition)  # user with this email/username already exists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      if current_user.corporate?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        if user.corporate_id?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">          flash.now[:error] = &quot;A user with the #{warden_condition.keys.first} #{warden_condition[warden_condition.keys.first]} is already corporate user.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">          render action: &#39;new&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">          if @user_by_username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">            user.corporate_id = current_user.corporate.id if current_user.corporate?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">            user.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">            invitation = JoinInvitation.create(sender: current_user, invitee: user, targetable: current_user.corporate)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">            Mailer.delay.join_invitation(invitation.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">          redirect_to users_path, notice: &#39;User was invited to join this corporate.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        invite_params = user_params.slice &#39;current_property_user_role_attributes&#39;, &#39;department_ids&#39;, &#39;username&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        invite_params.delete_if { |k, v| v.blank? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        if user.properties.include? current_property # they are already connected to this property</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">          flash.now[:error] = &quot;A user with the email #{warden_condition.keys.first} #{warden_condition[warden_condition.keys.first]} already exists in this hotel.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          render action: &#39;new&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        else # user exists but isn&#39;t connected to this property so let&#39;s invite them</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">          if @user_by_username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">            user.update(invite_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">            invitation = JoinInvitation.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">              sender: current_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">              invitee: user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">              targetable: current_property,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">              params: invite_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">            )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">            Mailer.delay.join_invitation(invitation.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">          redirect_to users_path, notice: &#39;User was invited to join this hotel.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    else # create a new user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      if @user_by_username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">        @user.skip_confirmation!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">        @user.corporate_id = current_user.corporate.id if current_user.corporate?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      if @user.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">        @user.confirm! if @user_by_username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">        redirect_to users_path, notice: t(&quot;controllers.users.user_was_created&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">        render action: &#39;new&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    restore = params[&quot;submit_button&quot;] == &quot;Activate&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">    inactivate = params[&quot;submit_button&quot;] == &quot;Inactivate&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    @user = User.with_deleted.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    authorize @user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    # TODO https://github.com/rails/rails/issues/6127</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    settings = params[:user].delete :settings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    if settings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      @user.settings ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      @user.settings.merge! settings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      @user.settings_will_change!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      @user.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">      respond_with @user, location: policy(User).index? ? users_path : edit_user_path(@user) and return if params[:user].blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    if params[:user][:password].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      params[:user].delete :password</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      params[:user].delete :password_confirmation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    if @user.update(user_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      (restore &amp;&amp; @user.activate!) || (inactivate &amp;&amp; @user.inactivate!)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      flash[:notice] = t(&quot;controllers.users.user_was_updated&quot;) unless request.xhr?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">      respond_with @user, location: policy(User).index? ? users_path : edit_user_path(@user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">      changing_password = params[:user][:password].present? &amp;&amp; @user == current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">      action = changing_password ? &#39;change_password&#39; : &#39;edit&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      render action: action</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    @user = User.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    authorize @user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">    @user.inactivate!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    redirect_to users_url, notice: t(&quot;controllers.users.user_was_inactivated&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  # @param [String, Symbol] scope_name The name of the scope desired.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">  #   Defaults to &#39;current_property&#39; if nil or not provided.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  # @return [Hash{String =&gt; Hash}] A hash describing the scope.  Contains</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">  #   a :required_permission which provides the Permission symbol needed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  #   on User to view it, and a :users key which provides a proc which,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">  #   when called, yields a Relation with the users for the scope.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">  def index_scope(scope_name = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">    { &#39;all&#39; =&gt; {required_permission: :manage, users: proc{User.all} },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      &#39;deleted&#39; =&gt; {required_permission: :manage, users: proc{User.only_deleted} },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      &#39;active&#39; =&gt; {required_permission: :read, users: proc{current_property.users.where.not(confirmed_at: nil) }},</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      &#39;current_property&#39; =&gt; {required_permission: :read, users: proc{current_property.users} }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">    }[(scope_name || &#39;current_property&#39;).to_s]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    authorize!(params[:action].to_sym, @user || User)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="757cc5d2df06db430841358537c938cf2239c194">
  <div class="header">
    <h3>app/controllers/vendors_controller.rb</h3>
    <h4><span class="red">45.71 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>19</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class VendorsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  add_breadcrumb I18n.t(&#39;controllers.vendors.vendors&#39;), :vendors_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :html</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :load_vendor, only: :create</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  load_and_authorize_resource except: [:index]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    authorize!(params[:action].to_sym, Vendor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    authorize!(:index, Vendor)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @vendors = Vendor.order(&#39;name asc&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    params[:active] ||= &#39;profile&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    add_breadcrumb t(&#39;controllers.vendors.title_new&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    params[:active] ||= &#39;profile&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    add_breadcrumb t(&#39;controllers.vendors.title_new&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    if @vendor.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      redirect_to vendors_url, notice: t(&#39;controllers.vendors.vendor_was_created&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      render action: &#39;new&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    if @vendor.update_attributes(vendor_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      redirect_to vendors_url, notice: t(&#39;controllers.vendors.vendor_was_updated&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      render action: &#39;edit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    if @vendor.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      redirect_to vendors_url, notice: t(&#39;controllers.vendors.vendor_was_deleted&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      redirect_to vendors_url, alert: @vendor.errors.full_messages.to_sentence.capitalize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_vendor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    @vendor = Vendor.new(vendor_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def vendor_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    params.require(:vendor).permit :name, :street_address, :zip_code, :city, :email, :phone, :fax, :contact_name, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      :shipping_method, :shipping_terms, :division, :customer_number, :department_number, :customer_group, :vpt_enabled,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      procurement_interface_attributes: [:interface_type, :id, data: ProcurementInterface::TYPE_SETTINGS.values.map{ |setting| setting[:fields] }.flatten.uniq ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="312ce01c3e846734ee018d9ae042950c1594854f">
  <div class="header">
    <h3>app/decorators/item_order_decorator.rb</h3>
    <h4><span class="red">40.0 %</span> covered</h4>
    <div>
      <b>30</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ItemOrderDecorator &lt; Draper::Decorator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def received</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    &quot;#{object.received} #{purchase_unit}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    object.average_price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def price_trend</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    object.item.item_transactions.where(purchase_step_type: &#39;ItemReceipt&#39;).last(5).map{|transaction| transaction.purchase_step.price}.join(&#39;,&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def popover_receivings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    h.content_tag(:div) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      object.item_receipts.each { |ir| h.concat h.content_tag(:div, &quot;#{h.l(ir.created_at, format: :short)} | #{ir.quantity} | #{h.humanized_money_with_symbol( ir.price )}&quot; ) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def purchase_unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    object.item.unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def price_unit_if_different</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    different_units? ? &#39; &#39; + price_unit.name : &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def vpt_size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    # quantity unit is EACH</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    # We purchase individual units (gordon: I think that&#39;s what this means *shrug*)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    if item.price_unit_id == item.unit_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      [self.quantity.floor, 0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # quantity unit is CASE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    # We purchase packs of units</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    elsif item.pack_present? &amp;&amp; item.price_unit_id == item.pack_unit_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      self.quantity.divmod(item.pack_size).map(&amp;:floor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # We purchase sub packs of units</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    elsif item.pack_present? &amp;&amp; item.subpack_present? &amp;&amp; item.price_unit_id == item.subpack_unit_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      size = self.quantity.divmod(item.pack_size * item.subpack_size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      size[1] /= item.subpack_size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      size.map(&amp;:floor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      [0, 0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def price_unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    object.item.price_unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def different_units?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    purchase_unit != price_unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="13d111d145be886def86434b53c3a797358e69f6">
  <div class="header">
    <h3>app/helpers/activity_helper.rb</h3>
    <h4><span class="red">25.0 %</span> covered</h4>
    <div>
      <b>12</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module ActivityHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def maintenance_record_status(record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    if record.checklist_item_maintenances.fixed.empty? &amp;&amp; record.checklist_item_maintenances.issues.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      t(&quot;activity.maintenance_record.#{record.status}.no_issues&quot;, type: record.maintainable_type_short.titleize)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      issue_count = record.checklist_item_maintenances.issues.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      fix_count = record.checklist_item_maintenances.fixed.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      data = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      data.push(&quot;#{pluralize(issue_count, &#39;WO&#39;)} created&quot;) if issue_count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      data.push(&quot;#{pluralize(fix_count, &#39;issue&#39;)} fixed&quot;) if fix_count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      data.join(&#39; and &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def activity_type_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      [&#39;All activities&#39;, nil],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      [&#39;Work Order&#39;, &#39;work_order&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      [&#39;Room PM&#39;, &#39;room.pm&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      [&#39;Public Area PM&#39;, &#39;public_area.pm&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      [&#39;Equipment PM&#39;, &#39;equipment.pm&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      [&#39;Guest Log&#39;, &#39;comment&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7b116802412a9cdecd059034225fe9e14fa9b76f">
  <div class="header">
    <h3>app/helpers/application_helper.rb</h3>
    <h4><span class="red">38.55 %</span> covered</h4>
    <div>
      <b>83</b> relevant lines. 
      <span class="green"><b>32</b> lines covered</span> and
      <span class="red"><b>51</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module ApplicationHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def alert_class(flash_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    case flash_name.to_sym</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      when :notice then &#39;success&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">      when :alert then &#39;warning&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      when :error then &#39;danger&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def alert_icon(flash_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    content_tag :i, nil, class: &#39;icon-&#39; + case flash_name.to_sym</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      when :notice then &#39;ok&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      when :alert then &#39;minus-sign&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      when :info then &#39;info-sign&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      else &#39;warning-sign&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end.html_safe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def breadcrumb(*items)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    content_tag :ul, class: &#39;breadcrumb&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      items.collect do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        item = item.to_s.html_safe</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        content_tag :li, class: conditional_class({class: &#39;active&#39;, if: item == items.last}) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          if item == items.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">            item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">            item + content_tag(:span, &#39;/&#39;, class: &#39;divider&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      end.join(&quot;\n&quot;).html_safe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def age_class(record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    if record.updated_at &gt; 3.days.ago</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      &#39;new&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    elsif record.updated_at &gt; 5.days.ago</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      &#39;old&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      &#39;oldest&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def currency_format value</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="45">
          <span class="hits">20</span>
          
          <code class="ruby">    (&#39;%.2f&#39; % Money.new((value || 0) * 100)).to_f.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def humanized_currency_format value</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="49">
          <span class="hits">7</span>
          
          <code class="ruby">    &quot;$#{currency_format value}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantity_format value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    (&#39;%.3f&#39; % value).to_f.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit_format unit</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="57">
          <span class="hits">24</span>
          
          <code class="ruby">    unit.try(:name).upcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def humanized_unit_format unit</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="61">
          <span class="hits">24</span>
          
          <code class="ruby">    content_tag(:span, unit_format(unit), class: &#39;text-muted semibold&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  # Usage:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  # conditional_class &#39;btn&#39;, {class: &#39;btn-primary&#39;, :if =&gt; true}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # conditional_class &#39;btn&#39;, {class: &#39;btn-primary&#39;, :if =&gt; false}, {class: &#39;btn-warning&#39;, :if =&gt; true}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  # conditional_class({class: &#39;btn&#39;, :if =&gt; true}, {class: &#39;active&#39;, :if =&gt; true})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  # This is a tricy method, use :if =&gt; condition in the console, if: condition will work fine outside of IRB.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  # Use parenthesis when the unconditional class (first argument, String) is not provided.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def conditional_class(*args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    result = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    result &lt;&lt; args.shift if args.first.kind_of? String </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    result |= args.collect {|each| each[:class] if each[:if]}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    result.reject(&amp;:blank?).join &#39; &#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  def options_from_collection_for_select_with_data(collection, value_method, text_method, selected = nil, data = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    options = collection.map do |element|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      [element.send(text_method), element.send(value_method), data.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        {&quot;data-#{k}&quot; =&gt; element.send(v)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      ].flatten</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    selected, disabled = extract_selected_and_disabled(selected)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    select_deselect = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    select_deselect[:selected] = extract_values_from_collection(collection, value_method, selected)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    select_deselect[:disabled] = extract_values_from_collection(collection, value_method, disabled)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    options_for_select(options, select_deselect)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  # Usage:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  # link_to_with_icon &#39;icon-info&#39;, &#39;Information&#39;, information_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  #def link_to_with_icon(*args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    #if block_given?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      #raise ArgumentError.new(&#39;A block argument is not supported by this Helper, use link_to instead.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    #else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      #icon = args.shift</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      #name = args.shift</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      #link_to *args do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        #content_tag(:i, nil, class: icon) + raw(name.prepend &#39;&amp;nbsp;&amp;nbsp;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      #end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    #end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  #end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">  def link_to_with_icon(*args, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    icon = args.shift</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    name = args.shift</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    link = link_to *args do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      concat content_tag(:i, nil, class: icon)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      concat &quot; &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">      concat raw(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    link + &quot; &quot; #whitespace for buttons</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  # Deprecated in Rails 4!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">  def link_to_function(name, *args, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">     html_options = args.extract_options!.symbolize_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">     function = block_given? ? update_page(&amp;block) : args[0] || &#39;&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">     onclick = &quot;#{&quot;#{html_options[:onclick]}; &quot; if html_options[:onclick]}#{function}; return false;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">     href = html_options[:href] || &#39;#&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">     content_tag(:a, name, html_options.merge(:href =&gt; href, :onclick =&gt; onclick))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">  def link_to_submit(*args, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    link_to_function (block_given? ? capture(&amp;block) : args[0]), &quot;$(this).closest(&#39;form&#39;).submit()&quot;, args.extract_options!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">  def procurement_active?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    lists_active? || purchase_requests_active? || purchase_orders_active? || items_active? || procurement_setup_active?    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">  def body_class(class_name)</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="138">
          <span class="hits">28</span>
          
          <code class="ruby">    content_for :body_class, class_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  def procurement_setup_active?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    vendors_active? || categories_active? || locations_active?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">  def favorie_reports_active?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    reports_active? and params[&#39;action&#39;] == &#39;favorites&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  def preventive_maintenance_active?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    request.fullpath.start_with?(&#39;/maintenance/&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">  def users_menu_active?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="154">
          <span class="hits">4</span>
          
          <code class="ruby">    users_active? || departments_active?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">  MENU_ITEMS = %W[departments categories vendors users lists locations items purchase_requests purchase_orders reports budgets]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">  MENU_ITEMS.each do |item|</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="160">
          <span class="hits">11</span>
          
          <code class="ruby">    method_name = &quot;#{item}_active?&quot;</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="161">
          <span class="hits">11</span>
          
          <code class="ruby">    define_method method_name do</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="162">
          <span class="hits">16</span>
          
          <code class="ruby">      params[:controller] == item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b0c1a57d3a19c1274245f9d1417d882b08e4b1c7">
  <div class="header">
    <h3>app/helpers/budgets_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module BudgetsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def range_title first_half, year</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="4">
          <span class="hits">5</span>
          
          <code class="ruby">    I18n.t(&quot;date.abbr_month_names&quot;)[first_half*6 + 1] + &#39; ~ &#39; + I18n.t(&quot;date.abbr_month_names&quot;)[first_half * 6 + 6] + &#39;, &#39; + year.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  def month_name month</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="8">
          <span class="hits">30</span>
          
          <code class="ruby">    I18n.t(&quot;date.month_names&quot;)[month]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a741f2f9ad97005aebeb197bdfc29e9235cd5767">
  <div class="header">
    <h3>app/helpers/maintenance_helper.rb</h3>
    <h4><span class="red">29.79 %</span> covered</h4>
    <div>
      <b>47</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module MaintenanceHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def work_order_status_label_class(days_opened)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    if days_opened &lt;= 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">      &quot;label label-success&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    elsif days_opened &lt;= 7</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      &quot;label label-warning&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      &quot;label label-danger&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def work_order_priority_label_class(priority)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    if priority == &quot;l&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      &quot;text-success&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    elsif priority == &quot;m&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      &quot;text-warning&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      &quot;text-danger&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def minutes_to_hours(minutes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    return if minutes.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    minutes % 30 == 0 ? &quot;#{minutes / 60.0} hours&quot; : &quot;#{minutes} minutes&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_cycle_range</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    current_cycle = Maintenance::Cycle.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    start_date = Time.new(current_cycle.year, current_cycle.start_month)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    end_date = (start_date + (current_cycle.frequency_months - 1).months).end_of_month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    &quot;#{start_date.strftime(&#39;%b %d&#39;)} - #{end_date.strftime(&#39;%b %d&#39;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def users_in_current_property</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    @assignable_users ||= Property.current.users.active.select { |u| u.wo_assignable_id &gt; 0 }.map{ |u| [u.name.titleize, u.id] } + Maintenance::WorkOrder::EXTRA_USERS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_assigned_to_user(work_order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    if Property.current.users.include?(work_order.assigned_to)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      work_order.assigned_to_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      work_order.assigned_to_id || Maintenance::WorkOrder::UNASSIGNED</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def work_order_form_data_attributes(wo)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      &#39;permitted-priority&#39; =&gt; policy(wo).permitted_attributes.include?(:priority),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      &#39;permitted-status&#39; =&gt; policy(wo).permitted_attributes.include?(:status),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      &#39;permitted-assigned-to-id&#39; =&gt; policy(wo).permitted_attributes.include?(:assigned_to_id),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      &#39;permitted-due-to-date&#39; =&gt; policy(wo).permitted_attributes.include?(:due_to_date),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      &#39;user-permitted-to-edit-closed-wo&#39; =&gt; policy(wo).edit_closed?,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      &#39;wo-closed&#39; =&gt; wo.closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  def properties_filter_class</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    current_user.corporate? &amp;&amp; current_user.all_properties.count &gt; 0 ? &#39;&#39; : &#39;hidden&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  def new_work_order_form_title</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    @prev_property_id.nil? ? &quot;Add WO for &#39;#{Property.current.name}&#39;&quot; : &#39;Add Work Order&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def new_work_order_description_placeholder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    @prev_property_id.nil? ? &quot;Describe the WO for &#39;#{Property.current.name}&#39;&quot; : t(&#39;.description_placeholder&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  def work_order_types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      [&#39;All WOs&#39;, nil],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      [&#39;Filter WOs for: Room&#39;, &#39;Maintenance::Room&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      [&#39;Filter WOs for: Public Area&#39;, &#39;Maintenance::PublicArea&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      [&#39;Filter WOs for: Equipment&#39;, &#39;Maintenance::Equipment&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      [&#39;Filter WOs for: Other&#39;, &#39;Other&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  def work_order_status_labels</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      Maintenance::WorkOrder::STATUS_OPEN =&gt; &#39;Open&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      Maintenance::WorkOrder::STATUS_WORKING =&gt; &#39;In Progress&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      Maintenance::WorkOrder::STATUS_CLOSED =&gt; &#39;Closed&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  def work_order_assigned_to(work_order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    if work_order.assigned_to_id == Maintenance::WorkOrder::THIRD_PARTY</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      t(&#39;reports.work_order_trendings.third_party&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    elsif work_order.assigned_to_id == Maintenance::WorkOrder::UNASSIGNED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">      t(&#39;reports.work_order_trendings.unassigned&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    elsif work_order.assigned_to</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      work_order.assigned_to.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="62c22822fd0fc8a83ac502fca8fdbd12ccc06d4a">
  <div class="header">
    <h3>app/helpers/permissions_helper.rb</h3>
    <h4><span class="red">41.18 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PermissionsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def permission_value(permissions, attribute, option = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    permitted = permissions.where(permission_attribute_id: attribute.id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    permitted.present? &amp;&amp; (option.present? ? (permitted.options || []).include_in_hash?(option[:option]) : true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def permission_option(permissions, attribute, option)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    permitted = permissions.where(permission_attribute_id: attribute.id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    (permitted.present? &amp;&amp; (permitted.options || []).select_in_hash(option)) || []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def item_name(item, option = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    &quot;[#{item.subject}][#{item.action}]&quot; + (option ? &quot;[#{option[:option]}]&quot; : &#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def item_id(item, option = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    &quot;#{item.subject}_#{item.action}&quot; + (option ? &quot;_#{option[:option]}&quot; : &#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def priority_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    if policy(:access).work_order? &amp;&amp; policy(Maintenance::WorkOrder).index?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      maintenance_work_orders_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      dashboard_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def border_colors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    [&#39;border-inverse&#39;, &#39;border-success&#39;, &#39;border-danger&#39;, &#39;border-primary&#39;, &#39;border-teal&#39;, &#39;border-info&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="561132ed1ea9793eab681bc9fff1dc6c3bdd39a4">
  <div class="header">
    <h3>app/helpers/pusher_helper.rb</h3>
    <h4><span class="red">70.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PusherHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  FAX_CHANNEL = &#39;fax_channel&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  REQUEST_CHANNEL = &#39;request_channel&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  WORK_ORDER_CHANNEL = &#39;work_order_channel&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_env_info data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    if data[:to].is_a? Array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      to_array = data[:to].map { |to| Rails.env + &#39;_&#39; + to.to_s }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      data[:to] = to_array</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      data[:to] = Rails.env + &#39;_&#39; + data[:to].to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_fax_event event, data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    Pusher[FAX_CHANNEL].trigger event, add_env_info(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_request_approval_sent_event data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    Pusher[REQUEST_CHANNEL].trigger &#39;request.approve&#39;, add_env_info(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_request_approve_received_event data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    Pusher[REQUEST_CHANNEL].trigger &#39;request.approve.received&#39;, add_env_info(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_request_approval_checked_event data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    Pusher[REQUEST_CHANNEL].trigger &#39;request.checked&#39;, add_env_info(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_work_order_notification event,data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    Pusher[WORK_ORDER_CHANNEL].trigger event, add_env_info(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="162e13573b11f3a868c04d7d3af910b4dbb52291">
  <div class="header">
    <h3>app/helpers/report_helper.rb</h3>
    <h4><span class="red">13.89 %</span> covered</h4>
    <div>
      <b>36</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>31</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module ReportHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def room_status(record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    return if record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    status = &#39;&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    detail = &#39;&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    if record[:status] == :completed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      status = &quot;&lt;i class=&#39;fa fa-info-circle text-primary&#39;&gt;&lt;/i&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    if record[:status] == :_remaining</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      status += &quot;&lt;i class=&#39;fa fa-times-circle text-danger&#39;&gt;&lt;/i&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      status += &quot;&lt;i class=&#39;fa fa-check text-success&#39;&gt;&lt;/i&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      status += &quot; (#{record[:count_of_pm]} &lt;b class=&#39;text-default&#39;&gt;PMs&lt;/b&gt;)&quot; if record[:count_of_pm] &gt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    if (record[:fixed] &amp;&amp; record[:fixed] &gt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      detail += &quot;&lt;br&gt;#{record[:fixed]} &lt;b class=&#39;text-default&#39;&gt;fixes&lt;/b&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    if (record[:issues] &amp;&amp; record[:issues] &gt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      detail += &quot;&lt;br&gt;#{record[:issues]} &lt;b class=&#39;text-default&#39;&gt;WOs&lt;/b&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    &quot;#{status}#{detail}&quot;.html_safe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def area_status(record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    return if record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    status = &#39;&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    detail = &#39;&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    if record[:status] == :completed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      status = &quot;&lt;i class=&#39;fa fa-info-circle text-primary&#39;&gt;&lt;/i&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    if record[:status] == :_remaining</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      status += &quot;&lt;i class=&#39;fa fa-times-circle text-danger&#39;&gt;&lt;/i&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      status += &quot;&lt;i class=&#39;fa fa-check text-success&#39;&gt;&lt;/i&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      status += &quot; (#{record[:count_of_pm]} &lt;b class=&#39;text-default&#39;&gt;PMs&lt;/b&gt;)&quot; if record[:count_of_pm] &gt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    if (record[:fixed].count &gt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      detail += &quot;&lt;br&gt;#{record[:fixed].count} &lt;b class=&#39;text-default&#39;&gt;fixes&lt;/b&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    if (record[:issues].count &gt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      detail += &quot;&lt;br&gt;#{record[:issues].count} &lt;b class=&#39;text-default&#39;&gt;WOs&lt;/b&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    &quot;#{status}#{detail}&quot;.html_safe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def pdf_image_tag(image, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    options[:src] = &#39;file:///&#39; + File.expand_path(Rails.root) + &#39;/vendor&#39; + image</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    options[:src]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  # Convert cycle to quarter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def c2q(cycle)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    &quot;C#{cycle}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="dbcb2c8b1c2ae0629066966d4cd362b921290232">
  <div class="header">
    <h3>app/models/ability.rb</h3>
    <h4><span class="red">74.59 %</span> covered</h4>
    <div>
      <b>122</b> relevant lines. 
      <span class="green"><b>91</b> lines covered</span> and
      <span class="red"><b>31</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Ability</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include CanCan::Ability</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(user)</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="5">
          <span class="hits">58</span>
          
          <code class="ruby">    can :manage, [Location, Category]</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="6">
          <span class="hits">58</span>
          
          <code class="ruby">    can :change_password, User, id: user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="8">
          <span class="hits">58</span>
          
          <code class="ruby">    if user.corporate_id?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      if Property.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        corporate(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        cannot :access_corporate_app, User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">        can :access_corporate_app, User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        cannot :access_inventory_app, User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        cannot :access_maintenance_app, User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        can [:index, :edit, :show, :update, :destroy, :new, :create], User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        cannot [:edit, :update, :destroy], User do |u|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          !user.corporate.users.include?(u)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        cannot :manage_restricted_attributes, User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      cannot :access_maintenance_dashboard, User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="25">
          <span class="hits">58</span>
          
          <code class="ruby">      send user.current_property_role.method_name, user</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="26">
          <span class="hits">58</span>
          
          <code class="ruby">      if (user.maintenance_department? &amp;&amp; user.current_property_role.manager?) || user.current_property_role.gm?</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="27">
          <span class="hits">23</span>
          
          <code class="ruby">        can :access_maintenance_dashboard, user</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="28">
          <span class="hits">23</span>
          
          <code class="ruby">        can :access_maintenance_selection, user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      elsif user.frontdesk_department? &amp;&amp; user.current_property_role.manager?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        can :access_maintenance_dashboard, user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="32">
          <span class="hits">35</span>
          
          <code class="ruby">        cannot :access_maintenance_dashboard, user</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="33">
          <span class="hits">35</span>
          
          <code class="ruby">        cannot :access_maintenance_selection, user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="35">
          <span class="hits">58</span>
          
          <code class="ruby">      if user.current_property_role.gm? || user.current_property_role.agm?</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="36">
          <span class="hits">36</span>
          
          <code class="ruby">        can :access_maintenance_inspection, user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="38">
          <span class="hits">22</span>
          
          <code class="ruby">        cannot :access_maintenance_inspection, user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="40">
          <span class="hits">58</span>
          
          <code class="ruby">      cannot :access_corporate_app, User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def gm(user)</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="45">
          <span class="hits">23</span>
          
          <code class="ruby">    can :access_inventory_app, User</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="46">
          <span class="hits">23</span>
          
          <code class="ruby">    can :access_maintenance_app, User</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="47">
          <span class="hits">23</span>
          
          <code class="ruby">    can :settings, Property</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="48">
          <span class="hits">23</span>
          
          <code class="ruby">    can :manage, Corporate::Connection</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="49">
          <span class="hits">23</span>
          
          <code class="ruby">    can :manage, List</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="50">
          <span class="hits">23</span>
          
          <code class="ruby">    can [:new, :create, :edit, :update, :index, :inventory_print], PurchaseRequest</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="51">
          <span class="hits">23</span>
          
          <code class="ruby">    can :approve, PurchaseRequest do |pr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      pr.total_price &lt;= user.current_property_user_role.order_approval_limit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="54">
          <span class="hits">23</span>
          
          <code class="ruby">    can [:new, :create], PurchaseReceipt</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="55">
          <span class="hits">23</span>
          
          <code class="ruby">    can :manage, PurchaseOrder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="57">
          <span class="hits">23</span>
          
          <code class="ruby">    can [:index, :show, :new, :create], User</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="58">
          <span class="hits">23</span>
          
          <code class="ruby">    can [:edit, :change_password], User do |u|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      Property.current.users.include?(u)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="61">
          <span class="hits">23</span>
          
          <code class="ruby">    can [:update], User do |u|</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="62">
          <span class="hits">17</span>
          
          <code class="ruby">      Property.current.users.include?(u) &amp;&amp; !u.corporate_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="64">
          <span class="hits">23</span>
          
          <code class="ruby">    can [:destroy], User do |u|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      !u.corporate_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="68">
          <span class="hits">23</span>
          
          <code class="ruby">    can :manage_restricted_attributes, User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="70">
          <span class="hits">23</span>
          
          <code class="ruby">    can :manage, Item</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="71">
          <span class="hits">23</span>
          
          <code class="ruby">    can :manage, Vendor</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="72">
          <span class="hits">23</span>
          
          <code class="ruby">    can :manage, Department</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="73">
          <span class="hits">23</span>
          
          <code class="ruby">    can :manage, Budget</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  def agm(user)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="77">
          <span class="hits">13</span>
          
          <code class="ruby">    can :access_inventory_app, User</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="78">
          <span class="hits">13</span>
          
          <code class="ruby">    can :access_maintenance_app, User</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="79">
          <span class="hits">13</span>
          
          <code class="ruby">    can :access_maintenance_inspection, User</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="80">
          <span class="hits">13</span>
          
          <code class="ruby">    cannot :access_maintenance_selection, User</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="81">
          <span class="hits">13</span>
          
          <code class="ruby">    can :manage, List</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="82">
          <span class="hits">13</span>
          
          <code class="ruby">    can :manage, Vendor</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="83">
          <span class="hits">13</span>
          
          <code class="ruby">    can :manage, Department</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="84">
          <span class="hits">13</span>
          
          <code class="ruby">    can [:new, :create, :edit, :update, :index, :inventory_print], PurchaseRequest</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="85">
          <span class="hits">13</span>
          
          <code class="ruby">    can [:new, :create], PurchaseReceipt</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="86">
          <span class="hits">13</span>
          
          <code class="ruby">    can :manage, PurchaseOrder</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="87">
          <span class="hits">13</span>
          
          <code class="ruby">    can :approve, PurchaseRequest do |pr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      pr.total_price &lt;= user.current_property_user_role.order_approval_limit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="90">
          <span class="hits">13</span>
          
          <code class="ruby">    can :read, User do |u|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      Property.current.users.include?(u)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="93">
          <span class="hits">13</span>
          
          <code class="ruby">    can :update, User, id: user.id</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="94">
          <span class="hits">13</span>
          
          <code class="ruby">    can :manage, Item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  def corporate(user)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="98">
          <span class="hits">8</span>
          
          <code class="ruby">    can :access_inventory_app, User</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="99">
          <span class="hits">8</span>
          
          <code class="ruby">    can :access_maintenance_app, User</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="100">
          <span class="hits">8</span>
          
          <code class="ruby">    can :index, [Vendor, Department]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="101">
          <span class="hits">8</span>
          
          <code class="ruby">    can :manage, User</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="102">
          <span class="hits">8</span>
          
          <code class="ruby">    cannot :manage, List</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="103">
          <span class="hits">8</span>
          
          <code class="ruby">    can [:edit, :update], PurchaseRequest do |pr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">      highest_gm_approval_limit = Role.gm.user_roles.order(order_approval_limit: :desc).limit(1).pluck(:order_approval_limit).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      pr.state == &#39;completed&#39; &amp;&amp; pr.total_price &gt; highest_gm_approval_limit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="107">
          <span class="hits">8</span>
          
          <code class="ruby">    can :manage, PurchaseOrder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    # can :manage, User do |u|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    #   Property.current.users.include?(u)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    # cannot [:update, :destroy], User do |u|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    #   u.corporate_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="116">
          <span class="hits">8</span>
          
          <code class="ruby">    can [:index, :show, :new, :create], User</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="117">
          <span class="hits">8</span>
          
          <code class="ruby">    cannot [:edit], User do |u|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="118">
          <span class="hits">2</span>
          
          <code class="ruby">      !Property.current.users.include?(u)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="120">
          <span class="hits">8</span>
          
          <code class="ruby">    cannot [:update], User do |u|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="121">
          <span class="hits">2</span>
          
          <code class="ruby">      !Property.current.users.include?(u)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="123">
          <span class="hits">8</span>
          
          <code class="ruby">    cannot [:destroy], User do |u|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      u.corporate_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="127">
          <span class="hits">8</span>
          
          <code class="ruby">    can :manage_restricted_attributes, User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="129">
          <span class="hits">8</span>
          
          <code class="ruby">    can [:index, :edit], Item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">  def et(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    can :access_inventory_app, User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    can :update, User, id: user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">  def user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    can :access_inventory_app, User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    can :update, User, id: user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">  def admin(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">    can :access_inventory_app, User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    can :update, User, id: user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">  def manager(user)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="148">
          <span class="hits">14</span>
          
          <code class="ruby">    if user.frontdesk_department?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      cannot :access_inventory_app, User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="151">
          <span class="hits">14</span>
          
          <code class="ruby">      can :access_inventory_app, User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="153">
          <span class="hits">14</span>
          
          <code class="ruby">    can :access_maintenance_app, User</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="154">
          <span class="hits">14</span>
          
          <code class="ruby">    can [:index, :edit], [Department]</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="155">
          <span class="hits">14</span>
          
          <code class="ruby">    can :manage, Vendor</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="156">
          <span class="hits">14</span>
          
          <code class="ruby">    can :manage, List, user_id: user.id</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="157">
          <span class="hits">14</span>
          
          <code class="ruby">    can [:new, :create, :edit, :update, :index, :inventory_print], PurchaseRequest, user_id: user.id</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="158">
          <span class="hits">14</span>
          
          <code class="ruby">    can :approve, PurchaseRequest do |pr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">      pr.total_price &lt;= user.current_property_user_role.order_approval_limit &amp;&amp; pr.user_id == user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="161">
          <span class="hits">14</span>
          
          <code class="ruby">    can :read, User do |u|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">      Property.current.users.include?(u)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="164">
          <span class="hits">14</span>
          
          <code class="ruby">    can :update, User, id: user.id</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="165">
          <span class="hits">14</span>
          
          <code class="ruby">    cannot [:update, :destroy], User do |u|</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="166">
          <span class="hits">9</span>
          
          <code class="ruby">      u.corporate_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="168">
          <span class="hits">14</span>
          
          <code class="ruby">    can :manage, PurchaseOrder do |po|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      po.purchase_request.user_id == user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="171">
          <span class="hits">14</span>
          
          <code class="ruby">    can [:new, :create], PurchaseReceipt do |pr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      pr.purchase_order.purchase_request.user_id == user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="175">
          <span class="hits">14</span>
          
          <code class="ruby">    can [:new, :index, :create, :edit], Item</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="176">
          <span class="hits">14</span>
          
          <code class="ruby">    can [:change, :update], Item do |item| # :change - for checking inside form template (manager edit all items, but save changes only for certain)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="177">
          <span class="hits">17</span>
          
          <code class="ruby">      ItemTag.where(tag_id: user.category_ids.uniq ).map(&amp;:item_id).include? item.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="179">
          <span class="hits">14</span>
          
          <code class="ruby">    can [:change], Item do |item|</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="180">
          <span class="hits">16</span>
          
          <code class="ruby">      item.new_record?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="182">
          <span class="hits">14</span>
          
          <code class="ruby">    can :index, Budget</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b20be24f8b518a80a6e5418eaf79370dbff43b56">
  <div class="header">
    <h3>app/models/admin.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Admin &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  devise :database_authenticatable,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">         :recoverable, :rememberable, :trackable, :validatable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6d3b22ebae3faae08bda355a86afadeaff1f6845">
  <div class="header">
    <h3>app/models/brand.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: brands</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id   :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  name :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">class Brand &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1e86539f79755b507e59ad2e8356e61f40ee13ac">
  <div class="header">
    <h3>app/models/budget.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">class Budget &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :category</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :amount, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="294" data-linenumber="9">
          <span class="hits">294</span>
          
          <code class="ruby">  default_scope { where(category_id: Category.pluck(:id)) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3f8699d7da975e3068ff37c6aeb23f61e3ec465b">
  <div class="header">
    <h3>app/models/category.rb</h3>
    <h4><span class="red">80.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id                :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  type              :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  name              :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  unboxed_countable :boolean</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  parent_id         :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  position          :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  created_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  updated_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  property_id       :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">class Category &lt; Tag</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  has_and_belongs_to_many :departments</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :budgets, dependent: :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.maintenance</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    Category.find_by(name: &#39;Maintenance&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7fbc9476ecb4f51280e7b9b817719c61995a0649">
  <div class="header">
    <h3>app/models/concerns/stamp_user.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module StampUser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # ARAccountability Concern adds functions that help the applicaiton keep track of who is doing what</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # to various model objects.  This is a standard need for SAAS type applications.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  included do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # SentientUser gem allows us to make &#39;current_user&#39; available to the model object.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # Callbacks added to user stamp records up on create and update.</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="10">
          <span class="hits">3</span>
          
          <code class="ruby">    include SentientUser</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="11">
          <span class="hits">3</span>
          
          <code class="ruby">    before_save :stamp_updated_by</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="12">
          <span class="hits">3</span>
          
          <code class="ruby">    before_create :stamp_created_by, :stamp_updated_by</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="14">
          <span class="hits">3</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # ActiveSupport&#39;s presence method required to aleviate migration complaints</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="17">
          <span class="hits">3</span>
          
          <code class="ruby">    def stamp_created_by</code>
        </li>
      
        <li class="covered" data-hits="120" data-linenumber="18">
          <span class="hits">120</span>
          
          <code class="ruby">      self.created_by = self.class.current.present? ? self.class.current.id : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="21">
          <span class="hits">3</span>
          
          <code class="ruby">    def stamp_updated_by</code>
        </li>
      
        <li class="covered" data-hits="240" data-linenumber="22">
          <span class="hits">240</span>
          
          <code class="ruby">      self.updated_by = self.class.current.present? ? self.class.current.id : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="8371af4b9e9b6cb7455c4c49a0d0c2dd2e45a892">
  <div class="header">
    <h3>app/models/corporate.rb</h3>
    <h4><span class="red">40.0 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Corporate &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :users</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :connections</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :join_invitations, as: :targetable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :properties, -&gt;{ where(&#39;corporate_connections.state = ?&#39;, :active).order(:name) }, through: :connections</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_corporate(options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    return false if options[:name].blank? || options[:username].blank? || options[:useremail].blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    corporate = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    user = User.find_by(email: options[:useremail])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    if user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      user = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      corporate = Corporate.create! name: options[:name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      user = User.new name: options[:username], email: options[:useremail], corporate_id: corporate.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    corporate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3e77c25b15f687a556203d894b55a2b85e690775">
  <div class="header">
    <h3>app/models/corporate/connection.rb</h3>
    <h4><span class="red">75.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Corporate::Connection &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :corporate</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :created_by, class_name: User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :email, presence: true, confirmation: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_format_of :email, with: Devise.email_regexp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :email_confirmation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  REJECTED_STATES = [:corporate_rejected, :property_rejected]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  state_machine initial: :new do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    event :approve do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      transition new: :corporate_approved, corporate_approved: :active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    event :reject do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      transition new: :corporate_rejected, corporate_approved: :property_rejected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    after_transition any =&gt; :active do |connect, transition|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      corp_user = connect.corp_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      corp_user.current_property_role = Role.corporate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      corp_user.departments &lt;&lt; Department.find_or_create_by(name: &#39;All&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      corp_user.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def corp_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    User.corporate.where(email: email).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a6664d5ab569e1f82e4d37a6ef548c4c12b000d1">
  <div class="header">
    <h3>app/models/department.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Department &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_paranoid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :departments_users</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :users, through: :departments_users</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :departments_tags</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :categories, through: :departments_tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="547" data-linenumber="15">
          <span class="hits">547</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :with_roles, -&gt; (roles) { joins(:users =&gt; :user_roles).where(user_roles: {role_id: roles}).distinct }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3ec62e4dc23b27c9a77c32b638c534d4500bc63e">
  <div class="header">
    <h3>app/models/departments_tag.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class DepartmentsTag &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :category</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :department</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4e3ac73489fcdcabc92a15261a4c4150d6c1cb0b">
  <div class="header">
    <h3>app/models/departments_user.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class DepartmentsUser &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :department</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b05cb236d823b6f124ac73c1eddbbf73337c2a19">
  <div class="header">
    <h3>app/models/item.rb</h3>
    <h4><span class="red">63.92 %</span> covered</h4>
    <div>
      <b>97</b> relevant lines. 
      <span class="green"><b>62</b> lines covered</span> and
      <span class="red"><b>35</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id                      :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  name                    :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  count                   :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  frequency               :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  par_level               :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  image_file_name         :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  image_content_type      :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  image_file_size         :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  image_updated_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#  item_transactions_count :integer          default(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#  created_at              :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">#  updated_at              :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">#  unit_id                 :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">#  subpack_unit_id         :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">#  pack_unit_id            :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">#  unit_subpack            :float</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">#  subpack_size            :float</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">#  inventory_unit_id       :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">#  price_unit_id           :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">#  property_id             :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">#  is_taxable              :boolean</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">#  archived                :boolean          default(FALSE)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">#  description             :text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">#  is_asset                :boolean</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">#  purchase_cost           :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">#  purchase_cost_unit_id   :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">#  pack_size               :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">#  brand_id                :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">class Item &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  include PgSearch</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :unit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :subpack_unit, class_name: &#39;Unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :pack_unit, class_name: &#39;Unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :inventory_unit, class_name: &#39;Unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :price_unit, class_name: &#39;Unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :purchase_cost_unit, class_name: &#39;Unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_tags, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tags, through: :item_tags</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  has_and_belongs_to_many :categories, association_foreign_key: &#39;tag_id&#39;, join_table: &#39;item_tags&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  has_and_belongs_to_many :locations, association_foreign_key: &#39;tag_id&#39;, join_table: &#39;item_tags&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  has_and_belongs_to_many :lists, association_foreign_key: &#39;tag_id&#39;, join_table: &#39;item_tags&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_transactions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_requests</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_orders, through: :item_orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_requests, through: :item_requests</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :vendor_items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_receipts</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :vendors, through: :vendor_items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  has_attached_file :image, styles: {medium: &#39;300x300#&#39;, thumb: &#39;100x100#&#39;}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :transactions, class_name: &#39;ItemTransaction&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :brand</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :unit, reject_if: proc {|attributes| attributes[:name].blank?}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :pack_unit, reject_if: proc {|attributes| attributes[:name].blank?}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :subpack_unit, reject_if: proc {|attributes| attributes[:name].blank?}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :vendor_items, allow_destroy: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :vendor_items, :name, :unit, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :inventory_unit, :price_unit, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :property, associated: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :at_least_one_category</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  def at_least_one_category</code>
        </li>
      
        <li class="covered" data-hits="165" data-linenumber="74">
          <span class="hits">165</span>
          
          <code class="ruby">    errors.add :category_ids, &#39;at least one should be selected&#39; if category_ids.count &lt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :active, -&gt; {where archived: false}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :under_tag, lambda { |tags, type|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    tag_ids = tags.map{|tag| tag.self_and_descendants.pluck(:id)}.flatten</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    unless tags.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      items = joins(:tags).where(tags: {id: tag_ids})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      if type.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        items.where tags: {type: type}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :under_category, lambda {|categories| under_tag categories, &#39;Category&#39;}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :under_location, lambda {|locations| under_tag locations, &#39;Location&#39;}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :under_list, lambda {|lists| under_tag lists, &#39;List&#39;}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_user, lambda {|user| active.joins(:tags).where(tags: {id: Permission.allowed_tag_ids_for(user, :read)})}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="238" data-linenumber="95">
          <span class="hits">238</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  after_create :set_item_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_item_number</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="100">
          <span class="hits">81</span>
          
          <code class="ruby">    self.number = (Item.maximum(:number) || 9999) + 1</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="101">
          <span class="hits">81</span>
          
          <code class="ruby">    self.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  def price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    vendor_items.first.try(:price) || 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_countable_units?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    not tags.where(unboxed_countable: true).count.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    self.update_attribute :archived, true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">  def vendor_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    (vendor_items.preferred.limit(1).first.try(:vendor) || vendors.first).try(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  pg_search_scope :search_columns, (lambda do |search_for, query|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    common_config = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      using: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        tsearch: { dictionary: &quot;english&quot;, prefix: true } </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      query: query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    search_options = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      all: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        against: [:number, :name, :par_level],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        associated_against: { unit: [:name], vendors: [:name] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      number: { against: [:number] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      name: { against: [:name] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      unit: { associated_against: { unit: [:name] } },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      par: { against: [:par_level] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      vendor: { associated_against: { vendors: [:name] } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">    common_config.merge(search_options[search_for])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.search_tree(q)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    q = q.dup rescue {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    tags_id_eq_any = q.delete(&#39;tags_id_eq_any&#39;).reject &amp;:blank? rescue []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">    categories_id_eq_any = q.delete(&#39;categories_id_eq_any&#39;).reject &amp;:blank? rescue []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">    locations_id_eq_any = q.delete(&#39;locations_id_eq_any&#39;).reject &amp;:blank? rescue []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">    lists_id_eq_any = q.delete(&#39;lists_id_eq_any&#39;).reject &amp;:blank? rescue []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    Item.active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      .under_tag(Tag.where(id: tags_id_eq_any), nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      .under_category(Category.where(id: categories_id_eq_any))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      .under_location(Location.where(id: locations_id_eq_any))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      .under_list(List.where(id: lists_id_eq_any))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">      .search q</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">  def number</code>
        </li>
      
        <li class="covered" data-hits="121" data-linenumber="160">
          <span class="hits">121</span>
          
          <code class="ruby">    &#39;%05d&#39; % self[:number] unless self[:number].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">  def vendor_number(vendor_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">    vendor_items.where(vendor_id: vendor_id).first.try(:sku)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">  # factor for inventory unit to purchase unit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">  def purchase_unit_factor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    return 1 if unit_id == inventory_unit_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">    return 1 / (pack_size || 1) if inventory_unit_id == pack_unit_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">    return 1 / (pack_size || 1) / (subpack_size || 1) if inventory_unit_id == subpack_unit_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">    1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">  # factor for purchase unit to price unit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">  def price_unit_factor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">    return 1 if unit_id == price_unit_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    return pack_size || 1 if price_unit_id == pack_unit_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">    return (pack_size || 1) * (subpack_size || 1) if price_unit_id == subpack_unit_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    return 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">  def purchase_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">    purchase_cost.to_f * purchase_unit_factor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">  def pack_present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    self.pack_unit.present? &amp;&amp; self.pack_size.present? &amp;&amp; self.pack_size &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">  def subpack_present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    self.subpack_unit.present? &amp;&amp; self.subpack_size.present? &amp;&amp; self.subpack_size &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  # Removes the decimal part from the given number string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">  # @param [String, Fixnum, Float] number The product number to be cleaned up</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  # @return [String] The given +number+, sans decimal suffix</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.format_item_number(number)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    case number.class.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    when &#39;String&#39; then number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    when &#39;Fixnum&#39; then number.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    when &#39;Float&#39; then number.to_i.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b36274bc005d7e15180141896300f2f27b42028a">
  <div class="header">
    <h3>app/models/item_order.rb</h3>
    <h4><span class="red">65.52 %</span> covered</h4>
    <div>
      <b>29</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: item_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id                :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  purchase_order_id :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  item_id           :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  item_request_id   :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  quantity          :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  price             :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  created_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  updated_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">class ItemOrder &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :purchase_order</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :item</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :item_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_receipts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :purchase_order, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :item, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :item_request, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_numericality_of :quantity, greater_than: 0, allow_nil: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :price_unit_factor, to: :item</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :purchase_unit_factor, to: :item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def received</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    self.item_receipts.sum :quantity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def pending</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    [self.quantity - received, 0].max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def percent_complete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    received / self.quantity.to_f * 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def complete?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    pending.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def average_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    return price unless item_receipts.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    total_paid_for_reciepts = item_receipts.map{|ir| ir.quantity * ir.price}.reduce(&amp;:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    total_paid_for_reciepts / received</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def sku</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    self.purchase_order.vendor.vendor_items.where(&quot;vendor_items.item_id = ?&quot;, self.item.id).first.sku unless self.item.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    average_price * quantity * self.price_unit_factor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def original_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    price * quantity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e092cb510fdb11b11377cb2d620ca3a6052c2574">
  <div class="header">
    <h3>app/models/item_request.rb</h3>
    <h4><span class="red">72.73 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: item_requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id                  :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  purchase_request_id :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  item_id             :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  quantity            :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  count               :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  part_count          :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  created_at          :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  updated_at          :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  skip_inventory      :boolean</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">class ItemRequest &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :purchase_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :item</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :item_transaction, as: :purchase_step, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :item_order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_numericality_of :quantity, greater_than_or_equal_to: 0, allow_nil: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_presence_of :item</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :purchase_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :price_unit_factor, to: :item</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :purchase_unit_factor, to: :item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  before_update :set_prev_quantity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_item_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    (self.quantity || 0) * self.item.price.to_f * self.price_unit_factor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def order_quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    offset = [item.par_level.to_f - self.count.to_f, 0].max</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    offset = 0 if self.count.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    (self.purchase_unit_factor * offset).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def order_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    self.item_order.purchase_order.number if self.purchase_request.ordered?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_prev_quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    self.prev_quantity = self.quantity_was# if quantity_changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="42c454128ef23ed48f48b33200eb505bf202dad6">
  <div class="header">
    <h3>app/models/item_tag.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: item_tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  item_id  :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  tag_id   :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  tag_type :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  id       :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">class ItemTag &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :tag</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :tag_id, uniqueness: {scope: :item_id}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="495962d13806c997aee47ad8282ec2aeeb5142a1">
  <div class="header">
    <h3>app/models/list.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id                :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  type              :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  name              :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  unboxed_countable :boolean</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  parent_id         :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  position          :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  created_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  updated_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  property_id       :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">class List &lt; Tag</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">	has_many :user_list_usages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.top_six_for_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    lists = List.all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    # Get all lists ids that have been used to create orders and sort them by their use frequency</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    sorted_lists_ids = UserListUsage.where(user_id: user.id).group(:list_id).count.sort_by{|key, value| -value}.map(&amp;:first)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # Model.find([3,2,1]) won&#39;t return records in the order that you specified the ids. This achieves that.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    sorted_lists = sorted_lists_ids.map{|id| lists.detect{|list| list.id == id}}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    sorted_lists.concat(lists).uniq[0..5].compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="40165c28440da1190fd5ec056d0d7767b36b74d5">
  <div class="header">
    <h3>app/models/location.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id                :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  type              :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  name              :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  unboxed_countable :boolean</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  parent_id         :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  position          :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  created_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  updated_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  property_id       :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">class Location &lt; Tag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="48ead0e497ebd6c937c550960668617b9a132b43">
  <div class="header">
    <h3>app/models/maintenance.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Maintenance</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.table_name_prefix</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    &#39;maintenance_&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b9bfd69a64d4c55a1ac4ff313cd500067278bbeb">
  <div class="header">
    <h3>app/models/maintenance/checklist_item.rb</h3>
    <h4><span class="yellow">84.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Maintenance::ChecklistItem &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include RankedModel</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  ranks :area_row_order, scope: :room_areas, column: :row_order</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  ranks :item_row_order, with_same: :area_id, scope: :item_active, column: :row_order</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  ranks :public_area_row_order, with_same: :public_area_id, scope: :item_active, column: :row_order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :public_area, foreign_key: :public_area_id, :class_name =&gt; &#39;Maintenance::PublicArea&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :checklist_items, -&gt; { rank(:item_row_order).where(is_deleted: false) }, foreign_key: :area_id, class_name: &#39;Maintenance::ChecklistItem&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :area, foreign_key: :area_id, inverse_of: :checklist_items, class_name: &#39;Maintenance::ChecklistItem&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_presence_of :name, :maintenance_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :by_type, -&gt; (type) { where(maintenance_type: type) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :areas, -&gt; { rank(:area_row_order).where(area_id: nil, is_deleted: false) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :room_areas, -&gt; { areas.where(maintenance_type: :rooms) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :item_active, -&gt; { where(is_deleted: false) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :deleted, -&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    includes(:area)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      .where(&#39;areas_maintenance_checklist_items.is_deleted is NULL or</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">              areas_maintenance_checklist_items.is_deleted = true or</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">              maintenance_checklist_items.is_deleted = true&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      .references(:checklist_items)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :active, -&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    includes(:area)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      .where(&#39;areas_maintenance_checklist_items.is_deleted is NULL or</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">              areas_maintenance_checklist_items.is_deleted = false&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      .where(is_deleted: false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      .references(:checklist_items)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_public_areas, -&gt; { where.not(public_area_id: nil).rank(:public_area_row_order) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :non_areas, -&gt; { where.not(area_id: nil) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.areas_with_subcategories</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    room_areas.map do |area|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      {id: area.id, name: area.name, subcategories: area.checklist_items.rank(:item_row_order).active.select([:id, :name])}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b6c67531fdc31efa1205577d809b637ef6bca2b4">
  <div class="header">
    <h3>app/models/maintenance/checklist_item_maintenance.rb</h3>
    <h4><span class="red">72.73 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Maintenance::ChecklistItemMaintenance &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  STATUSES = [STATUS_NO_ISSUES=:no_issues, STATUS_FIXED=:fixed, STATUS_ISSUES=:issues]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :maintenance_record, foreign_key: :maintenance_record_id, class_name: &#39;Maintenance::MaintenanceRecord&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :maintenance_checklist_item, class_name: &#39;Maintenance::ChecklistItem&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :maintenance_equipment_checklist_item, :class_name =&gt; &#39;Maintenance::EquipmentChecklistItem&#39;, foreign_key: :maintenance_checklist_item_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :work_order, foreign_key: :checklist_item_maintenance_id, class_name: &#39;Maintenance::WorkOrder&#39;, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :inspection_detail, class_name: &#39;Maintenance::InspectionDetail&#39;, foreign_key: :checklist_item_maintenance_id, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :inspection_work_order, through: :inspection_detail, source: :work_order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :no_issues, -&gt; { where(status: STATUS_NO_ISSUES) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :fixed, -&gt; { where(status: STATUS_FIXED) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :issues, -&gt; { where(status: STATUS_ISSUES) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :active, -&gt; { joins(:maintenance_checklist_item).where(maintenance_checklist_item: {is_deleted: false}) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def cancel_inspection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    inspection_work_order.destroy if inspection_work_order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def maintainable_type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    maintenance_record.try(:maintainable_type)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def checklist_item_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    if maintainable_type == &#39;Maintenance::Equipment&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      maintenance_record.try(:maintainable).try(:equipment_type).try(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      maintenance_checklist_item.try(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def maintainable_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    maintenance_record.try(:maintainable).try(:to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d5b33985ad1dfb976ad35856f1e35b18080e29ad">
  <div class="header">
    <h3>app/models/maintenance/cycle.rb</h3>
    <h4><span class="red">30.16 %</span> covered</h4>
    <div>
      <b>126</b> relevant lines. 
      <span class="green"><b>38</b> lines covered</span> and
      <span class="red"><b>88</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Maintenance::Cycle &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :maintenance_records, foreign_key: :cycle_id, class_name: &#39;Maintenance::MaintenanceRecord&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  FREQUENCIES = 1..12</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  CYCLE_TYPES = [TYPE_ROOM=:room, TYPE_PUBLIC_AREA=:public_area]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  CYCLE_DESC = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    TYPE_ROOM.to_s =&gt; &#39;Guest Room PM&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    TYPE_PUBLIC_AREA.to_s =&gt; &#39;Public Area PM&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_presence_of :year, :frequency_months, :start_month, :cycle_type</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_uniqueness_of :start_month, scope: [:year, :cycle_type, :property]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :property, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id).order(:created_at) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :by_year, -&gt; (year) { where(year: year).order(:start_month) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :by_cycle_type, -&gt; (cycle_type) { where(cycle_type: cycle_type) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_over?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    DateTime.new(year, start_month, 1).months_since(frequency_months) &lt;= Date.today</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def cycle_type_desc</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    CYCLE_DESC[cycle_type]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_current_cycle?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    start_date = DateTime.new(year, start_month, 1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    start_date &lt;= Date.today &amp;&amp; start_date.months_since(frequency_months) &gt; Date.today</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def ordinal_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    total_cycles_in_maintenance_year = 12 / self.frequency_months </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    self.class.where(frequency_months: self.frequency_months, cycle_type: self.cycle_type).count % total_cycles_in_maintenance_year</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_quarter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    self.class.by_year(self.year).by_cycle_type(self.cycle_type).minimum(:start_month) / 3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def days_to_finish</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    cycle_end_date = DateTime.new(year, start_month, 1) + frequency_months.month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    (cycle_end_date - Date.current).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def period</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    start_date = Date.new(year, start_month, 1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    end_date = start_date + (frequency_months - 1).months</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    start_format = (start_date.year == end_date.year ? &#39;%b&#39; : &#39;%b %Y&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    start_date == end_date ? end_date.strftime(&#39;%b %Y&#39;) : &quot;#{start_date.strftime(start_format)} ~ #{end_date.strftime(&#39;%b %Y&#39;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def rooms_remaining</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    # If rooms have been maintained in current cycle, treats it as completed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    # This scenario is for previous.rooms_remaining</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    if Maintenance::Cycle.current.id == id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      current_finished_maintainable_ids = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      current_finished_maintainable_ids = Maintenance::Cycle.current.maintenance_records.for_rooms.finished.pluck(:maintainable_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    Maintenance::Room.where.not(id: maintenance_records.for_rooms.finished.pluck(:maintainable_id) + current_finished_maintainable_ids )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def rooms_in_progress</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    Maintenance::Room.where(id: maintenance_records.for_rooms.in_progress.pluck(:maintainable_id) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def rooms_completed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    Maintenance::Room.where(id: maintenance_records.for_rooms.finished.pluck(:maintainable_id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def rooms_inspected</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    Maintenance::Room.where(id: maintenance_records.for_rooms.completed.pluck(:maintainable_id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  def number_of_rooms_to_inspect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    Property.current.target_inspection_count - rooms_inspected.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  def rooms_to_inspect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    inspect_count = Property.current.target_inspection_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    in_inspection = maintenance_records.for_rooms.in_inspection.pluck(:maintainable_id, :updated_at, :id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    completed = maintenance_records.for_rooms.completed.pluck(:maintainable_id, :inspected_on, :id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    to_inspect = maintenance_records.for_rooms.to_inspect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">                     .pluck(:maintainable_id, :completed_on, :id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">                     .sort_by {|r| r[1]}.reverse!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">                     .uniq {|r| r[0]}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    completed_ids = completed.map { |record| record[0] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    to_inspect = to_inspect.delete_if { |record| completed_ids.include?(record[0]) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    in_inspection = in_inspection.delete_if { |record| completed_ids.include?(record[0]) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    rest_count = inspect_count - in_inspection.count - completed.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">    rest = if rest_count &lt;= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">             []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">           else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">             rest_count &gt; to_inspect.count ? to_inspect : to_inspect.sample(rest_count)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">           end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    list = in_inspection.sort_by { |e| e[1] }.reverse! + rest.sort_by { |e| e[1] } + completed.sort_by { |e| e[1] }.reverse!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    Maintenance::Room.with_maintenance_info list.collect{|id| [id[0], id[2]] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  def public_areas_to_inspect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    in_inspection = maintenance_records.for_public_areas.in_inspection.pluck(:maintainable_id, :updated_at, :id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    completed = maintenance_records.for_public_areas.completed.pluck(:maintainable_id, :inspected_on, :id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    to_inspect = maintenance_records.for_public_areas.to_inspect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">                     .pluck(:maintainable_id, :completed_on, :id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">                     .sort_by {|r| r[1]}.reverse!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">                     .uniq {|r| r[0]}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">    completed_ids = completed.map { |record| record[0] } + in_inspection.map { |record| record[0] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    to_inspect.reject! { |record| completed_ids.include?(record[0]) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    list = in_inspection.sort_by { |e| e[1] }.reverse! + to_inspect.sort_by { |e| e[1] } + completed.sort_by { |e| e[1] }.reverse!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    Maintenance::PublicArea.with_maintenance_info list.collect{|id| [id[0], id[2]] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  def rooms_completed_percent</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    Maintenance::Room.count == 0 ? 0 : (rooms_completed.count * 100 / Maintenance::Room.count).round</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">  def public_areas_remaining</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    # If rooms have been maintained in current cycle, treats it as completed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    # This scenario is for previous.rooms_remaining</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">    if Maintenance::Cycle.current(:public_area).id == id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      current_finished_maintainable_ids = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      current_finished_maintainable_ids = Maintenance::Cycle.current(:public_area)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">                                                            .maintenance_records</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">                                                            .for_public_areas</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">                                                            .finished</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">                                                            .pluck(:maintainable_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    finished_ids = maintenance_records.for_public_areas.finished.pluck(:maintainable_id) + current_finished_maintainable_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    Maintenance::PublicArea.where.not(id: finished_ids).active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">  def public_areas_in_progress</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    Maintenance::PublicArea.where(id: maintenance_records.for_public_areas.in_progress.pluck(:maintainable_id) ).active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  def public_areas_completed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    Maintenance::PublicArea.where(id: maintenance_records.for_public_areas.finished.pluck(:maintainable_id)).active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">  def public_areas_inspected</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    Maintenance::PublicArea.where(id: maintenance_records.for_public_areas.completed.pluck(:maintainable_id)).active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.current(cycle_type = &#39;room&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    by_cycle_type(cycle_type).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.previous(cycle_type = &#39;room&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    return nil if by_cycle_type(cycle_type).count &lt; 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    by_cycle_type(cycle_type).order(:created_at).last(2).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">  def pm_start_month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">    sm = start_month - (ordinality_number - 1) * frequency_months</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    sm = sm + 12 if sm &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">    sm</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.generate_first_cycle(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">    current_month = Date.today.month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    start_month = params[:start_month].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    frequency_months = params[:frequency].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">    while current_month &gt;= start_month do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      start_month += frequency_months</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">    start_month -= frequency_months</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    cycles_in_a_year  = 12 / frequency_months</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    ordinality_number_idx = (start_month - params[:start_month].to_i) / frequency_months</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">    ordinality_number = ordinality_number_idx.divmod(cycles_in_a_year).last + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">    cycle = Maintenance::Cycle.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    cycle.ordinality_number = ordinality_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">    cycle.start_month = start_month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    cycle.frequency_months = frequency_months</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">    cycle.user_id = params[:user_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">    cycle.year = Date.today.year</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    cycle.cycle_type = params[:cycle_type]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">    cycle.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">    cycle</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">  # generates next cycle record. Called by recurring job</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.generate_next_cycle(cycle_type)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    current_cycle = current(cycle_type)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    return current_cycle unless current_cycle.is_over?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    total_cycles_in_a_year = 12 / current_cycle.frequency_months</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">    new_cycle = current_cycle.dup</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">    new_cycle.ordinality_number = current_cycle.ordinality_number.modulo(total_cycles_in_a_year) + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">    new_cycle_start_date = Date.new(current_cycle.year, current_cycle.start_month) + current_cycle.frequency_months.months</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">    new_cycle.year = new_cycle_start_date.year </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">    new_cycle.start_month = new_cycle_start_date.month</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    new_cycle.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    new_cycle</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="75f03a30026de5749e02c8283fd52e325b447bfe">
  <div class="header">
    <h3>app/models/maintenance/maintenance_record.rb</h3>
    <h4><span class="red">66.07 %</span> covered</h4>
    <div>
      <b>56</b> relevant lines. 
      <span class="green"><b>37</b> lines covered</span> and
      <span class="red"><b>19</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Maintenance::MaintenanceRecord &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  self.table_name = :maintenance_records</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include PublicActivity::Common</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include ::StampUser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  STATUSES = [STATUS_FINISHED=:finished, STATUS_IN_PROGRESS=:in_progress, STATUS_IN_INSPECTION=:inspection, STATUS_COMPLETED=:completed]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :cycle, foreign_key: :cycle_id, class_name: &#39;Maintenance::Cycle&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :maintainable, polymorphic: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :inspected_by, foreign_key: :inspected_by_id, class_name: &#39;User&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :completed_by, foreign_key: :completed_by_id, class_name: &#39;User&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :equipment_checklist_group, class_name: &#39;Maintenance::EquipmentChecklistItem&#39;, foreign_key: :equipment_checklist_group_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :checklist_item_maintenances, foreign_key: :maintenance_record_id, class_name: &#39;Maintenance::ChecklistItemMaintenance&#39;, dependent: :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"> </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :finished, -&gt;{ where(status: [STATUS_FINISHED, STATUS_IN_INSPECTION, STATUS_COMPLETED]) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :in_progress, -&gt;{ where(status: STATUS_IN_PROGRESS) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :completed, -&gt; { where(status: STATUS_COMPLETED) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :to_inspect, -&gt; { where(status: STATUS_FINISHED) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :in_inspection, -&gt; { where(status: STATUS_IN_INSPECTION) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_rooms, -&gt; { where(maintainable_type: &#39;Maintenance::Room&#39;)}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_public_areas, -&gt; { where(maintainable_type: &#39;Maintenance::PublicArea&#39;)}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_equipments, -&gt; { where(maintainable_type: &#39;Maintenance::Equipment&#39;)}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_current_cycle, -&gt; (cycle_type = &#39;room&#39;) { where(cycle_id: Maintenance::Cycle.current(cycle_type).id) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_cycle, -&gt; (cycle_id) { where(cycle_id: cycle_id).first }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :by_cycle, -&gt; (cycle_id) { where(cycle_id: cycle_id) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :by_type, -&gt; (type) { where(maintainable_type: type) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :by_status, -&gt; (status) { where(status: status) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :stamp_whodunnit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  after_save :create_pm_activity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def in_inspection?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    status == STATUS_IN_INSPECTION.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def completed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    status == STATUS_COMPLETED.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def cancel_inspection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    checklist_item_maintenances.map(&amp;:cancel_inspection)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    self.status = STATUS_FINISHED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    self.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def maintainable_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    maintainable.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def minutes_to_complete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    (completed_on - created_at).to_i / 60</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def maintainable_type_short</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    maintainable_type.underscore[12..-1] # maintenance/room -&gt; room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def stamp_whodunnit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    if status_changed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      case status.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        when STATUS_FINISHED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          self.completed_by_id = self.updated_by</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">          self.completed_on = Time.current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        when STATUS_COMPLETED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">          self.inspected_by_id = self.updated_by</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">          self.inspected_on = Time.current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_pm_activity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    if status_changed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      case status.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        when STATUS_IN_PROGRESS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">          create_activity key: &quot;#{maintainable_type_short}.pm_started&quot;, recipient: Property.current, owner: user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        when STATUS_FINISHED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">          create_activity key: &quot;#{maintainable_type_short}.pm_finished&quot;, recipient: Property.current, owner: completed_by</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">        when STATUS_COMPLETED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">          create_activity key: &quot;#{maintainable_type_short}.pm_inspected&quot;, recipient: Property.current, owner: inspected_by</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="12fbbebf597fa2027f8bcf52d4d645353ee22268">
  <div class="header">
    <h3>app/models/maintenance/public_area.rb</h3>
    <h4><span class="red">26.03 %</span> covered</h4>
    <div>
      <b>73</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>54</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Maintenance::PublicArea &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include RankedModel</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  ranks :row_order, scope: :active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :maintenance_records, as: :maintainable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :maintenance_checklist_items, -&gt; { rank(:public_area_row_order) } ,foreign_key: :public_area_id, :class_name =&gt; &#39;Maintenance::ChecklistItem&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id).rank(:row_order) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :active, -&gt; { where(is_deleted: false) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.areas_with_subcategories</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    active.map do |area|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      {id: area.id, name: area.name, subcategories: area.maintenance_checklist_items.active.rank(:public_area_row_order).select([:id, :name]) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def checklist_items</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    maintenance_checklist_items.active.rank(:public_area_row_order).select([:id, :name])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.by_progress</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    public_areas = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    all.each do |area|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      area_hash = JSON::parse(area.to_json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      area_hash.merge!(maintenance_in_progress: area.is_currently_in_progress?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      area_hash.merge!(done_percentage: area.currently_maintained_percentage) if area.is_currently_in_progress?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      public_areas &lt;&lt; area_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    public_areas</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.with_maintenance_info(ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    public_areas = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    cycles_count = Property.current.target_inspection_percent &gt; 0 ? 100 / Property.current.target_inspection_percent : 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    ids.each do |info|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      area = Maintenance::PublicArea.active.find_by id: info[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      next if area.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      area_hash = JSON.parse area.to_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      maintenance_record = area.maintenance_records.for_current_cycle(:public_area).find info[1] if Maintenance::Cycle.current(:public_area)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      if maintenance_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        area_hash.merge! completed_by: maintenance_record.completed_by.try(:name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        area_hash.merge! completed_on: I18n.l(maintenance_record.completed_on, format: :date_and_am_pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        area_hash.merge! in_inspection: maintenance_record.in_inspection?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        area_hash.merge! completed: maintenance_record.completed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        area_hash.merge! fixed: maintenance_record.checklist_item_maintenances.fixed.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        area_hash.merge! work_orders: maintenance_record.checklist_item_maintenances.issues.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      last_inspection = area.maintenance_records.completed.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      if last_inspection.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        area_hash.merge! ever_inspected: last_inspection.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        area_hash.merge! last_inspected_on: I18n.l(last_inspection.inspected_on, format: :medium)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        area_hash.merge! last_inspected_by: last_inspection.inspected_by.try(:name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        area_hash.merge! inspected_count: area.maintenance_records.completed.where.not(cycle: Maintenance::Cycle.current(:public_area)).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        area_hash.merge! cycles_count: [cycles_count, 2].max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      public_areas &lt;&lt; area_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    public_areas</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_currently_in_progress?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    current_maintenance_record.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_maintenance_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    @result ||= maintenance_records.in_progress.for_current_cycle(:public_area).first if Maintenance::Cycle.current(:public_area)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  def currently_maintained_percentage</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    if is_currently_in_progress?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      return 100 if maintenance_checklist_items.active.count.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      (current_maintenance_record.checklist_item_maintenances.active.count.to_f * 100 / maintenance_checklist_items.active.count).round</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_maintenance(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    record = maintenance_records.for_current_cycle(:public_area).in_progress.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    if record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      record = maintenance_records.build(cycle_id: Maintenance::Cycle.current(:public_area).id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      record.status = Maintenance::MaintenanceRecord::STATUS_IN_PROGRESS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      record.started_at = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      record.user = user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      record.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">    record</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_inspection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    record = maintenance_records.for_current_cycle(:public_area).in_inspection.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">    if record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      record = maintenance_records.for_current_cycle(:public_area).to_inspect.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      record.status = Maintenance::MaintenanceRecord::STATUS_IN_INSPECTION</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      record.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    record</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4b555f1335d8225ec1fc745dd993ffdc16c8123b">
  <div class="header">
    <h3>app/models/maintenance/room.rb</h3>
    <h4><span class="red">29.21 %</span> covered</h4>
    <div>
      <b>89</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>63</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Maintenance::Room &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :maintenance_records, as: :maintainable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :work_orders, as: :maintainable, class_name: &#39;Maintenance::WorkOrder&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :floors_with_room_count, -&gt; { order(:floor).group(:floor).count}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :rooms_on_floor, -&gt;(floor) { where(floor: floor).order(:room_number).includes(:maintenance_records) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :last_week, -&gt; { includes(:maintenance_records).where(maintenance_records: {completed_on: (Time.current - 1.weeks).beginning_of_day..Time.current.end_of_day}) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_presence_of :floor, :room_number</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_uniqueness_of :room_number, scope: [:property_id]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :property, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  alias_attribute :name, :room_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.all_floors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    pluck(:floor).uniq.sort</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # TODO Need to make this more simpler</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.by_floors(with_maintenance_record=true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    floors = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    all_floors.each do |floor|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      floors &lt;&lt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        floor: floor,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        rooms: rooms_on_floor(floor).map do |room|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          room_hash = { id: room.id, room_number: room.room_number, maintenance_in_progress: room.is_currently_in_progress? }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">          if with_maintenance_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">            room_hash[:done_percentage] = room.currently_maintained_percentage if room.is_currently_in_progress?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">            maintenance_record = room.maintenance_records.for_current_cycle.first if Maintenance::Cycle.current.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">            unless maintenance_record.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">              room_hash[:maintenance_record] = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">                id: maintenance_record.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">                fixed: maintenance_record.checklist_item_maintenances.fixed.count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">                work_orders: maintenance_record.checklist_item_maintenances.issues.count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">                completed_by: maintenance_record.completed_by.try(:name),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">                in_inspection: maintenance_record.in_inspection?,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">          room_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    floors.sort_by! { |f| f[:floor] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.with_maintenance_info(ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    results = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    ids.each do |info|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      room = Maintenance::Room.find_by id: info[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      next if room.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      room_hash = JSON.parse room.to_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      maintenance_record = room.maintenance_records.for_current_cycle.find(info[1]) if Maintenance::Cycle.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      if maintenance_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        room_hash.merge! completed_by: maintenance_record.completed_by.try(:name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        room_hash.merge! completed_on: I18n.l(maintenance_record.completed_on, format: :date_and_am_pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        room_hash.merge! in_inspection: maintenance_record.in_inspection?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        room_hash.merge! completed: maintenance_record.completed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        room_hash.merge! status: maintenance_record.status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        room_hash.merge! fixed: maintenance_record.checklist_item_maintenances.fixed.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        room_hash.merge! work_orders: maintenance_record.checklist_item_maintenances.issues.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      last_inspection = room.maintenance_records.completed.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      if last_inspection.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        room_hash.merge! ever_inspected: last_inspection.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        room_hash.merge! last_inspected_on: I18n.l(last_inspection.inspected_on, format: :medium)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        room_hash.merge! last_inspected_by: last_inspection.inspected_by.try(:name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        room_hash.merge! inspected_count: room.maintenance_records.completed.where.not(cycle: Maintenance::Cycle.current(:room)).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        cycles_count = Property.current.target_inspection_percent &gt; 0 ? 100 / Property.current.target_inspection_percent : 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        room_hash.merge! cycles_count: [cycles_count , 2].max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      results &lt;&lt; room_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_maintenance(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    record = maintenance_records.for_current_cycle(:room).in_progress.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    if record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      record = maintenance_records.build(cycle_id: Maintenance::Cycle.current.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      record.status = Maintenance::MaintenanceRecord::STATUS_IN_PROGRESS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      record.started_at = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      record.user = user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      record.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    record</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_inspection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">    record = maintenance_records.for_current_cycle.in_inspection.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    if record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      record = maintenance_records.for_current_cycle.to_inspect.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      record.status = Maintenance::MaintenanceRecord::STATUS_IN_INSPECTION</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      record.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    record</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.room_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    self.all.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.any_missed_rooms?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    Maintenance::Cycle.previous.rooms_remaining.any? if Maintenance::Cycle.previous</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_currently_in_progress?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    current_maintenance_record.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_maintenance_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    @result ||= maintenance_records.in_progress.for_current_cycle.first if Maintenance::Cycle.current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  def latest_maintenance_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    last_completed = maintenance_records.finished.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">    results = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        started_by: current_maintenance_record.try(:user).try(:name),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        started_on: current_maintenance_record ? I18n.l(current_maintenance_record.try(:created_at), format: :short) : nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        status: current_maintenance_record.try(:status),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        floor: floor,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        room_number: room_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    if last_completed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      results.merge!({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          completed_by: last_completed.completed_by.try(:name),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">          completed_on: I18n.l(last_completed.completed_on, format: :short),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          last_maintained_cycle: last_completed.cycle.ordinality_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  # returns integer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  def currently_maintained_percentage</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    if is_currently_in_progress?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      (current_maintenance_record.checklist_item_maintenances.active.count.to_f * 100 / Maintenance::ChecklistItem.by_type(:rooms).non_areas.active.count).round</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    I18n.t(&#39;maintenance.work_orders.maintainable.room&#39;, room_number: room_number) </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1a48da2986266dca740ba141919fe50a066703a7">
  <div class="header">
    <h3>app/models/maintenance/work_order.rb</h3>
    <h4><span class="red">53.1 %</span> covered</h4>
    <div>
      <b>113</b> relevant lines. 
      <span class="green"><b>60</b> lines covered</span> and
      <span class="red"><b>53</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Maintenance::WorkOrder &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Rails.application.routes.url_helpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include PublicActivity::Common</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include ::StampUser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  has_paper_trail :only =&gt; [:status]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_paranoid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  STATUSES = [STATUS_OPEN=:open, STATUS_CLOSED=:closed, STATUS_WORKING=:working]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  MAINTEINABLE_TYPES = %w(Maintenance::Room Maintenance::PublicArea Maintenance::Equipment) </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  PRIORITIES = %w(high medium low) # h =&gt; high, m =&gt; medium, l =&gt; low</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  EXTRA_USERS = [</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    [THIRD_PARTY_NAME = &#39;3rd Party&#39;, THIRD_PARTY = -1],</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    [UNASSIGNED_NAME = &#39;Unassigned&#39;, UNASSIGNED = -2]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  EXTRA_IDS = [THIRD_PARTY, UNASSIGNED]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  belongs_to :maintainable, polymorphic: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  belongs_to :checklist_item_maintenance, foreign_key: :checklist_item_maintenance_id, class_name: &#39;Maintenance::ChecklistItemMaintenance&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :opened_by, foreign_key: :opened_by_user_id, class_name: &#39;User&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :closed_by, foreign_key: :closed_by_user_id, class_name: &#39;User&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :updator, foreign_key: :updated_by, class_name: &#39;User&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :assigned_to, class_name: &#39;User&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :attachments, class_name: &#39;Maintenance::Attachment&#39;, as: :attachmentable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :messages, as: :messagable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :materials, class_name: &#39;Maintenance::Material&#39;, foreign_key: :work_order_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :material_items, class_name: &#39;Item&#39;, through: :materials, source: :item</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :schedule, -&gt; { active }, as: :eventable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :occurrences, through: :schedule</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :past_schedules, -&gt; { deleted }, class_name: &#39;Schedule&#39;, as: :eventable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  has_many :past_occurrences, through: :past_schedules, class_name: &#39;Occurrence&#39;, source: :occurrences</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :occurrence, as: :eventable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :opened, -&gt; { where(status: STATUS_OPEN) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :closed, -&gt; { where(status: STATUS_CLOSED) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :active, -&gt; { where.not(status: STATUS_CLOSED) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  scope :unassigned, -&gt; { where(assigned_to_id: UNASSIGNED) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :by_assignee, -&gt; (assigned_to) { where(assigned_to_id: assigned_to) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :with_recurring, -&gt; { where(recurring: [true, false]) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :checklist_item_maintenance</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :attachments, :allow_destroy =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  before_update :update_closed_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  before_save :set_default_values</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  after_save :send_notification_and_mail_to_assignee</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="49">
          <span class="hits">36</span>
          
          <code class="ruby">  after_save :create_wo_activity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  def self.default_scope</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    where(property_id: Property.current_id, deleted_at: nil, recurring: false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">  def self.by_priority</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    ret = &#39;CASE&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    PRIORITIES.map { |p| p[0] }.each_with_index do |p, i|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      ret &lt;&lt; &quot; WHEN priority = &#39;#{p}&#39; THEN #{i}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    ret &lt;&lt; &#39; END&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">  scope :order_by_priority, -&gt; { order(by_priority) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  def self.by_departments(departments, sql = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    user_ids = DepartmentsUser.where(department_id: departments).pluck(:user_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    all.where(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      &quot;assigned_to_id in (?) or opened_by_user_id in (?) #{&#39;OR &#39; + sql if sql}&quot;, user_ids, user_ids</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  def self.by_filter(filter)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    records = all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    records = records.send filter[:status] if filter[:status]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    records = records.where(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      closed_at: Date.parse(filter[:from]).beginning_of_day..Date.parse(filter[:to]).end_of_day</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    ) if filter[:from] &amp;&amp; filter[:to]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    records = records.where(maintainable_type: filter[:wo_type]) if filter[:wo_type]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">    records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  def schedule_id=(schedule_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">    unless schedule_id.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      schedule = Schedule.find schedule_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      schedule.eventable = self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      schedule.save</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      self.update(recurring: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">  def closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    status == STATUS_CLOSED.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  def recurring?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    self.recurring || (occurrence &amp;&amp; occurrence.schedule.eventable.recurring?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">  def require_next_occurrence?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    self.closed? &amp;&amp; self.occurrence.present? &amp;&amp; self.occurrence.eventable.recurring?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  def get_schedule</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    recurring? ? schedule || occurrence.schedule.eventable.schedule : self.build_schedule</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">  def number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    occurrence.nil? ? &quot;##{id}&quot; : occurrence.number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">  def trending_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    occurrence.nil? ? self.id : occurrence.schedule.eventable_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">  def days_opened</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">    (Date.current - opened_at.to_date).to_i + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  def days_elapsed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    (closed_at.to_date - opened_at.to_date).to_i + 1 if closed? &amp;&amp; closed_at &amp;&amp; opened_at</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  def checklist_item_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    if maintainable_type == &#39;Maintenance::Equipment&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">      maintainable.try(:equipment_type).try(:name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      checklist_item_maintenance.try(:maintenance_checklist_item).try(:name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  def location_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">    maintainable_id.present? &amp;&amp; maintainable.to_s + ( checklist_item_name ? &quot; | #{checklist_item_name}&quot; : &#39;&#39;) || other_maintainable_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  def location_detail</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    maintainable_detail = if maintainable_id.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">                            if maintainable.is_a? Maintenance::Room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">                              maintainable_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">                            elsif maintainable.is_a? Maintenance::PublicArea</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">                              &quot;Public Area &#39;#{maintainable_name}&#39;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">                            elsif maintainable.is_a? Maintenance::Equipment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">                              &quot;Equipment &#39;#{maintainable_name}&#39;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">                            end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">                          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">                            other_maintainable_location</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">                          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">    [maintainable_detail, checklist_item_name].reject(&amp;:blank?).join(&quot; / &quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  # returns:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  # { &quot;Maintenance::Room&quot; =&gt; { 1 =&gt; &quot;101&quot;,  2 =&gt; &quot;102&quot; }, &quot;Maintenance::PublicArea&quot; =&gt; { 1 =&gt; &quot;Conference Room A&quot;, 4 =&gt; &quot;Gym&quot; }}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  def self.maintenable_entities</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">    Maintenance::WorkOrder::MAINTEINABLE_TYPES.inject({}) do |hash, mt|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      hash[mt] = mt.constantize.all.inject({}){ |mt_hash, mt_record| mt_hash[mt_record.id]= mt_record.name; mt_hash }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">  def maintainable_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    maintainable_id.present? ? maintainable.to_s : other_maintainable_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  def assigned_to_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">    if assigned_to_id &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      assigned_to.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      assigned_to_id == THIRD_PARTY ? THIRD_PARTY_NAME :</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">        assigned_to_id == UNASSIGNED ? UNASSIGNED_NAME : &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">  def due_to_date=(val)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    if val =~ %r{\A(\d+)/(\d+)/(\d{4})\z}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      write_attribute(:due_to_date, Date.new($3.to_i, $1.to_i, $2.to_i))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">  def pm_work_order?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    checklist_item_maintenance &amp;&amp; checklist_item_maintenance.maintenance_record</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">  def sub_category</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    case maintainable_type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">    when &#39;Maintenance::Room&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      checklist_item_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">    when &#39;Maintenance::PublicArea&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">      maintainable.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    when &#39;Maintenance::Equipment&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      maintainable.equipment_type.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">  def messages_count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    messages.count + (closed? &amp;&amp; closing_comment.present? ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">  def material_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">    materials.map(&amp;:cost).reduce(&amp;:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">  def update_closed_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    if status_changed? &amp;&amp; closed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      self.closed_at = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">      self.closed_by = updator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">  def send_notification_and_mail_to_assignee</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    if (assigned_to_id_changed? || priority_changed?) &amp;&amp; assigned_to &amp;&amp; priority==&#39;h&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      Notification.assigned_work_order(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">        MaintenanceWorkOrderMailer.work_order_notification_to_assignee(self).deliver!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">        Airbrake.notify(e)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">        Rails.logger.error &quot;Failed to send notification for work order - #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">      if assigned_to.phone_number.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">        TWILIO.send_sms(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">          assigned_to.phone_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">          I18n.t(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">            &quot;maintenance.work_orders.sms.assigned&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">            id: id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">            url: &quot;#{maintenance_work_orders_url}?id=#{id}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">            assignee_name: assigned_to.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">            location_and_checklist_name: [maintainable &amp;&amp; maintainable.to_s || other_maintainable_location, checklist_item_name].join(&#39;, &#39;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">            hotel_name: Property.current.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">  def create_wo_activity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">    if created_at_changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      create_activity key: &#39;work_order.created&#39;, recipient: Property.current, owner: opened_by</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">    elsif status_changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">      case status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">        when &#39;open&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">          create_activity key: &#39;work_order.reopened&#39;, recipient: Property.current, owner: updator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">        when &#39;closed&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">          create_activity key: &#39;work_order.closed&#39;, recipient: Property.current, owner: updator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">        when &#39;working&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">          create_activity key: &#39;work_order.status_working&#39;, recipient: Property.current, owner: updator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">  def set_default_values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">    self.status ||= STATUS_OPEN.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    self.assigned_to_id ||= UNASSIGNED</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    self.priority ||= &#39;m&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f55548d14f0220786d02ff7e5d37a6b7e11e795e">
  <div class="header">
    <h3>app/models/notification.rb</h3>
    <h4><span class="red">25.64 %</span> covered</h4>
    <div>
      <b>39</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>29</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Notification &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="6">
          <span class="hits">37</span>
          
          <code class="ruby">  scope :unread, -&gt; { where.not read: true }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :deleted, -&gt; { where deleted: nil }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="9">
          <span class="hits">37</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id).order(created_at: :desc) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.purchase_order_fax_notification user_id, type, id, message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    notification             = Notification.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    notification.user_id     = user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    notification.property_id = Property.current_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    notification.model_id    = id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    notification.ntype       = type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    notification.message     = message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    notification.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.purchase_request_approval user_ids, id, message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    user_ids.each do |user_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      notification             = Notification.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      notification.user_id     = user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      notification.ntype       = &#39;request.approve&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      notification.model_id    = id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      notification.message     = message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      notification.property_id = Property.current_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      notification.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.purchase_request_checked user_id, id, message, state</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    notification             = Notification.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    notification.user_id     = user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    notification.ntype       = &quot;request.#{state}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    notification.model_id    = id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    notification.message     = message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    notification.property_id = Property.current_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    notification.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.assigned_work_order(work_order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    notification             = Notification.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    notification.user_id     = work_order.assigned_to_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    notification.ntype       = &#39;work_order.assigned&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    notification.model_id    = work_order.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    notification.message     = &quot;You have been assigned to new work order #{work_order.location_name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    notification.property_id = Property.current_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    notification.save </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7602495140c597d5e4304ba00e2fef4356ab6fd7">
  <div class="header">
    <h3>app/models/permission.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id             :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  role_id        :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  department_id  :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  subject        :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  action         :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  created_at     :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  updated_at     :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">class Permission &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  serialize :options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :role</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :department</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :permission_attribute</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :permitted, -&gt; (role_ids, department_ids) { where(role_id: role_ids, department_id: department_ids) }</code>
        </li>
      
        <li class="covered" data-hits="148" data-linenumber="24">
          <span class="hits">148</span>
          
          <code class="ruby">  scope :by_attribute_subject, -&gt; (subject) { includes(:permission_attribute).where(permission_attributes: { subject: subject.to_s } ) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :by_attribute_action, -&gt; (action) { includes(:permission_attribute).where(permission_attributes: { action: action.to_s } ) }</code>
        </li>
      
        <li class="covered" data-hits="155" data-linenumber="26">
          <span class="hits">155</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7ef866112d399367a107bca193621885b42a1e5b">
  <div class="header">
    <h3>app/models/permission_attribute.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class PermissionAttribute &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  serialize :options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :permissions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items, foreign_key: :parent_id, class_name: &#39;PermissionAttribute&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :parent, foreign_key: :parent_id, inverse_of: :items, class_name: &#39;PermissionAttribute&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :roots, -&gt; { where(parent_id: nil).order(created_at: :asc).includes(:items) }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  scope :access_attributes, -&gt; { where(subject: :access) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :level2, -&gt; { where(parent_id: roots.pluck(:id)) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :assignable, -&gt; { where(subject: &#39;maintenance_work_order&#39;, action: :assignable) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5c075d37b3fb65d2a7cc9af16470bf5c4abf4346">
  <div class="header">
    <h3>app/models/property.rb</h3>
    <h4><span class="red">40.32 %</span> covered</h4>
    <div>
      <b>124</b> relevant lines. 
      <span class="green"><b>50</b> lines covered</span> and
      <span class="red"><b>74</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: properties</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id             :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  name           :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  created_at     :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  updated_at     :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  contact_name   :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  street_address :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  zip_code       :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  city           :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  email          :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#  phone          :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#  fax            :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">class Property &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_commentable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :user_roles</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :join_invitations, as: :targetable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :users, through: :user_roles</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :gm_roles, -&gt; { where(role_id: Role.gm.id)}, class_name: UserRole</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :gms, through: :gm_roles, class_name: User, source: :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tags</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :categories</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :locations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :lists</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :vendors</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :departments</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_requests</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_receipts</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :permissions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :alarms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  has_many :schedules</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  # maintenance part</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :maintenance_cycles, :class_name =&gt; &#39;Maintenance::Cycle&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :maintenance_rooms, :class_name =&gt; &#39;Maintenance::Room&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :maintenance_public_areas, :class_name =&gt; &#39;Maintenance::PublicArea&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  has_many :maintenance_records, :class_name =&gt; &#39;Maintenance::MaintenanceRecord&#39;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="46">
          <span class="hits">4</span>
          
          <code class="ruby">  has_many :maiontenance_work_orders, class_name: &#39;Maintenance::WorkOrder&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  has_one :corporate_connection, -&gt; { where.not(state: Corporate::Connection::REJECTED_STATES) }, class_name: Corporate::Connection</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :corporate, -&gt; { where(&#39;corporate_connections.state = ?&#39;, :active) }, through: :corporate_connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  serialize :settings, Hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :room_types</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  def highest_gm_approval_limit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    Role.gm.user_roles.order(order_approval_limit: :desc).limit(1).pluck(:order_approval_limit).first</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  def proper_approvers total_price, current_user_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    Role.gm.user_roles.where(&#39;order_approval_limit &gt; ? and user_id != ?&#39;, total_price.to_f, current_user_id).includes(:user).map(&amp;:user)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  def setting</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    settings || {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  def target_inspection_percent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    setting[:target_inspection_percent].to_i || 10</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  def target_inspection_rate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    target_inspection_percent / 100.0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  def target_inspection_count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    (target_inspection_rate * maintenance_rooms.count).round</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="80">
          <span class="hits">151</span>
          
          <code class="ruby">  class &lt;&lt; self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    def current_id=(id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      RequestStore.store[:property_id] = id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="4082" data-linenumber="84">
          <span class="hits">4082</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    def current_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      RequestStore.store[:property_id]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="88">
          <span class="hits">71</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    def current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      Property.find(current_id) if current_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">  def switch!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    Property.current_id = self.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">  def run</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    prev_property = Property.current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    self.switch!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">    yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  ensure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    Property.current_id = prev_property.try(:id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">  def run_block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    prev_property = Property.current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    self.switch!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  ensure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    prev_property.switch!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">  def run_block_with_no_property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    self.switch!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  ensure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    Property.current_id = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">  # this method should be called manually after property has been created</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">  # TODO: call it automatically after property creation when we get signup process in place</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">  def setup_default_maintenance_categories(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    categories = YAML.load_file Rails.root.join(&quot;db&quot;, &quot;maintenance_categories.yml&quot;) </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    categories.each do |category|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      parent_item = Maintenance::ChecklistItem.create(property: self, user: user, maintenance_type: :rooms, name: category[0], row_order: :last)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      category[1].each do |subcategory_name|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        parent_item.checklist_items.create(property: self, user: user, maintenance_type: :rooms, name: subcategory_name, row_order: :last)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">  # TODO: call it automaticall after property creation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">  def setup_default_maintenance_public_areas(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">    public_areas = YAML.load_file Rails.root.join(&quot;db&quot;, &quot;maintenance_public_areas.yml&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    public_areas.each do |public_area|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">      created_public_area = Maintenance::PublicArea.create(name: public_area[0], property: self, user: user, row_order: :last)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      public_area[1].each do |a|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        created_public_area.maintenance_checklist_items.create(user: user, maintenance_type: &#39;public areas&#39;, name: a, row_order: :last)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">  def setup_default_departments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    run_block do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      department_names = YAML.load_file Rails.root.join(&#39;db&#39;, &#39;departments.yml&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      Department.find_or_initialize_many(department_names.map{|name| {name: name}}, :name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">  def setup_default_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    run_block do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      permissions = YAML.load_file Rails.root.join(&#39;db&#39;, &#39;permissions.yml&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      permissions.each do |permission|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">        role = Role.by_name permission[:role]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">        department = Department.find_or_create_by(name: permission[:department])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">        attributes = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">        if permission[:attributes] == :all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">          attributes = PermissionAttribute.pluck(:id, :options, :name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">          attributes.each do |attr|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">            attr[1] = attr[1].map { |aa| aa[:option] == :department ? {option: aa[:option], departments: []} : aa[:option] } if attr[1] &amp;&amp; attr[1].count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">          permission[:attributes].each do |pp|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">            pa = PermissionAttribute.find_by(name: pp[:name])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">            attributes.push [pa.id, pp[:options], pa.name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">        except = (permission[:except] || []).map { |ee| ee[:name] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">        attributes.each do |attr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">          next if except.include?(attr[2])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">          new_permission = Permission.find_or_initialize_by role_id: role.id, department_id: department.id, permission_attribute_id: attr[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">          new_permission.options = attr[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">          new_permission.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">  def self.create_property(corporate, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    return false if options[:name].blank? || options[:username].blank? || options[:useremail].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">    property = Property.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    property.name = options[:name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    property.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    property.switch!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    property.setup_default_departments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">    user_params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        name: options[:username],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">        email: options[:useremail],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">        current_property_user_role_attributes: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">            title: &#39;General Manager&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">            order_approval_limit: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">            role_id: Role.gm.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">        department_ids: [Department.find_or_create_by(name: &#39;All&#39;).id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    user = User.find_by(email: options[:useremail])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    if user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      invitation = JoinInvitation.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">          sender: corporate ? corporate.users.first : nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">          invitee: user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">          targetable: property,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">          params: user_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">      Mailer.delay.join_invitation(invitation.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      user = User.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">      user.update_attributes user_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">    property.setup_default_maintenance_categories(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">    property.setup_default_maintenance_public_areas(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">    property.setup_default_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">    if corporate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">      corp_user = corporate.users.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">      connection = corporate.connections.build email: corp_user.email, email_confirmation: corp_user.email, state: :active</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">      connection.created_by = corp_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">      connection.property = property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">      connection.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">      # corp_user.current_property_role = Role.corporate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      # corp_user.title = &#39;Corporate&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      # corp_user.order_approval_limit = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      # corp_user.departments &lt;&lt; Department.find_by(name: &#39;All&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">      # corp_user.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">    property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6624e36f5cec268a381a58b42914a10f069ce62b">
  <div class="header">
    <h3>app/models/purchase_order.rb</h3>
    <h4><span class="red">60.0 %</span> covered</h4>
    <div>
      <b>70</b> relevant lines. 
      <span class="green"><b>42</b> lines covered</span> and
      <span class="red"><b>28</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: purchase_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id                  :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  user_id             :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  purchase_request_id :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  vendor_id           :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  sent_at             :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  closed_at           :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  created_at          :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  updated_at          :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  fax_id              :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#  fax_last_status     :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#  fax_last_message    :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">#  state               :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">#  property_id         :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">class PurchaseOrder &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :purchase_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :vendor</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_receipts</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :messages, as: :messagable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :purchase_receipts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :purchase_request, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :vendor, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :closed, -&gt; { where( state: &#39;closed&#39; ) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_closed, -&gt; { where.not( state: &#39;closed&#39; ) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="38">
          <span class="hits">76</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # timestamp_methods :closed_at, set: :close!, unset: :open!, ask: :closed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # timestamp_methods :sent_at, set: :send!, unset: :unsend!, ask: :sent?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # before_save :update_state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # delegate :total_price, to: :purchase_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  STATES = [:partially_received, :open, :sent, :closed]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  FAX_SENDING = &#39;sending&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  FAX_SUCCESS = &#39;success&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  FAX_FAILED  = &#39;failed&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  STATES.each do |state|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="53">
          <span class="hits">4</span>
          
          <code class="ruby">    define_method(&quot;#{state}?&quot;) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      self.state.to_sym == state.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="57">
          <span class="hits">4</span>
          
          <code class="ruby">    define_method(&quot;#{state}!&quot;) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      self.state = state</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      if self.has_attribute?(&quot;#{state}_at&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        write_attribute(&quot;#{state}_at&quot;, Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      self.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def sent_by_fax?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    sent? &amp;&amp; self.fax_last_status == &#39;success&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  def sent=(value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    value = value.to_bool if value.kind_of? String</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    if value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      sent!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      # unsend!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_receive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    sent? or partially_received? </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    Mailer.purchase_order(self.id).deliver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  def user</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="88">
          <span class="hits">7</span>
          
          <code class="ruby">    User.with_deleted.find(self.user_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  def number</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="92">
          <span class="hits">2</span>
          
          <code class="ruby">    &#39;#%05d&#39; % self.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  def percent_complete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    self.item_orders.find_all(&amp;:complete?).size / self.item_orders.size.to_f * 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  def complete?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    self.percent_complete == 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  def faxing?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    self.open? &amp;&amp; !self.fax_last_status.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">  def fax_error?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    self.open? &amp;&amp; self.fax_last_status == FAX_FAILED</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">  def fax_success?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    self.sent? &amp;&amp; self.fax_last_status == FAX_SUCCESS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">  def vpt_ready?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">    self.vendor.procurement_interface_enabled?(:vpt)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_state</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    self.state = new_state unless new_state.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">  def new_state</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">    if closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      &#39;closed&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    elsif sent?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      &#39;sent&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    elsif partially_received?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      &#39;partially_received&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      &#39;open&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_price</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    return Money.new(0) if self.item_orders.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    Money.new(item_orders.map(&amp;:total).reduce(&amp;:+) * 100 )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    #return Money.new(item_orders.select(&#39;sum(item_orders.price * item_orders.quantity) as total_price&#39;)[0][:total_price] * 100 )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">  def vpt_prepare</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">    if self.vpt_ready?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      self.vendor.procurement_interface.update_data_attribute(:vpt_request_id, Time.now.to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      # send error messages</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0967b902aa3edc624c23c27eccebafbad1f25c3e">
  <div class="header">
    <h3>app/models/purchase_receipt.rb</h3>
    <h4><span class="red">60.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: purchase_receipts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id                :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  user_id           :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  purchase_order_id :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  created_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  updated_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  freight_shipping  :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  property_id       :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">class PurchaseReceipt &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :purchase_order</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_receipts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # TODO: Revise this! Originally:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # attributes[:quantity].blank? or attributes[:quantity].zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # New: attributes[:quantity].to_f.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # nil.to_f == 0, &quot;&quot;.to_f == 0, String.zero? =&gt; NoMethodError</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :item_receipts, reject_if: proc {|params| params[:quantity].to_f.zero?}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user, :purchase_order, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :include_items, -&gt; (item_ids) { PurchaseReceipt.includes(:item_receipts).where(&quot;item_receipts.item_id = any(array#{item_ids})&quot;).references(:item_receipts) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    User.with_deleted.find(self.user_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def purchase_order=(purchase_order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    self.purchase_order_id = purchase_order.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    purchase_order.item_orders.order(item_id: :desc).each do |item_order|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      self.item_receipts.build item_order: item_order </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_first?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    purchase_order.purchase_receipts.empty? || purchase_order.purchase_receipts.first == self </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def total item_ids = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    # Money.new(item_receipts.sum(&#39;quantity * price&#39;) * 100)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    receipts = item_ids.blank? ? item_receipts : item_receipts.where(&quot;item_receipts.item_id = any(array#{item_ids})&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    receipts.reduce(Money.new(0, PurchaseOrderDecorator::CURRENCY)) do |total, item_receipt|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      total += item_receipt.total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_w_freight</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    total + Money.new(freight_or_zero * 100)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  def freight_or_zero</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    freight_shipping || 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ed11a82eb42cef3e8d9ea565f2e6755d15c4401e">
  <div class="header">
    <h3>app/models/purchase_request.rb</h3>
    <h4><span class="red">64.47 %</span> covered</h4>
    <div>
      <b>76</b> relevant lines. 
      <span class="green"><b>49</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: purchase_requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id          :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  user_id     :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  created_at  :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  updated_at  :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  state       :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  property_id :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">class PurchaseRequest &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  include PusherHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # This default should be switched up later if we internationalize this app</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # A more reasonable scheme would probably be to store currency preference</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # with each property.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  CURRENCY = &#39;USD&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_requests, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items, :through =&gt; :item_requests</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :vendors, -&gt; { uniq }, :through =&gt; :items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :preferred_vendors, -&gt; { uniq.where(&#39;vendor_items.preferred = ?&#39;, true) }, through: :items, source: :vendors</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :messages, as: :messagable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :item_requests, allow_destroy: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  STATES = [:inventory, :request, :completed, :inventory_finished]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  #FIXME find some where else to put the view level concerns</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  BTN_CLASS = {inventory_finished: &#39;btn-default&#39;, inventory: &#39;btn-default&#39;, request: &#39;btn-primary&#39;, completed: &#39;btn-success&#39;, approved: &#39;btn-warning&#39;, ordered: &#39;btn-info&#39; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  BTN_ICON = { inventory: &#39;ico-marker2&#39;, request: &#39;ico-basket2&#39;, completed: &#39;ico-cart-checkout&#39;, approved: &#39;ico-shopping-cart&#39;, ordered: &#39;ico-eye&#39; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  BADGE_CLASS = { inventory: &#39;badge-inverse&#39;, request: &#39;badge-primary&#39;, completed: &#39;badge-success&#39;, approved: &#39;badge-primary&#39;, ordered: &#39;btn-primary&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  ACTION = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    inventory: &#39;Count&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    request: &#39;Request&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    completed: &#39;Approve&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    approved: &#39;Order&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :without_inventory_finished, -&gt;{ where{state != &#39;inventory_finished&#39;} }</code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="48">
          <span class="hits">76</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    &#39;#%05d&#39; % self.id unless self.new_record?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  state_machine initial: :inventory do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    after_transition :on =&gt; :approve, :do =&gt; :create_transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    event :finish do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      transition inventory: :inventory_finished#, request: :completed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    event :next do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      transition inventory: :request, request: :completed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    event :commit do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      transition inventory: :inventory, request: :request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    event :back do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      transition request: :inventory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    event :reject do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      transition completed: :inventory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    event :approve do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">      transition completed: :approved</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    event :create_orders do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">      transition approved: :ordered</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  def user</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="87">
          <span class="hits">4</span>
          
          <code class="ruby">    User.with_deleted.find(self.user_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    return 0 if self.item_requests.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    requested_items = item_requests.where.not(quantity: nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">    requested_items.reduce(Money.new(0, CURRENCY)) do |total, item_request|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      total += Money.new(100 * item_request.total_item_price, CURRENCY)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  def approval_request current_property, current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    approvers = current_property.proper_approvers self.total_price, current_user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">    return false if approvers.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    approver_ids = approvers.map(&amp;:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    RequestApprovalWorker.perform_async(approvers.map(&amp;:email), self.id, approver_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def approve_reject commit, original_id, current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    if commit == &#39;approve&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      RequestCheckWorker.perform_async(self.id, original_id, &#39;approved&#39;, current_user.name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    elsif commit == &#39;reject&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">      RequestCheckWorker.perform_async(self.id, original_id, &#39;rejected&#39;, current_user.name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  def items_by_vendor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    self.item_requests.where{quantity != nil}.group_by{ |ir| ir.item.vendors.first }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">  def order_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">    self.purchase_orders.count if self.ordered?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">  def order_numbers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    self.purchase_orders.map(&amp;:number).join(&#39;, &#39;) if self.ordered?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_orders_on_approval!(current_user, current_property)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    items_by_vendor.each do |vendor, items_requests|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      purchase_order = PurchaseOrder.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        user: current_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">        property: current_property,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        vendor: vendor,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">        purchase_request_id: self.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        state: :open</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">      items_requests.each do |items_request|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">        preferred_item = items_request.item.vendor_items.preferred.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">        price = preferred_item.nil? ? items_request.item.vendor_items.first.price : preferred_item.price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        purchase_order.item_orders.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">          item: items_request.item,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">          item_request: items_request,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">          quantity: items_request.quantity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">          price: price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    self.create_orders # change state to ordered</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantities_changed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    item_requests.map(&amp;:quantity_changed?).any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_transaction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">    for request in self.item_requests</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">      request.create_item_transaction!(change: request.count  - (request.item.count || 0)) unless request.count.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b56f1ff9066cc530742facd239b35139e959c920">
  <div class="header">
    <h3>app/models/report.rb</h3>
    <h4><span class="red">59.09 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Report &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :report_favoritings</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :favoriting_users, through: :report_favoritings, source: :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :report_runs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_maintenance, -&gt; { where(&#39;groups ILIKE ?&#39;, &#39;maintenance&#39;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  ALL_KINDS = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    {permalink: &#39;vendor_spend&#39;, name: &#39;Vendor Spend&#39;, description: &quot;Provides analysis of the total spending on your Vendors.  Useful to understand who are your top Vendors to negotiate contracts with.&quot;, groups: &#39;spending&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    {permalink: &#39;category_spend&#39;, name: &#39;Category Spend&#39;, description: &quot;Understand your Hotel&#39;s spending by Category. Analyze which categories comprise most of your hotel&#39;s spending&quot;, groups: &#39;spending&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    {permalink: &#39;items_spend&#39;, name: &#39;Items Spend&#39;, description: &quot;Analyze which items comprise 80% of your spending. Optimize the procurement and inventory to reduce costs.&quot;, groups: &#39;spending&#39; }, {permalink: &#39;purchase_history_report&#39;, name: &#39;Purchase History Report&#39;, description: &quot;Understand your Hotel&#39;s spending by Category. Analyze which categories comprise most of your hotel&#39;s spending&quot;, groups: &#39;purchases&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # {permalink: &#39;budget_vs_spend&#39;, name: &#39;Budget vs Spend&#39;, description: &quot;Description goes here&quot;, groups: &#39;budget&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # {permalink: &#39;cpor_analysis&#39;, name: &#39;CPOR Analysis&#39;, description: &quot;Description goes here&quot;, groups: &#39;budget&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # {permalink: &#39;vendor_list&#39;, name: &#39;Vendor List&#39;, description: &quot;Description goes here&quot;, groups: &#39;misc&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # {permalink: &#39;list_item_coverage&#39;, name: &#39;List Item Coverage&#39;, description: &quot;Description goes here&quot;, groups: &#39;misc&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    {permalink: &#39;items_consumption&#39;, name: &#39;Items Consumption&#39;, description: &quot;Consumption Report allows you to analyze the frequency, size and value of your Ordering for individual items to understand and compare your consumption between periods.&quot;, groups: &#39;purchases,misc&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    {permalink: &#39;item_price_variance&#39;, name: &#39;Item Price Variance&#39;, description: &quot;Provides data from Item&#39;s Received Orders to analyze the variation in the PO price and the Actual price an item is received at.&quot;, groups: &#39;spending,misc&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # {permalink: &#39;inventory_vs_ordering&#39;, name: &#39;Inventory vs Ordering&#39;, description: &quot;...&quot;, groups: &#39;purchases, misc&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    {permalink: &#39;maintenance_work_orders&#39;, name: &#39;Work Order Listing&#39;, description: &quot;View all work orders for the hotel.&quot;, groups: &#39;maintenance&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    {permalink: &#39;pm_productivity_report&#39;, name: &#39;PM Productivity Report&#39;, description: &quot;Analyze the productivity of the Maintenance department&quot;, groups: &#39;maintenance&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    {permalink: &#39;guest_room_pm_analysis&#39;, name: &#39;Guest Room PM Analysis&#39;, description: &quot;Understand the Guest Room PM status for the current Quarter, and analyze the history of PM completions.&quot;, groups: &#39;maintenance&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    {permalink: &#39;public_area_pm_analysis&#39;, name: &#39;Public Area PM Analysis&#39;, description: &quot;Understand the Public Area PM status for the current Quarter, and analyze the history of PM completions.&quot;, groups: &#39;maintenance&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    {permalink: &#39;equipment_pm_analysis&#39;, name: &#39;Equipment PM Analysis&#39;, description: &quot;Understand the Equipment PM status for the current Quarter, and analyze the history of PM completions.&quot;, groups: &#39;maintenance&#39; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    {permalink: &#39;work_order_trendings&#39;, name: &#39;Hotel Trending Issue&#39;, description: &quot;The trending issues report will allow managers to understand the frequently seen issues during PMs and Work Orders in a given period of time&quot;, groups: &#39;maintenance&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def groups_as_array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    self.groups.split(&#39;,&#39;).map(&amp;:strip)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def toggle_favorited_by!(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    if favorited_by?(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      favoriting_users.delete(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      favoriting_users &lt;&lt; user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def favorited_by?(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    favoriting_users.include?(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def record_run_by!(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    report_runs.create(user: user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_run</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    @last_run ||= report_runs.order(:created_at).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_run_by_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    last_run.user.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby"> def last_run_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">   last_run.created_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"> end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="656741560a80bbe9705c7743c0f5a6c7c027dc94">
  <div class="header">
    <h3>app/models/role.rb</h3>
    <h4><span class="green">94.44 %</span> covered</h4>
    <div>
      <b>18</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Role &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :permissions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :user_roles</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :users, through: :user_roles</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_current_property, -&gt; { joins(:users).order(:id).distinct }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.by_name(name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    self.find_by(name: name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  #convert &#39;General Manager&#39; to &#39;gm&#39;  but &#39;Corporate&#39; to &#39;corporate&#39; etc</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def method_name</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="17">
          <span class="hits">74</span>
          
          <code class="ruby">    split_role_name = self.name.split(&quot; &quot;)</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="18">
          <span class="hits">74</span>
          
          <code class="ruby">    name = split_role_name.many? ? split_role_name.map(&amp;:first).join : self.name</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="19">
          <span class="hits">74</span>
          
          <code class="ruby">    name.downcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  ROLE_NAMES = [&#39;General Manager&#39;, &#39;Asst General Manager&#39;, &#39;Manager&#39;, &#39;Corporate&#39;, &#39;User&#39;, &#39;External Tech&#39;, &#39;Other&#39;, &#39;Admin&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  #sorry for the crazyness... really wanted to be able to do Role.gm etc...</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  ROLE_NAMES.each do |role_name|</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="25">
          <span class="hits">8</span>
          
          <code class="ruby">    tmp_role = Role.new(name: role_name)</code>
        </li>
      
        <li class="covered" data-hits="228" data-linenumber="26">
          <span class="hits">228</span>
          
          <code class="ruby">    define_method(tmp_role.method_name + &quot;?&quot;) { self.name == role_name}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="28">
          <span class="hits">8</span>
          
          <code class="ruby">    self.class.instance_eval do</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="29">
          <span class="hits">135</span>
          
          <code class="ruby">      define_method(tmp_role.method_name ) { self.find_by(name: role_name)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f2ae0ce065d82f7b544ca86451666ebba1a75f5e">
  <div class="header">
    <h3>app/models/tag.rb</h3>
    <h4><span class="red">52.0 %</span> covered</h4>
    <div>
      <b>75</b> relevant lines. 
      <span class="green"><b>39</b> lines covered</span> and
      <span class="red"><b>36</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id                :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  type              :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  name              :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  unboxed_countable :boolean</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  parent_id         :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  position          :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  created_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  updated_at        :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  property_id       :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">class Tag &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :operation, :other_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  TYPES = %w(Category Location List)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  OPERATIONS = %w(nest_under move_above move_below)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  INVALID_TAG_OPERATION = &#39;is not a valid tag for this operation&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  include RankedModel</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  ranks :siblings, column: :position, with_same: :parent_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_tree order: :position, dependent: :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # validate :validate_has_items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # validate :validate_items_do_not_belong_to_other_tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :operation, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    presence: {message: &#39;must specify an operation&#39;}, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    inclusion: {in: OPERATIONS, message: &#39;is not a valid operation&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    if: :operation_or_other_id?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :other_id,  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    presence: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    numericality: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    inclusion: {in: proc {|tag| tag.class.where{id != tag.id}.map{|tag| tag.id}}, message: INVALID_TAG_OPERATION},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    if: :operation_or_other_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  around_save :rearrange, if: :operation_or_other_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :item_tags, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items, through: :item_tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :categories, -&gt; { where(type: TYPES[0]) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :locations, -&gt; { where(type: TYPES[1]) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :lists, -&gt; { where(type: TYPES[2]) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  # scope :for_property, -&gt;(property){ where(property_id: property) }</code>
        </li>
      
        <li class="covered" data-hits="1455" data-linenumber="54">
          <span class="hits">1455</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def selves_and_descendants</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      unscoped.where id: all.map{|tag| Tag.unscoped {tag.self_and_descendants.pluck(:id)}}.flatten.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    # Removes type from &#39;attributes_protected_by_default&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    def attributes_protected_by_default</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      [&#39;id&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    def types</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      TYPES</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">    def operations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      OPERATIONS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    def autocomplete_source(type = &#39;scoped&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      Tag.roots_and_descendants_preordered.send(type).map do |t|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">          id: t.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          value: t.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          depth: t.depth,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          search: t.self_and_ancestors.send(type).map(&amp;:name).reverse.concat(t.descendants.send(type).map(&amp;:name)).join(&#39; &#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      end.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  def other_id=(val)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    @other_id = val.to_i unless val.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  def operation_or_other_id?</code>
        </li>
      
        <li class="covered" data-hits="1206" data-linenumber="91">
          <span class="hits">1206</span>
          
          <code class="ruby">    operation.present? || other_id.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  def plain_text_node</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="95">
          <span class="hits">28</span>
          
          <code class="ruby">    (self.depth.times.map{&#39;&amp;nbsp;&#39; * 2}.join + self.name).html_safe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_items(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    params[:tag][:add] &amp;&amp; params[:tag][:add][:item_ids].each do |item_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      self.items &lt;&lt; Item.find(item_id) unless self.items.exists?(item_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    params[:tag][:remove] &amp;&amp; params[:tag][:remove][:item_ids].each do |item_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      self.items.delete(Item.find(item_id)) unless !self.items.exists?(item_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  # Based on</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  # https://github.com/mixonic/ranked-model/issues/10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  # Replace with solution provided in (when closed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  # https://github.com/mixonic/ranked-model/issues/33</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def calculated_siblings_position</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    self.self_and_siblings.where(&#39;position &lt; ?&#39;, self.position).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    self.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  # around_save, save happens at `yield`, but it can be aborted raising a ActiveRecord::Rollback</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">  def rearrange</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    yield</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">    other = Tag.where(id: self.other_id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    operation = self.operation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    self.operation = self.other_id = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      case operation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        when &#39;nest_under&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">          self.update_attribute :parent_id, other.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">          self.update_attribute :siblings_position, 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">          raise &#39;Cyclic nesting!&#39; if other.parent_id == id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        when &#39;move_above&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          self.update_attribute :parent_id, other.parent_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">          self.update_attribute :siblings_position, other.calculated_siblings_position - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        when &#39;move_below&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">          self.update_attribute :parent_id, other.parent_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">          self.update_attribute :siblings_position, other.calculated_siblings_position + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      self.errors.add :other_id, INVALID_TAG_OPERATION</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      raise ActiveRecord::Rollback</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">  def other_tags_of_same_type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    self.class.where.not(id: self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  # ensures that items do not belongs to other tags of the same type</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_items_do_not_belong_to_other_tags</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    other_occurences = other_tags_of_same_type.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      joins(:item_tags).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      where(item_tags: {item_id: self.items.map(&amp;:id)}).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    if other_occurences &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      self.errors.add(:base, &quot;can not contain items that &quot;\</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">                             &quot;belong to another #{self.class.to_s.downcase}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_has_items</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    if self.items.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">      errors.add(:base, &#39;must contain at least one item!&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2e9149c8406a1f474043984060b22b296b807092">
  <div class="header">
    <h3>app/models/unit.rb</h3>
    <h4><span class="red">80.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: units</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id          :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  name        :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  description :text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  created_at  :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  updated_at  :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">class Unit &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true, uniqueness: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    self.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d52c6aed0a2bc2631ad443122fa45c7e7eda5bdc">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4><span class="red">70.09 %</span> covered</h4>
    <div>
      <b>117</b> relevant lines. 
      <span class="green"><b>82</b> lines covered</span> and
      <span class="red"><b>35</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class User &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_paranoid</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_voter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include StampUser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  devise :database_authenticatable, :recoverable, :trackable, :validatable, :confirmable, authentication_keys: [:login]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  mount_uploader :avatar, AvatarUploader</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  serialize :settings, Hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :corporate</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :created_by_user, class_name: &#39;User&#39; </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  has_and_belongs_to_many :old_roles</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :user_roles</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :roles, through: :user_roles</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :api_key, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :devices, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :properties, through: :user_roles</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :current_property_user_role, class_name: &#39;UserRole&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :current_property_role, through: :current_property_user_role, source: :role</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :title, to: :current_property_user_role, allow_nil: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  delegate :title=, to: :current_property_user_role, allow_nil: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :order_approval_limit, to: :current_property_user_role, allow_nil: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :order_approval_limit=, to: :current_property_user_role, allow_nil: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :report_favoritings</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :favorite_reports, through: :report_favoritings, source: :report</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :departments_users</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :departments, through: :departments_users</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :categories, through: :departments</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :notifications</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  has_many :purchase_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  has_many :purchase_requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  has_many :budgets</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :engage_messages, class_name: &#39;Engage::Message&#39;, foreign_key: :created_by_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # has_many :permissions, -&gt; (user) { where(role_id: user.roles.first.try(:id)) }, through: :departments</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  # has_many :permission_attributes, through: :permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="121" data-linenumber="42">
          <span class="hits">121</span>
          
          <code class="ruby">  accepts_nested_attributes_for :current_property_user_role</code>
        </li>
      
        <li class="covered" data-hits="121" data-linenumber="43">
          <span class="hits">121</span>
          
          <code class="ruby">  accepts_nested_attributes_for :devices</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  # validates :order_approval_limit, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  validates :current_property_user_role, presence: true, if: lambda{ !!Property.current_id }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :at_least_one_department, if: lambda{ !!Property.current_id }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  validate :email_or_username_exists</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_format_of :username, with: /^[a-zA-Z0-9_\.]*$/, multiline: true</code>
        </li>
      
        <li class="covered" data-hits="118" data-linenumber="51">
          <span class="hits">118</span>
          
          <code class="ruby">  validates :username, uniqueness: {case_sensitive: false}, allow_nil: true, allow_blank: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  attr_accessor :login</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def at_least_one_department</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    errors.add :department_ids, &#39;at least one should be selected&#39; if department_ids.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  # Overwrite only_deleted, pending resolution of https://github.com/radar/paranoia/issues/62</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">  scope :active, -&gt; { where(deleted_at: nil) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  scope :corporate, -&gt; { where.not(corporate_id: nil) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  scope :by_roles_and_departments, -&gt; (roles, departments) {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    joins(:current_property_role).joins(:departments)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      .where(current_property_role: {id: roles})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      .where(departments: {id: departments}).active.distinct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="68">
          <span class="hits">147</span>
          
          <code class="ruby">  # override default scope of acts_as_paranoid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  def self.default_scope</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">  def permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    Permission.where(role_id: roles.first.try(:id), department_id: departments.pluck(:id).uniq)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">  def permission_attributes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    PermissionAttribute.where(id: permissions.pluck(:permission_attribute_id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="80">
          <span class="hits">147</span>
          
          <code class="ruby">  def wo_assignable_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    (permission_attributes.assignable.count &gt; 0) ? self.id : Maintenance::WorkOrder::UNASSIGNED</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="84">
          <span class="hits">71</span>
          
          <code class="ruby">  def permitted_permissions(subject)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    permissions.by_attribute_subject subject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">  def active_for_authentication?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    super &amp;&amp; !deleted_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">  def deleted?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    !!deleted_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">  def name_with_status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    &quot;#{name} #{&#39;(inactive)&#39; if deleted?}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">  def inactive_message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    deleted? ? :deleted : super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">  def activate!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    self.restore!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">  def code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    &quot;%05d&quot; % id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">  def inactivate!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    user_roles.where(property_id: Property.current).destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    if UserRole.unscoped.where(deleted_at: nil, user_id: self.id).count == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      self.email = &quot;inactive_&quot; + self.email if !!self.email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      self.username = &quot;inactive_&quot; + self.username if !!self.username</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">      self.save</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">      self.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">  def default_hotel_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    all_properties.first.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">  def first_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    first, last = name.split(&#39; &#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">  def first_name_last_initial</code>
        </li>
      
        <li class="covered" data-hits="120" data-linenumber="132">
          <span class="hits">120</span>
          
          <code class="ruby">    first, last = name.split(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    &quot;#{first} #{last[0].upcase}.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="240" data-linenumber="136">
          <span class="hits">240</span>
          
          <code class="ruby">  def email_required?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">  def password_required?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    super if confirmed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  def password_match?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    self.errors[:password] &lt;&lt; &quot;can&#39;t be blank&quot; if password.blank?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    self.errors[:password_confirmation] &lt;&lt; &quot;can&#39;t be blank&quot; if password_confirmation.blank?</code>
        </li>
      
        <li class="covered" data-hits="345" data-linenumber="147">
          <span class="hits">345</span>
          
          <code class="ruby">    self.errors[:password_confirmation] &lt;&lt; &quot;does not match password&quot; if password != password_confirmation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    password == password_confirmation &amp;&amp; !password.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="151">
          <span class="hits">58</span>
          
          <code class="ruby">  def corporate?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    !Property.current_id &amp;&amp; corporate_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="155">
          <span class="hits">49</span>
          
          <code class="ruby">  def maintenance_department?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    departments.pluck(:name).include? &#39;Maintenance&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="159">
          <span class="hits">109</span>
          
          <code class="ruby">  def frontdesk_department?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    departments.pluck(:name).include? &#39;Front Desk&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">  def all_properties</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">    Property.where(id: UserRole.unscoped.where(user_id: self.id).active.pluck(:property_id)).order(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_property</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="168">
          <span class="hits">36</span>
          
          <code class="ruby">    return nil unless current_property_user_role.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    current_property_user_role.property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">  def pusher_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">    &quot;#{Rails.env}_#{id}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  def pendo_visitor_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">    &quot;#{name}_#{title}_#{email}&quot;.gsub(/\s+/, &#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">  def pendo_account_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    if corporate?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      &quot;#{name}_#{corporate.name}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      &quot;#{name}_#{Property.current.name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">    end.gsub(/\s+/, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">  def self.find_for_database_authentication(warden_conditions)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    conditions = warden_conditions.dup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    if login = conditions.delete(:login)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">      where(conditions.to_h).where([&quot;lower(username) = :value OR lower(email) = :value&quot;, { :value =&gt; login.downcase }]).first</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">    elsif conditions.has_key?(:username) || conditions.has_key?(:email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      where(conditions.to_h).first</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="120" data-linenumber="195">
          <span class="hits">120</span>
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">  def email_or_username_exists</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    if email.blank? &amp;&amp; username.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      errors.add(:email, &quot;Email or Username is required&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      errors.add(:username, &quot;Email or Username is required&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4a6e929255b325384a9026dd2c10fb2a82e4dfd4">
  <div class="header">
    <h3>app/models/user_role.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class UserRole &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_paranoid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :role</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :property_id, uniqueness: {scope: :user_id, message: &quot;A user can only have one role per property&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :role_id, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="11">
          <span class="hits">110</span>
          
          <code class="ruby">  scope :active, -&gt; { where(deleted_at: nil) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.default_scope</code>
        </li>
      
        <li class="covered" data-hits="579" data-linenumber="14">
          <span class="hits">579</span>
          
          <code class="ruby">    where(property_id: Property.current_id, deleted_at: nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e6e6011e5f1f9bb16526f21f69d974d697298a32">
  <div class="header">
    <h3>app/models/vendor.rb</h3>
    <h4><span class="red">70.59 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: vendors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id              :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  name            :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  street_address  :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  zip_code        :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  city            :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  email           :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  phone           :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  fax             :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  created_at      :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#  updated_at      :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#  contact_name    :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">#  shipping_method :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">#  shipping_terms  :string(255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">class Vendor &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :vendor_items, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items, through: :vendor_items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :purchase_receipts, through: :purchase_orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :procurement_interface</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :procurement_interface</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :street_address, presence: true, if: :address_present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :city, presence: true, if: :address_present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :zip_code, presence: true, if: :address_present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :email, email: true, allow_blank: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  before_destroy :check_for_purchase_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :top, -&gt; (n){order(total_spent: :desc).limit(n) }</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="41">
          <span class="hits">162</span>
          
          <code class="ruby">  default_scope { where(property_id: Property.current_id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def address_present?</code>
        </li>
      
        <li class="covered" data-hits="294" data-linenumber="44">
          <span class="hits">294</span>
          
          <code class="ruby">    self.street_address.present? || self.city.present? || self.zip_code.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    self.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_spent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    #FIXME: @hugo shouldn&#39;t use a decorator from inside a model</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    @total_spent ||= PurchaseOrderDecorator.decorate_collection(purchase_orders.closed).map(&amp;:total_price).reduce(:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    @total_spent || 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    if address_present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      &quot;#{self.street_address} #{self.city} #{self.zip_code}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      &#39;-&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def procurement_interface_enabled?(interface_type)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    procurement_interface &amp;&amp; procurement_interface.interface_type.present? &amp;&amp; procurement_interface.interface_type == interface_type.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_for_purchase_orders</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    if purchase_orders.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      errors.add :base, &#39;cannot delete vendor while purchase orders exist&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ac39e26e8ff48fcde02c6091fbaf69d402373728">
  <div class="header">
    <h3>app/models/vendor_item.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># == Schema Information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Table name: vendor_items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#  id             :integer          not null, primary key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#  preferred      :boolean</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#  items_per_box  :decimal(, )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#  vendor_id      :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#  item_id        :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#  box_unit_id    :integer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#  created_at     :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  updated_at     :datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#  price_cents    :integer          default(0), not null</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#  price_currency :string(255)      default(&quot;USD&quot;), not null</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">class VendorItem &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  monetize :price_cents, allow_nil: false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :vendor</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :item</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :box_unit, class_name: &#39;Unit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :vendor, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :preferred, -&gt; {where preferred: true}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4ef202091d9ca1b3ae74a77693ff964b5612fe24">
  <div class="header">
    <h3>app/policies/access_policy.rb</h3>
    <h4><span class="yellow">81.25 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class AccessPolicy &lt; Struct.new(:user, :access)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(user, access)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="4">
          <span class="hits">34</span>
          
          <code class="ruby">    @user = user</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="5">
          <span class="hits">34</span>
          
          <code class="ruby">    @permitted_actions = user.permitted_permissions(:access).map(&amp;:permission_attribute).map(&amp;:action).map(&amp;:to_sym).uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  PermissionAttribute.access_attributes.pluck(:action).each do |action|</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="9">
          <span class="hits">81</span>
          
          <code class="ruby">    define_method(&quot;#{action}?&quot;) { @permitted_actions.include?(action.to_sym) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def maintenance?</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="13">
          <span class="hits">72</span>
          
          <code class="ruby">    @permitted_actions.include?(:maintenance) || @user.corporate?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def work_order?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @permitted_actions.include?(:work_order) || @user.corporate?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def connect_corporate?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @user.current_property_role.gm? || @user.current_property_role.admin? || @permitted_actions.include?(:connect_corporate)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def permission_setting?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    @user.current_property_role.gm? || @user.current_property_role.admin? || @permitted_actions.include?(:permission_setting)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def settings?</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="29">
          <span class="hits">36</span>
          
          <code class="ruby">    @user.current_property_role &amp;&amp; (@user.current_property_role.gm? || @user.current_property_role.admin? || @permitted_actions.include?(:settings))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ca4542862f1fc01723aa84f02954ab7812fa6002">
  <div class="header">
    <h3>app/policies/application_policy.rb</h3>
    <h4><span class="yellow">85.71 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ApplicationPolicy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(user, record)</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="3">
          <span class="hits">113</span>
          
          <code class="ruby">    raise Pundit::NotAuthorizedError &#39;must be logged in&#39; unless user</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="4">
          <span class="hits">113</span>
          
          <code class="ruby">    @user = user</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="5">
          <span class="hits">113</span>
          
          <code class="ruby">    @record = record</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="6">
          <span class="hits">113</span>
          
          <code class="ruby">    subject = if record.is_a? Class</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="7">
          <span class="hits">77</span>
          
          <code class="ruby">                record.model_name.singular.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="9">
          <span class="hits">36</span>
          
          <code class="ruby">                record.class.model_name.singular.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="11">
          <span class="hits">113</span>
          
          <code class="ruby">    @permissions = user.permitted_permissions(subject)</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="12">
          <span class="hits">113</span>
          
          <code class="ruby">    @permission_attributes = @permissions.map(&amp;:permission_attribute)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def update?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    edit?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d1700c86e7e9d77f893cc9635651d8b88d37c6be">
  <div class="header">
    <h3>app/policies/maintenance/base_policy.rb</h3>
    <h4><span class="red">45.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Maintenance::BasePolicy &lt; ApplicationPolicy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class Scope</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :user, :scope</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(user, scope)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      @user = user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      @scope = scope</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      subject = scope.model_name.singular.to_sym</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      @permissions ||= user.permitted_permissions subject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    def index_scopes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      # flatten permissions since there are several permissions related to department</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      @scopes ||= @permissions.by_attribute_action(:index).pluck(:options).flatten.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def option_include?(options, option)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      options.any? { |o| o.is_a?(Hash) ? o[:option] == option : o == option }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def base_attributes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def permitted_attributes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    if @record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      full_attributes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      base_attributes + @permissions.by_attribute_action(:edit).pluck(:options).flatten.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def full_attributes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    base_attributes + primary_attributes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6eda0956926f03129924734b2c9f2681abaee058">
  <div class="header">
    <h3>app/policies/maintenance/work_order_policy.rb</h3>
    <h4><span class="red">44.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Maintenance::WorkOrderPolicy &lt; Maintenance::BasePolicy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class Scope &lt; Scope</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    def index_departments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      index_scopes.select_in_hash(:department).map { |option| option[:departments] }.flatten.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    def resolve</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      if index_scopes.include_in_hash?(:all)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">        @scope.all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        sql = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        if index_scopes.include_in_hash?(:own) &amp;&amp; index_scopes.include_in_hash?(:assigned_to)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">          # @scope.where(&quot;opened_by_user_id = ? OR assigned_to_id = ?&quot;, @user.id, @user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">          sql = &quot;opened_by_user_id = #{@user.id} OR assigned_to_id = #{@user.id}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        elsif index_scopes.include_in_hash? :own</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">          # @scope.where(opened_by_user_id: @user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">          sql = &quot;opened_by_user_id = #{@user.id}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        elsif index_scopes.include_in_hash? :assigned_to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">          # @scope.where(assigned_to_id: @user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">          sql = &quot;assigned_to_id = #{@user.id}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          # @scope.none</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        if index_scopes.include_in_hash?(:department) &amp;&amp; index_departments.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          @scope = @scope.by_departments(index_departments, sql)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">          sql.nil? ? @scope.none : @scope.where(sql)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def index?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    @user.corporate? || (@permissions.by_attribute_action(:index).pluck(:options).flatten.compact.uniq.count &gt; 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  %w(edit edit_closed destroy).each do |action|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="38">
          <span class="hits">3</span>
          
          <code class="ruby">    define_method(&quot;#{action}?&quot;) { @permission_attributes.map(&amp;:action).include?(action) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def create?</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="42">
          <span class="hits">36</span>
          
          <code class="ruby">    (@user.corporate? &amp;&amp; @user.all_properties.count &gt; 0) || @permission_attributes.map(&amp;:action).include?(&#39;create&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def base_attributes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      :description, :maintainable_id, :maintainable_type, :other_maintainable_location, :closing_comment, :duration, :schedule_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      :attachments_attributes =&gt; [:id, :file, :_destroy ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      :checklist_item_maintenance_attributes =&gt; [:id, :maintenance_checklist_item_id, :_destroy ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def primary_attributes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    [:status, :priority, :assigned_to_id, :due_to_date]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0eaacdf6db49592412ce6266de1d4b12cde7a00b">
  <div class="header">
    <h3>app/policies/report_policy.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ReportPolicy &lt; ApplicationPolicy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def index?</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="4">
          <span class="hits">36</span>
          
          <code class="ruby">    return true if @user.corporate</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="5">
          <span class="hits">36</span>
          
          <code class="ruby">    @permission_attributes.map(&amp;:action).include? &#39;index&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a8d317ac776e74208dfc0c3b5b74cd4e6615996b">
  <div class="header">
    <h3>app/policies/user_policy.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class UserPolicy &lt; ApplicationPolicy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  %w(index new create destroy).each do |action|</code>
        </li>
      
        <li class="covered" data-hits="53" data-linenumber="4">
          <span class="hits">53</span>
          
          <code class="ruby">    define_method(&quot;#{action}?&quot;) { has_team_permission? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  %w(edit change_password update).each do |action|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">    define_method(&quot;#{action}?&quot;) { has_team_permission? || @record == @user }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_team_permission?</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="14">
          <span class="hits">49</span>
          
          <code class="ruby">    @permission_attributes.map(&amp;:action).include?(&#39;index&#39;) || @user.corporate?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2fee65bba191239c4eb4bc0333e49fcc72b0dcbe">
  <div class="header">
    <h3>app/uploaders/avatar_uploader.rb</h3>
    <h4><span class="yellow">84.62 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: utf-8</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class AvatarUploader &lt; CarrierWave::Uploader::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # Include RMagick or MiniMagick support:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # include CarrierWave::RMagick</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  include CarrierWave::MiniMagick</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # Choose what kind of storage to use for this uploader:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  storage :file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # storage :fog</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # Override the directory where uploaded files will be stored.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # This is a sensible default for uploaders that are meant to be mounted:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def store_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    &quot;uploads/#{model.class.to_s.underscore}/#{mounted_as}/#{model.id}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  # Provide a default URL as a default if there hasn&#39;t been a file uploaded:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # For Rails 3.1+ asset pipeline compatibility:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # ActionController::Base.helpers.asset_path(&quot;fallback/&quot; + [version_name, &quot;default.png&quot;].compact.join(&#39;_&#39;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="24">
          <span class="hits">36</span>
          
          <code class="ruby">    &quot;/assets/adminre_theme_v120/image/avatar/avatar.png&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # Process files as they are uploaded:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # process :scale =&gt; [300, 300]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # def scale(width, height)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  #   # do something</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # Create different versions of your uploaded files:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  version :thumb do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    process :resize_to_fit =&gt; [50, 50]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  version :medium do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    process :resize_to_fill =&gt; [130, 130]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # Add a white list of extensions which are allowed to be uploaded.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  # For images you might use something like this:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def extension_white_list</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    %w(jpg jpeg gif png)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # Override the filename of the uploaded files:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  # Avoid using model.id or version_name here, see uploader/store.rb for details.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  # def filename</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  #   &quot;something.jpg&quot; if original_filename</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="bd6b24b14770a775ccf8ac4dac0e661ecd593d7c">
  <div class="header">
    <h3>app/validators/email_validator.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class EmailValidator &lt; ActiveModel::EachValidator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_each(record, attribute, value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    record.errors.add attribute, (options[:message] || &#39;is not an email&#39;) unless</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      value =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="40217dca5f1e66b488427de2a260d00f439a57ea">
  <div class="header">
    <h3>app/workers/fax_worker.rb</h3>
    <h4><span class="yellow">87.5 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class FaxWorker</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Sidekiq::Worker</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include ApplicationHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include PusherHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  sidekiq_options queue: &quot;high&quot;, retry: 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform(number, po_id, current_user_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    po = PurchaseOrder.unscoped.find po_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    Property.current_id = po.property.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    ac = ActionController::Base.new()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    string_data = ac.render_to_string(layout: &#39;layouts/pdf.html.haml&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">                                      template: &#39;purchase_orders/pdf.html.slim&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">                                      formats: :html,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">                                      locals: {:@purchase_order =&gt; po})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    response = Phaxio.send_fax to: number, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">                    filename: &#39;purchase_order.pdf&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">                    string_data: string_data, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">                    string_data_type: :html, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">                    callback_url: &quot;http://#{Settings.external_host}/phaxio&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    if response[&#39;success&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      po.update_attributes fax_id: response[&#39;faxId&#39;], fax_last_message: response[&#39;message&#39;], last_user_id: current_user_id, fax_last_status: PurchaseOrder::FAX_SENDING</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      send_fax_event PurchaseOrder::FAX_SENDING, {message: response[&#39;message&#39;], po_number: po.number, to: current_user_id}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      po.update_attributes fax_id: response[&#39;faxId&#39;], fax_last_message: response[&#39;message&#39;], last_user_id: current_user_id, fax_last_status: PurchaseOrder::FAX_FAILED</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      send_fax_event PurchaseOrder::FAX_FAILED, {message: response[&#39;message&#39;], po_number: po.number, to: current_user_id}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e2b49d0da10da7703143a2d57edcacccb823b584">
  <div class="header">
    <h3>lib/devise_pdf_failure.rb</h3>
    <h4><span class="red">44.44 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class DevisePdfFailure &lt; Devise::FailureApp</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def respond</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    if request.format == :pdf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      pdf_redirect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def pdf_redirect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    session[&quot;#{scope}_return_to&quot;] = attempted_path if request.get?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    redirect_to :&quot;new_#{scope}_session&quot;, format: :html, alert: i18n_message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="49f20e47891ffb6440550b933d316da5ff79b59d">
  <div class="header">
    <h3>lib/faker/vendor.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Faker</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class Vendor &lt; Faker::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.name</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="4">
          <span class="hits">98</span>
          
          <code class="ruby">      parse &#39;vendor.name&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="cc3011576206c3eacbfc0fa1b61b9ba578a7c3be">
  <div class="header">
    <h3>lib/settings.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Settings &lt; Settingslogic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  source &quot;#{Rails.root}/config/env_config.yml&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  namespace Rails.env</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  suppress_errors Rails.env.production?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="763851f07029d2b3fc946fd1d73e40637dcd3f78">
  <div class="header">
    <h3>lib/twilio_client.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class TwilioClient</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    @client = Twilio::REST::Client.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_sms(to, body, from = Settings.twilio_from_number)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      @client.messages.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">        from: from,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        to: to,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        body: body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      Airbrake.notify(e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      Rails.logger.error &quot;Failed to send SMS to #{to} - #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="daf229d7628e44766d4f11381c1d14663de4018a">
  <div class="header">
    <h3>vendor/patch/active-record-lax-includes/lib/activerecord_lax_includes.rb</h3>
    <h4><span class="red">63.89 %</span> covered</h4>
    <div>
      <b>36</b> relevant lines. 
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module ActiveRecordLaxIncludes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Preloader</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.included(base)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      base.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">        alias_method :records_by_reflection_default, :records_by_reflection</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">        alias_method :records_by_reflection, :records_by_reflection_with_lax_include</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">        alias_method :preload_hash_default, :preload_hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">        alias_method :preload_hash, :preload_hash_with_lax_include</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    def preload_hash_with_lax_include(association)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      if lax_includes_enabled?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        association.each do |parent, child|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">          ActiveRecord::Associations::Preloader.new(records, parent, preload_scope).run</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">          associated_records = filtered_records_by_reflection(parent).map { |record| record.send(parent) }.flatten</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          ActiveRecord::Associations::Preloader.new(associated_records, child).run</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        preload_hash_default(association)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def records_by_reflection_with_lax_include(association)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="26">
          <span class="hits">22</span>
          
          <code class="ruby">      if lax_includes_enabled?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        filtered_records_by_reflection(association).group_by do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">          record.class.reflections[association]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="31">
          <span class="hits">22</span>
          
          <code class="ruby">        records_by_reflection_default(association)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    def filtered_records_by_reflection(association)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      records.select do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        record.class.reflections[association].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    def lax_includes_enabled?</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="42">
          <span class="hits">22</span>
          
          <code class="ruby">      result = Thread.current[:active_record_lax_includes_enabled]</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="43">
          <span class="hits">22</span>
          
          <code class="ruby">      if result.nil?</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="44">
          <span class="hits">22</span>
          
          <code class="ruby">        result = Rails.configuration.respond_to?(:active_record_lax_includes_enabled) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">                    Rails.configuration.active_record_lax_includes_enabled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="47">
          <span class="hits">22</span>
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  module BaseHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    def lax_includes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      Thread.current[:active_record_lax_includes_enabled] = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      Thread.current[:active_record_lax_includes_enabled] = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;active_record&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">ActiveRecord::Associations::Preloader.send(:include, ActiveRecordLaxIncludes::Preloader)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">ActiveRecord.send(:extend, ActiveRecordLaxIncludes::BaseHelper)</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
